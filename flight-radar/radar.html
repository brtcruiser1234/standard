<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADS-B Radar</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='16' fill='%23000d00'/><circle cx='16' cy='16' r='14' fill='none' stroke='%2300ff41' stroke-width='0.8' opacity='0.6'/><circle cx='16' cy='16' r='9.5' fill='none' stroke='%2300ff41' stroke-width='0.6' opacity='0.4'/><circle cx='16' cy='16' r='5' fill='none' stroke='%2300ff41' stroke-width='0.5' opacity='0.4'/><line x1='16' y1='16' x2='16' y2='2' stroke='%2300ff41' stroke-width='1.2' opacity='0.3'/><line x1='16' y1='16' x2='2' y2='16' stroke='%2300ff41' stroke-width='0.5' opacity='0.2'/><line x1='16' y1='16' x2='26' y2='6' stroke='%2300ff41' stroke-width='1.5' opacity='0.95'/><circle cx='16' cy='16' r='1.2' fill='%2300ff41'/><circle cx='22' cy='9' r='1.5' fill='%2300ff41' opacity='0.9'/><circle cx='10' cy='20' r='1' fill='%2300ff41' opacity='0.5'/></svg>">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #000;
    color: #00ff41;
    font-family: 'Courier New', Courier, monospace;
    overflow: hidden;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  #header {
    position: fixed;
    top: 0; left: 0; right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 16px;
    background: rgba(0,0,0,0.88);
    border-bottom: 1px solid #003a10;
    z-index: 10;
    font-size: 13px;
    letter-spacing: 1px;
    flex-wrap: wrap;
    gap: 4px;
  }

  #header .title {
    font-size: 16px;
    font-weight: bold;
    text-transform: uppercase;
    text-shadow: 0 0 8px #00ff41;
    letter-spacing: 3px;
    flex-shrink: 0;
  }

  #header .stats {
    display: flex;
    gap: 20px;
  }

  #header .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  #header .stat-label {
    font-size: 9px;
    color: #006620;
    letter-spacing: 1px;
  }

  #header .stat-value {
    font-size: 14px;
    text-shadow: 0 0 6px #00ff41;
  }

  /* Session best stats — right side of header */
  #session-stats {
    display: flex;
    gap: 18px;
    font-size: 9px;
    color: #005518;
    letter-spacing: 1px;
    align-items: center;
    flex-shrink: 0;
  }
  #session-stats .ss-val {
    color: #00bb44;
    font-size: 10px;
  }

  #radar {
    border-radius: 50%;
    cursor: crosshair;
    filter: drop-shadow(0 0 20px rgba(0, 255, 65, 0.15));
  }

  #tooltip {
    position: fixed;
    background: rgba(0, 10, 0, 0.93);
    border: 1px solid #00ff41;
    padding: 8px 12px;
    font-size: 11px;
    line-height: 1.7;
    pointer-events: none;
    display: none;
    z-index: 20;
    letter-spacing: 0.5px;
    box-shadow: 0 0 10px rgba(0,255,65,0.3);
    min-width: 165px;
  }

  #tooltip .tt-callsign {
    font-size: 14px;
    font-weight: bold;
    text-shadow: 0 0 6px #00ff41;
    margin-bottom: 4px;
  }

  #tooltip .tt-label {
    color: #006620;
    font-size: 9px;
    letter-spacing: 1px;
  }

  #footer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 18px;
    padding: 5px 16px;
    background: rgba(0,0,0,0.88);
    border-top: 1px solid #003a10;
    font-size: 10px;
    color: #006620;
    letter-spacing: 1px;
    z-index: 10;
    flex-wrap: wrap;
  }

  #status-dot {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #00ff41;
    box-shadow: 0 0 6px #00ff41;
    animation: pulse 1.5s infinite;
    vertical-align: middle;
    margin-right: 5px;
  }
  #status-dot.error {
    background: #ff3300;
    box-shadow: 0 0 6px #ff3300;
    animation: none;
  }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* CRT scanlines */
  #scanlines {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
      to bottom,
      transparent 0px, transparent 3px,
      rgba(0,0,0,0.18) 3px, rgba(0,0,0,0.18) 4px
    );
    pointer-events: none;
    z-index: 5;
  }

  /* Tracked aircraft panel */
  #tracked-panel {
    position: fixed;
    top: 50px; right: 16px;
    width: 215px;
    background: rgba(0,10,0,0.93);
    border: 1px solid #00ff41;
    padding: 10px 14px;
    font-size: 11px;
    line-height: 1.8;
    z-index: 20;
    display: none;
    box-shadow: 0 0 16px rgba(0,255,65,0.25);
    letter-spacing: 0.5px;
  }
  #tracked-panel .tp-title { font-size: 13px; font-weight: bold; margin-bottom: 6px; letter-spacing: 2px; }
  #tracked-panel .tp-close { float: right; cursor: pointer; color: #006620; font-size: 14px; line-height: 1; margin-top: -2px; }
  #tracked-panel .tp-close:hover { color: #00ff41; }
  #tracked-panel .tp-label { color: #006620; font-size: 9px; letter-spacing: 1px; }
  #tracked-panel .tp-fa-link { display: block; margin-top: 7px; color: #00bb44; font-size: 9px; letter-spacing: 1px; text-decoration: none; }
  #tracked-panel .tp-fa-link:hover { color: #00ff41; text-decoration: underline; }

  /* Shared button style */
  .ctrl-btn {
    cursor: pointer;
    padding: 1px 6px;
    border: 1px solid #003a10;
    background: transparent;
    color: #006620;
    font-family: 'Courier New', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    transition: color 0.15s, border-color 0.15s;
  }
  .ctrl-btn.active  { color: #00ff41; border-color: #00ff41; }
  .ctrl-btn:hover   { color: #00cc44; border-color: #00cc44; }

  /* Zoom preset buttons */
  .zoom-btn {
    cursor: pointer;
    padding: 1px 5px;
    border: 1px solid #003a10;
    background: transparent;
    color: #006620;
    font-family: 'Courier New', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    transition: color 0.15s, border-color 0.15s;
  }
  .zoom-btn:hover, .zoom-btn.zoom-active { color: #00ff41; border-color: #00ff41; }

  @keyframes emergencyPulse { 0%,100%{opacity:1} 50%{opacity:0.2} }
</style>
</head>
<body>

<div id="header">
  <div class="title">&#9632; ADS-B RADAR</div>

  <div class="stats">
    <div class="stat-item">
      <span class="stat-label">AIRCRAFT</span>
      <span class="stat-value" id="stat-count">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">RANGE</span>
      <span class="stat-value" id="stat-range">--</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">UTC</span>
      <span class="stat-value" id="stat-time">--:--:--</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">LOCAL</span>
      <span class="stat-value" id="stat-local">--:--:--</span>
    </div>
  </div>

  <div id="session-stats">
    <div>MAX ALT: <span class="ss-val" id="stat-max-alt">---</span></div>
    <div>FASTEST: <span class="ss-val" id="stat-fastest">---</span></div>
  </div>
</div>

<canvas id="radar"></canvas>
<div id="scanlines"></div>
<div id="tooltip"></div>

<div id="tracked-panel">
  <span class="tp-close" id="tp-close">✕</span>
  <div class="tp-title" id="tp-callsign">---</div>
  <div id="tp-airline" style="font-size:10px;margin-bottom:4px;"></div>
  <div id="tp-body"></div>
</div>

<div id="footer">
  <span><span id="status-dot"></span><span id="status-text">CONNECTING...</span></span>
  <span>HOVER: INFO &nbsp;|&nbsp; CLICK: TRACK &nbsp;|&nbsp; SCROLL/+−: ZOOM &nbsp;|&nbsp; ESC: UNTRACK</span>
  <span>
    ALT:
    <span style="color:rgb(160,255,30)">&#9632;</span> &lt;5k &nbsp;
    <span style="color:rgb(0,255,65)">&#9632;</span> 5-18k &nbsp;
    <span style="color:rgb(0,230,180)">&#9632;</span> 18-35k &nbsp;
    <span style="color:rgb(180,255,255)">&#9632;</span> 35k+
  </span>
  <span>
    ZOOM:
    <button class="zoom-btn" data-nm="25">25</button>
    <button class="zoom-btn" data-nm="52">52</button>
    <button class="zoom-btn" data-nm="100">100</button>
    <button class="zoom-btn" data-nm="200">200</button>
    NM
  </span>
  <span>
    <button id="filter-btn" class="ctrl-btn">GND FILTER: OFF</button>
    &nbsp;
    <button id="ping-btn" class="ctrl-btn active">PING: ON</button>
  </span>
</div>

<script>
// ============================================================
// CONFIGURATION
// ============================================================
const AIRPORTS = [
  { icao: 'KSLC', iata: 'SLC', name: 'Salt Lake City Intl',  lat: 40.7884, lon: -111.9778, major: true  },
  { icao: 'KPVU', iata: 'PVU', name: 'Provo Municipal',      lat: 40.2192, lon: -111.7229, major: false },
  { icao: 'KOGD', iata: 'OGD', name: 'Ogden-Hinckley',       lat: 41.1959, lon: -112.0122, major: false },
  { icao: 'KCDC', iata: 'CDC', name: 'Cedar City Regional',  lat: 37.7010, lon: -113.0986, major: false },
  { icao: 'KVEL', iata: 'VEL', name: 'Vernal Regional',      lat: 40.4409, lon: -109.5100, major: false },
  { icao: 'KPUC', iata: 'PUC', name: 'Carbon County/Price',  lat: 39.6139, lon: -110.7506, major: false },
  { icao: 'KCNY', iata: 'CNY', name: 'Canyonlands Field',    lat: 38.7553, lon: -109.7549, major: false },
  { icao: 'KU42', iata: 'U42', name: 'Nephi Municipal',      lat: 39.7108, lon: -111.8783, major: false },
  { icao: 'KU77', iata: 'U77', name: 'Spanish Fork Airport', lat: 40.1530, lon: -111.6455, major: false },
  { icao: 'KENV', iata: 'ENV', name: 'Wendover Airport',     lat: 40.7187, lon: -114.0308, major: false },
  { icao: 'KPGA', iata: 'PGA', name: 'Page Municipal',       lat: 36.9261, lon: -111.4483, major: false },
  { icao: 'KPSP', iata: 'SGU', name: 'St George Regional',   lat: 37.0363, lon: -113.5100, major: false },
];

const AIRLINES = {
  'AAL': 'American Airlines',   'ASA': 'Alaska Airlines',
  'DAL': 'Delta Air Lines',     'UAL': 'United Airlines',
  'SWA': 'Southwest Airlines',  'SKW': 'SkyWest Airlines',
  'WJA': 'WestJet',             'QTR': 'Qatar Airways',
  'BAW': 'British Airways',     'AFR': 'Air France',
  'DLH': 'Lufthansa',           'UAE': 'Emirates',
  'ETD': 'Etihad Airways',      'KLM': 'KLM',
  'IBE': 'Iberia',              'VIR': 'Virgin Atlantic',
  'ANA': 'All Nippon Airways',  'JAL': 'Japan Airlines',
  'CCA': 'Air China',           'CSN': 'China Southern',
  'CES': 'China Eastern',       'KAL': 'Korean Air',
  'AAR': 'Asiana Airlines',     'THY': 'Turkish Airlines',
  'SIA': 'Singapore Airlines',  'THA': 'Thai Airways',
  'TAP': 'TAP Portugal',        'EIN': 'Aer Lingus',
  'FDX': 'FedEx',               'UPS': 'UPS Airlines',
  'GTI': 'Atlas Air',           'ABX': 'ABX Air',
  'ATN': 'Air Transport Intl',  'KHM': 'Kalitta Air',
  'FFT': 'Frontier Airlines',   'NKS': 'Spirit Airlines',
  'JBU': 'JetBlue',             'HAL': 'Hawaiian Airlines',
  'SXD': 'Sun Country',         'RPA': 'Republic Airlines',
  'ENY': 'Envoy Air',           'GJS': 'GoJet Airlines',
  'EDV': 'Endeavor Air',        'PDT': 'Piedmont Airlines',
  'PSA': 'PSA Airlines',        'EJA': 'NetJets',
  'CPZ': 'Compass Airlines',    'SVA': 'Saudia',
  'MSR': 'EgyptAir',            'ELY': 'El Al',
  'CAL': 'China Airlines',      'EVA': 'EVA Air',
  'MAS': 'Malaysia Airlines',
};

// Altitude -> RGB color
function altRgb(alt) {
  if (alt == null || alt < 0) return [0,   255,  65];
  if (alt < 5000)             return [160, 255,  30];
  if (alt < 18000)            return [0,   255,  65];
  if (alt < 35000)            return [0,   230, 180];
  return                             [180, 255, 255];
}

const SQUAWK_EMERGENCY = {
  '7700': { label: 'EMERGENCY',     color: [255, 40,  40]  },
  '7600': { label: 'RADIO FAILURE', color: [255, 160, 0]   },
  '7500': { label: 'HIJACK',        color: [255, 0,   200] },
};

const CONFIG = {
  lat: 40.0577,
  lon: -111.6724,
  dataUrl: '/data/aircraft.json',
  rangeNm: 52,
  fetchInterval: 2000,
  sweepPeriod: 6,
  sweepWidth: 35,
  blipFadeSeconds: 7,
  showBeyondRange: false,
  minAlt: 0,
};
// ============================================================

const canvas = document.getElementById('radar');
const ctx    = canvas.getContext('2d');
const tooltip = document.getElementById('tooltip');

const EARTH_NM = 3440.065;
const DEG      = Math.PI / 180;

let aircraft      = [];
let blipState     = {};  // hex -> { time, bloomTime }
let trailHistory  = {};  // hex -> [{x,y}] NM offsets
const TRAIL_MAX   = 30;
let sweepAngle    = -Math.PI / 2;
let lastSweepAngle = -Math.PI / 2;
let hoverAircraft = null;
let trackedHex    = null;
let filterGround  = false;
let pingEnabled   = true;
let mouseX = 0, mouseY = 0;
let lastFetch = 0;

// Session best stats (persist until page reload)
let sessionMaxAlt  = { alt: 0,   label: '---' };
let sessionFastest = { speed: 0, label: '---' };

// Track which hexes have already triggered the emergency alarm
const emergencyAlerted = new Set();

// ── Audio ──────────────────────────────────────────────────
let audioCtx = null;
function initAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playPing() {
  if (!pingEnabled) return;
  try {
    initAudio();
    const osc  = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(900, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.4);
    gain.gain.setValueAtTime(0.18, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + 0.5);
  } catch(e) {}
}

// Harsh three-burst alarm for emergency squawk
function playEmergencyAlarm() {
  try {
    initAudio();
    for (let i = 0; i < 3; i++) {
      const osc  = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'square';
      const t = audioCtx.currentTime + i * 0.28;
      osc.frequency.setValueAtTime(880, t);
      osc.frequency.setValueAtTime(440, t + 0.12);
      gain.gain.setValueAtTime(0.13, t);
      gain.gain.setValueAtTime(0.0,  t + 0.25);
      osc.start(t);
      osc.stop(t + 0.25);
    }
  } catch(e) {}
}

// ── Canvas sizing ──────────────────────────────────────────
function resize() {
  const headerH = document.getElementById('header').offsetHeight;
  const footerH = document.getElementById('footer').offsetHeight;
  const size = Math.floor(Math.min(
    window.innerWidth,
    window.innerHeight - headerH - footerH
  ) - 20);
  canvas.width = size;
  canvas.height = size;
}
resize();
window.addEventListener('resize', resize);

// Scroll to zoom
window.addEventListener('wheel', (e) => {
  e.preventDefault();
  CONFIG.rangeNm = Math.max(20, Math.min(400, CONFIG.rangeNm * (e.deltaY > 0 ? 1.1 : 0.9)));
}, { passive: false });

// ── Coordinate helpers ─────────────────────────────────────
function latLonToNm(lat, lon) {
  const dLat = (lat - CONFIG.lat) * DEG;
  const dLon = (lon - CONFIG.lon) * DEG;
  return {
    x:  EARTH_NM * dLon * Math.cos(CONFIG.lat * DEG),
    y: -EARTH_NM * dLat,
  };
}

function nmToCanvas(x, y) {
  const cx = canvas.width / 2, cy = canvas.height / 2;
  const scale = (canvas.width / 2) / CONFIG.rangeNm;
  return { px: cx + x * scale, py: cy + y * scale };
}

function distNm(lat, lon) {
  const { x, y } = latLonToNm(lat, lon);
  return Math.sqrt(x * x + y * y);
}

function bearingRad(lat, lon) {
  const { x, y } = latLonToNm(lat, lon);
  return Math.atan2(x, -y);
}

// ── Data fetch ─────────────────────────────────────────────
async function fetchAircraft() {
  try {
    const res = await fetch(CONFIG.dataUrl, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    aircraft = (data.aircraft || []).filter(a => {
      if (a.lat == null || a.lon == null) return false;
      if ((a.alt_baro || 0) < CONFIG.minAlt) return false;
      if (filterGround && (a.alt_baro == null || a.alt_baro <= 50)) return false;
      return true;
    });

    const seen = new Set();
    aircraft.forEach(a => {
      seen.add(a.hex);

      // Trail history
      const pt = latLonToNm(a.lat, a.lon);
      if (!trailHistory[a.hex]) trailHistory[a.hex] = [];
      const trail = trailHistory[a.hex];
      const last  = trail[trail.length - 1];
      if (!last || Math.hypot(pt.x - last.x, pt.y - last.y) > 0.05) {
        trail.push(pt);
        if (trail.length > TRAIL_MAX) trail.shift();
      }

      // Session best stats
      const alt = a.alt_baro ?? a.alt_geom ?? 0;
      if (alt > sessionMaxAlt.alt) {
        const tag = (a.flight ? a.flight.trim() : a.hex.toUpperCase());
        sessionMaxAlt = { alt, label: tag + ' @ ' + alt.toLocaleString() + 'ft' };
      }
      const spd = a.gs ?? 0;
      if (spd > sessionFastest.speed) {
        const tag = (a.flight ? a.flight.trim() : a.hex.toUpperCase());
        sessionFastest = { speed: Math.round(spd), label: tag + ' @ ' + Math.round(spd) + 'kt' };
      }

      // Emergency squawk alarm (fires once per hex until they leave range)
      if (SQUAWK_EMERGENCY[a.squawk] && !emergencyAlerted.has(a.hex)) {
        emergencyAlerted.add(a.hex);
        playEmergencyAlarm();
      }
    });

    // Prune trails for aircraft no longer visible
    Object.keys(trailHistory).forEach(hex => {
      if (!seen.has(hex)) delete trailHistory[hex];
    });
    // Clear emergency flag so we re-alarm if they return
    [...emergencyAlerted].forEach(hex => {
      if (!seen.has(hex)) emergencyAlerted.delete(hex);
    });

    document.getElementById('status-dot').className    = '';
    document.getElementById('status-text').textContent = 'LIVE';
    document.getElementById('stat-count').textContent  = aircraft.length;
    document.getElementById('stat-max-alt').textContent  = sessionMaxAlt.label;
    document.getElementById('stat-fastest').textContent  = sessionFastest.label;
  } catch (e) {
    document.getElementById('status-dot').className    = 'error';
    document.getElementById('status-text').textContent = 'NO SIGNAL: ' + e.message;
  }
}

// ── Drawing helpers ────────────────────────────────────────
function drawRing(cx, cy, radiusPx, label) {
  ctx.beginPath();
  ctx.arc(cx, cy, radiusPx, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(0, 80, 20, 0.5)';
  ctx.lineWidth   = 0.5;
  ctx.stroke();
  if (label) {
    ctx.fillStyle = 'rgba(0, 100, 30, 0.8)';
    ctx.font      = `${Math.max(9, canvas.width * 0.013)}px 'Courier New'`;
    ctx.textAlign = 'center';
    ctx.fillText(label, cx, cy - radiusPx + 12);
  }
}

// Azimuth tick marks + degree labels every 30° (skips cardinal labels at 0/90/180/270)
function drawAzimuthLines(cx, cy, radius) {
  const fontSize = Math.max(8, canvas.width * 0.011);

  // Minor ticks every 10°
  for (let deg = 0; deg < 360; deg += 10) {
    if (deg % 30 === 0) continue;
    const rad = (deg - 90) * DEG;
    ctx.save();
    ctx.strokeStyle = 'rgba(0, 65, 18, 0.45)';
    ctx.lineWidth   = 0.5;
    ctx.beginPath();
    ctx.moveTo(cx + (radius - 6)  * Math.cos(rad), cy + (radius - 6)  * Math.sin(rad));
    ctx.lineTo(cx +  radius       * Math.cos(rad), cy +  radius       * Math.sin(rad));
    ctx.stroke();
    ctx.restore();
  }

  // Major ticks + labels every 30°
  for (let deg = 0; deg < 360; deg += 30) {
    const rad = (deg - 90) * DEG;
    ctx.save();
    ctx.strokeStyle = 'rgba(0, 130, 45, 0.7)';
    ctx.lineWidth   = 1;
    ctx.beginPath();
    ctx.moveTo(cx + (radius - 14) * Math.cos(rad), cy + (radius - 14) * Math.sin(rad));
    ctx.lineTo(cx +  radius       * Math.cos(rad), cy +  radius       * Math.sin(rad));
    ctx.stroke();

    // Skip degree labels at cardinal directions (N/S/E/W already drawn)
    if (deg % 90 !== 0) {
      const lx = cx + (radius - 26) * Math.cos(rad);
      const ly = cy + (radius - 26) * Math.sin(rad);
      ctx.font         = `${fontSize}px 'Courier New'`;
      ctx.fillStyle    = 'rgba(0, 155, 55, 0.75)';
      ctx.textAlign    = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(deg.toString().padStart(3, '0'), lx, ly);
      ctx.textBaseline = 'alphabetic';
    }
    ctx.restore();
  }
}

function drawBackground(cx, cy, radius) {
  // Dark green fill
  ctx.beginPath();
  ctx.arc(cx, cy, radius, 0, Math.PI * 2);
  ctx.fillStyle = '#000d00';
  ctx.fill();

  // Subtle radial gradient
  const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius);
  grad.addColorStop(0, 'rgba(0,40,5,0.4)');
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = grad;
  ctx.fill();

  // Range rings
  const ringIntervals =
    CONFIG.rangeNm <= 60  ? [10, 20, 30, 40, 50, 60] :
    CONFIG.rangeNm <= 120 ? [25, 50, 75, 100] :
    CONFIG.rangeNm <= 200 ? [50, 100, 150, 200] :
                            [50, 100, 150, 200, 250, 300, 350, 400];
  const scale = radius / CONFIG.rangeNm;
  ringIntervals.forEach(nm => { if (nm <= CONFIG.rangeNm) drawRing(cx, cy, nm * scale, nm + 'NM'); });

  // Cross hairs
  ctx.strokeStyle = 'rgba(0, 80, 20, 0.35)';
  ctx.lineWidth   = 0.5;
  ctx.setLineDash([4, 8]);
  ctx.beginPath(); ctx.moveTo(cx, cy - radius); ctx.lineTo(cx, cy + radius); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx - radius, cy); ctx.lineTo(cx + radius, cy); ctx.stroke();
  ctx.setLineDash([]);

  // Cardinal labels
  const labelSize = Math.max(11, canvas.width * 0.016);
  ctx.font      = `bold ${labelSize}px 'Courier New'`;
  ctx.textAlign = 'center';
  ctx.fillStyle = 'rgba(0, 180, 50, 0.7)';
  const pad = labelSize + 4;
  ctx.fillText('N', cx,          cy - radius + pad);
  ctx.fillText('S', cx,          cy + radius - 4);
  ctx.fillText('E', cx + radius - 4, cy + labelSize / 3);
  ctx.fillText('W', cx - radius + 4, cy + labelSize / 3);

  // Outer border ring
  ctx.beginPath();
  ctx.arc(cx, cy, radius, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(0, 150, 40, 0.6)';
  ctx.lineWidth   = 1.5;
  ctx.stroke();

  // Azimuth marks on the border
  drawAzimuthLines(cx, cy, radius);

  // Center dot
  ctx.beginPath();
  ctx.arc(cx, cy, 3, 0, Math.PI * 2);
  ctx.fillStyle = '#00ff41';
  ctx.fill();
}

function drawAirports(cx, cy) {
  const fontSize = Math.max(9, canvas.width * 0.013);
  AIRPORTS.forEach(ap => {
    const { x, y } = latLonToNm(ap.lat, ap.lon);
    if (Math.sqrt(x * x + y * y) > CONFIG.rangeNm * 1.02) return;
    const { px, py } = nmToCanvas(x, y);
    const isMajor = ap.major;
    const r    = isMajor ? 9 : 7;
    const arm  = r + (isMajor ? 5 : 4);
    const color = isMajor ? 'rgba(0, 220, 90, 0.85)' : 'rgba(0, 180, 70, 0.80)';
    ctx.save();
    ctx.shadowColor = color;
    ctx.shadowBlur  = isMajor ? 8 : 5;
    ctx.beginPath(); ctx.arc(px, py, r, 0, Math.PI * 2);
    ctx.strokeStyle = color;
    ctx.lineWidth   = isMajor ? 1.8 : 1.3;
    ctx.stroke();
    ctx.lineWidth = isMajor ? 1.4 : 1.1;
    ctx.beginPath(); ctx.moveTo(px - arm, py); ctx.lineTo(px + arm, py); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(px, py - arm); ctx.lineTo(px, py + arm); ctx.stroke();
    ctx.shadowBlur  = 0;
    ctx.font        = `${isMajor ? 'bold ' : ''}${fontSize}px 'Courier New'`;
    ctx.fillStyle   = color;
    ctx.textAlign   = 'left';
    ctx.fillText(ap.iata, px + arm + 4, py + fontSize * 0.38);
    ctx.restore();
  });
}

function drawSweep(cx, cy, radius, angle) {
  ctx.save();
  ctx.beginPath();
  ctx.arc(cx, cy, radius, angle - CONFIG.sweepWidth * DEG, angle, false);
  ctx.lineTo(cx, cy);
  ctx.closePath();
  const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius);
  g.addColorStop(0,   'rgba(0, 255, 65, 0.05)');
  g.addColorStop(0.6, 'rgba(0, 255, 65, 0.12)');
  g.addColorStop(1,   'rgba(0, 255, 65, 0.06)');
  ctx.fillStyle = g;
  ctx.fill();
  ctx.restore();

  ctx.save();
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx + radius * Math.cos(angle), cy + radius * Math.sin(angle));
  ctx.strokeStyle = 'rgba(0, 255, 65, 0.9)';
  ctx.lineWidth   = 1.5;
  ctx.shadowColor = '#00ff41';
  ctx.shadowBlur  = 8;
  ctx.stroke();
  ctx.restore();
}

function drawTrail(trail, blipBrightness, rgb) {
  if (trail.length < 2) return;
  const [r, g, b] = rgb;
  ctx.save();
  for (let i = 1; i < trail.length; i++) {
    const { px: x1, py: y1 } = nmToCanvas(trail[i - 1].x, trail[i - 1].y);
    const { px: x2, py: y2 } = nmToCanvas(trail[i].x, trail[i].y);
    const ageFraction = i / trail.length;
    ctx.beginPath();
    ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
    ctx.strokeStyle = `rgba(${r},${g},${b},${ageFraction * ageFraction * blipBrightness * 0.6})`;
    ctx.lineWidth   = Math.max(0.5, ageFraction * 1.5);
    ctx.stroke();
  }
  ctx.restore();
}

function drawHeadingVector(px, py, track, speed, brightness, rgb) {
  if (track == null || speed == null || speed < 10) return;
  const [r, g, b] = rgb;
  const vectorNm = speed * (3 / 60);
  const scale    = (canvas.width / 2) / CONFIG.rangeNm;
  const lengthPx = Math.max(12, vectorNm * scale);
  const angle    = (track - 90) * DEG;
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(px, py);
  ctx.lineTo(px + Math.cos(angle) * lengthPx, py + Math.sin(angle) * lengthPx);
  ctx.strokeStyle = `rgba(${r},${g},${b},${brightness * 0.75})`;
  ctx.lineWidth   = 1.2;
  ctx.setLineDash([3, 3]);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.restore();
}

// Draw rotated aircraft silhouette based on ADS-B category
function drawAircraftShape(px, py, track, category, rgb, brightness) {
  if (track == null) return;
  const [r, g, b] = rgb;
  const alpha = Math.max(0.45, brightness);
  const rot   = (track - 90) * DEG;
  const cat   = (category || '').toUpperCase();

  ctx.save();
  ctx.translate(px, py);
  ctx.rotate(rot);
  ctx.strokeStyle = `rgba(${r},${g},${b},${alpha})`;
  ctx.lineWidth   = 1.1;
  ctx.shadowColor = `rgb(${r},${g},${b})`;
  ctx.shadowBlur  = 3;

  if (cat === 'B1') {
    // Helicopter: circle + cross
    const s = 4.5;
    ctx.beginPath(); ctx.arc(0, 0, s, 0, Math.PI * 2); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(-s * 1.4, 0); ctx.lineTo(s * 1.4, 0);
    ctx.moveTo(0, -s * 1.4); ctx.lineTo(0, s * 1.4);
    ctx.stroke();
  } else if (cat === 'A1' || cat === 'A2') {
    // Light GA: diamond
    const s = 5;
    ctx.beginPath();
    ctx.moveTo(0, -s); ctx.lineTo(s * 0.65, 0);
    ctx.lineTo(0, s);  ctx.lineTo(-s * 0.65, 0);
    ctx.closePath();
    ctx.fillStyle = `rgba(${r},${g},${b},${alpha * 0.25})`;
    ctx.fill();
    ctx.stroke();
  } else {
    // Commercial / heavy: top-down plane silhouette
    const s = 6;
    ctx.beginPath(); ctx.moveTo(0, -s); ctx.lineTo(0, s * 0.95); ctx.stroke();     // fuselage
    ctx.beginPath(); ctx.moveTo(-s * 1.2, -s * 0.05); ctx.lineTo(s * 1.2, -s * 0.05); ctx.stroke(); // wings
    ctx.beginPath(); ctx.moveTo(-s * 0.5, s * 0.72);  ctx.lineTo(s * 0.5, s * 0.72);  ctx.stroke(); // tail
  }
  ctx.restore();
}

// Draw ↑/↓ vertical-rate arrow to the right of blip
function drawVertRateArrow(px, py, baro_rate, brightness) {
  if (baro_rate == null || Math.abs(baro_rate) < 200) return;
  const up  = baro_rate > 0;
  const col = up ? `rgba(0,255,130,${brightness * 0.9})` : `rgba(255,140,0,${brightness * 0.9})`;
  const sz  = Math.max(7, canvas.width * 0.009);
  const ax  = px + canvas.width * 0.018;

  ctx.save();
  ctx.strokeStyle = col;
  ctx.fillStyle   = col;
  ctx.lineWidth   = 1.3;
  ctx.shadowColor = col;
  ctx.shadowBlur  = 4;

  // Shaft
  ctx.beginPath();
  ctx.moveTo(ax, py + (up ? sz * 0.5 : -sz * 0.5));
  ctx.lineTo(ax, py + (up ? -sz * 0.5 : sz * 0.5));
  ctx.stroke();

  // Arrowhead
  ctx.beginPath();
  if (up) {
    ctx.moveTo(ax,              py - sz * 0.5);
    ctx.lineTo(ax - sz * 0.35, py - sz * 0.1);
    ctx.lineTo(ax + sz * 0.35, py - sz * 0.1);
  } else {
    ctx.moveTo(ax,              py + sz * 0.5);
    ctx.lineTo(ax - sz * 0.35, py + sz * 0.1);
    ctx.lineTo(ax + sz * 0.35, py + sz * 0.1);
  }
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

function drawBlip(px, py, brightness, isHovered, rgb, emergency, bloomTime) {
  const size  = canvas.width * 0.007;
  const alpha = Math.max(0.05, brightness);
  const [r, g, b] = rgb;
  const bloomAge   = bloomTime ? (Date.now() - bloomTime) / 1000 : 99;
  const bloomAlpha = bloomAge < 0.15 ? Math.max(0, 1 - bloomAge / 0.15) : 0;

  ctx.save();

  if (emergency) {
    const pulse = 0.5 + 0.5 * Math.sin(Date.now() / 180);
    const [er, eg, eb] = emergency.color;
    ctx.beginPath(); ctx.arc(px, py, size * 3.5, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(${er},${eg},${eb},${pulse * 0.9})`;
    ctx.lineWidth   = 2;
    ctx.shadowColor = `rgb(${er},${eg},${eb})`;
    ctx.shadowBlur  = 16 * pulse;
    ctx.stroke();
    ctx.shadowBlur  = 0;
  }

  if (isHovered) {
    ctx.beginPath(); ctx.arc(px, py, size * 2.5, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(${r},${g},${b},0.5)`;
    ctx.lineWidth   = 1;
    ctx.stroke();
  }

  ctx.shadowColor = `rgb(${r},${g},${b})`;
  ctx.shadowBlur  = 10 * alpha;
  ctx.beginPath(); ctx.arc(px, py, size, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
  ctx.fill();

  ctx.shadowBlur  = 0;
  ctx.beginPath(); ctx.arc(px, py, size * 0.4, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(220,255,230,${Math.min(1, alpha * 1.5)})`;
  ctx.fill();

  if (bloomAlpha > 0) {
    ctx.shadowColor = '#ffffff';
    ctx.shadowBlur  = 20 * bloomAlpha;
    ctx.beginPath(); ctx.arc(px, py, size * 2.5 * bloomAlpha, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255,255,255,${bloomAlpha * 0.9})`;
    ctx.fill();
    ctx.shadowBlur  = 0;
  }
  ctx.restore();
}

// Format vertical rate for HTML insertion
function fmtVrate(baro_rate) {
  if (baro_rate == null) return null;
  const abs = Math.abs(baro_rate);
  if (abs < 200) return '<span style="color:#005518">── LVL</span>';
  const up  = baro_rate > 0;
  const col = up ? '#00ff80' : '#ff9933';
  return `<span style="color:${col}">${up ? '↑' : '↓'} ${abs.toLocaleString()} fpm</span>`;
}

// ── Main render loop ───────────────────────────────────────
let lastTime = 0;
function render(ts) {
  const dt = Math.min((ts - lastTime) / 1000, 0.1);
  lastTime = ts;

  lastSweepAngle = sweepAngle;
  sweepAngle    += (2 * Math.PI / CONFIG.sweepPeriod) * dt;
  const NORTH    = -Math.PI / 2;
  if (lastSweepAngle < NORTH && sweepAngle >= NORTH) playPing();
  if (sweepAngle > Math.PI) sweepAngle -= 2 * Math.PI;

  if (ts - lastFetch > CONFIG.fetchInterval) { lastFetch = ts; fetchAircraft(); }

  // Time displays
  const now = new Date();
  document.getElementById('stat-time').textContent =
    now.getUTCHours().toString().padStart(2, '0') + ':' +
    now.getUTCMinutes().toString().padStart(2, '0') + ':' +
    now.getUTCSeconds().toString().padStart(2, '0');
  document.getElementById('stat-local').textContent =
    now.toLocaleTimeString('en-US', { timeZone: 'America/Denver', hour12: false });
  document.getElementById('stat-range').textContent = Math.round(CONFIG.rangeNm) + 'NM';

  const cx = canvas.width / 2, cy = canvas.height / 2, radius = canvas.width / 2;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.beginPath();
  ctx.arc(cx, cy, radius - 1, 0, Math.PI * 2);
  ctx.clip();

  drawBackground(cx, cy, radius - 1);
  drawAirports(cx, cy);

  // Detect which aircraft the sweep is currently passing over
  aircraft.forEach(a => {
    const bearing = bearingRad(a.lat, a.lon);
    const angDiff = ((sweepAngle - bearing + 3 * Math.PI) % (2 * Math.PI)) - Math.PI;
    if (angDiff >= 0 && angDiff < CONFIG.sweepWidth * DEG) {
      const t    = Date.now();
      const prev = blipState[a.hex];
      const bloom = (!prev || t - prev.time > 500);
      blipState[a.hex] = { time: t, bloomTime: bloom ? t : (prev?.bloomTime || 0) };
    }
  });

  drawSweep(cx, cy, radius - 1, sweepAngle);

  hoverAircraft = null;
  aircraft.forEach(a => {
    const nm = distNm(a.lat, a.lon);
    if (!CONFIG.showBeyondRange && nm > CONFIG.rangeNm) return;

    const { x, y }   = latLonToNm(a.lat, a.lon);
    const { px, py }  = nmToCanvas(x, y);

    const state = blipState[a.hex];
    let brightness = 0.08;
    if (state) {
      brightness = Math.max(0.08, 1 - ((Date.now() - state.time) / 1000) / CONFIG.blipFadeSeconds);
    }

    const rgb       = altRgb(a.alt_baro ?? a.alt_geom);
    const emergency = SQUAWK_EMERGENCY[a.squawk] || null;

    const dx = mouseX - px, dy = mouseY - py;
    const hitRadius = Math.max(14, canvas.width * 0.025);
    const isHovered = Math.sqrt(dx * dx + dy * dy) < hitRadius;
    if (isHovered) hoverAircraft = { a, px, py, rgb, emergency };

    if (trailHistory[a.hex]) drawTrail(trailHistory[a.hex], brightness, rgb);
    drawHeadingVector(px, py, a.track, a.gs, brightness, rgb);

    const bloomTime = blipState[a.hex]?.bloomTime || 0;
    const isTracked = a.hex === trackedHex;
    drawBlip(px, py, brightness, isHovered || isTracked, rgb, emergency, bloomTime);

    // Aircraft shape silhouette on top of glow
    drawAircraftShape(px, py, a.track, a.category, rgb, brightness);

    // Vertical rate arrows
    drawVertRateArrow(px, py, a.baro_rate, brightness);

    // Tracked dashed ring
    if (isTracked) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(px, py, canvas.width * 0.02, 0, Math.PI * 2);
      ctx.strokeStyle = 'rgba(0,255,65,0.5)';
      ctx.lineWidth   = 1;
      ctx.setLineDash([4, 4]);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();
    }

    // Callsign label for bright blips
    if (brightness > 0.5 && a.flight) {
      const [r, g, b] = rgb;
      ctx.save();
      ctx.font        = `${Math.max(9, canvas.width * 0.012)}px 'Courier New'`;
      ctx.fillStyle   = `rgba(${r},${g},${b},${brightness * 0.8})`;
      ctx.shadowColor = `rgb(${r},${g},${b})`;
      ctx.shadowBlur  = 3;
      ctx.textAlign   = 'left';
      ctx.fillText(a.flight.trim(), px + 8, py - 4);
      ctx.restore();
    }

    // Emergency label
    if (emergency) {
      const [er, eg, eb] = emergency.color;
      const pulse = 0.6 + 0.4 * Math.sin(Date.now() / 200);
      ctx.save();
      ctx.font        = `bold ${Math.max(9, canvas.width * 0.012)}px 'Courier New'`;
      ctx.fillStyle   = `rgba(${er},${eg},${eb},${pulse})`;
      ctx.shadowColor = `rgb(${er},${eg},${eb})`;
      ctx.shadowBlur  = 6;
      ctx.textAlign   = 'left';
      ctx.fillText(`⚠ ${emergency.label}`, px + 10, py + 14);
      ctx.restore();
    }
  });

  ctx.restore(); // end clip

  // ── Tracked panel update ───────────────────────────────
  const trackedAircraft = trackedHex ? aircraft.find(a => a.hex === trackedHex) : null;
  const panel = document.getElementById('tracked-panel');
  if (trackedAircraft) {
    const ta        = trackedAircraft;
    const tCallsign = ta.flight ? ta.flight.trim() : ta.hex.toUpperCase();
    const tPrefix   = ta.flight ? ta.flight.trim().replace(/[0-9].*$/, '') : null;
    const tAirline  = tPrefix && AIRLINES[tPrefix] ? AIRLINES[tPrefix] : '';
    const tAlt      = ta.alt_baro != null ? ta.alt_baro.toLocaleString() + ' ft' : '---';
    const tSpd      = ta.gs  != null ? Math.round(ta.gs)  + ' kt' : '---';
    const tHdg      = ta.track != null ? Math.round(ta.track) + '°' : '---';
    const tNm       = distNm(ta.lat, ta.lon).toFixed(1);
    const tBrg      = ((bearingRad(ta.lat, ta.lon) / DEG + 360) % 360).toFixed(0);
    const tTyp      = ta.t || ta.r || '---';
    const tVrate    = fmtVrate(ta.baro_rate);
    const [tr, tg, tb] = altRgb(ta.alt_baro ?? ta.alt_geom);

    // Only show FlightAware link when we have a real callsign
    const hasCallsign = ta.flight && ta.flight.trim();
    const faLink = hasCallsign
      ? `<a class="tp-fa-link" href="https://flightaware.com/live/flight/${ta.flight.trim()}" target="_blank">&#8599; FLIGHTAWARE</a>`
      : '';

    document.getElementById('tp-callsign').textContent = tCallsign;
    document.getElementById('tp-callsign').style.color = `rgb(${tr},${tg},${tb})`;
    document.getElementById('tp-airline').textContent  = tAirline;
    document.getElementById('tp-body').innerHTML = `
      <div><span class="tp-label">TYPE&nbsp;&nbsp;&nbsp;</span>${tTyp}</div>
      <div><span class="tp-label">ICAO&nbsp;&nbsp;&nbsp;</span>${ta.hex.toUpperCase()}</div>
      <div><span class="tp-label">ALT&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:rgb(${tr},${tg},${tb})">${tAlt}</span></div>
      <div><span class="tp-label">VRATE&nbsp;&nbsp;</span>${tVrate ?? '---'}</div>
      <div><span class="tp-label">SPEED&nbsp;&nbsp;</span>${tSpd}</div>
      <div><span class="tp-label">HDG&nbsp;&nbsp;&nbsp;&nbsp;</span>${tHdg}</div>
      <div><span class="tp-label">DIST&nbsp;&nbsp;&nbsp;</span>${tNm} NM / ${tBrg}°</div>
      <div><span class="tp-label">SQUAWK&nbsp;</span>${ta.squawk || '---'}</div>
      ${faLink}
    `;
    panel.style.display = 'block';
  } else if (trackedHex) {
    trackedHex = null;
    panel.style.display = 'none';
  }

  // ── Tooltip ────────────────────────────────────────────
  if (hoverAircraft) {
    const { a, px, py, rgb, emergency } = hoverAircraft;
    const nm      = distNm(a.lat, a.lon).toFixed(1);
    const bearing = ((bearingRad(a.lat, a.lon) / DEG + 360) % 360).toFixed(0);
    const alt     = a.alt_baro != null ? a.alt_baro.toLocaleString() + ' ft'
                  : (a.alt_geom != null ? a.alt_geom.toLocaleString() + ' ft (geo)' : '---');
    const speed   = a.gs != null ? Math.round(a.gs) + ' kt' : '---';
    const callsign = a.flight ? a.flight.trim() : null;
    const prefix   = callsign ? callsign.replace(/[0-9].*$/, '') : null;
    const airline  = prefix && AIRLINES[prefix] ? AIRLINES[prefix] : null;
    const acType   = a.t || '';
    const vrate    = fmtVrate(a.baro_rate);
    const [r, g, b] = rgb;
    const altColor  = `rgb(${r},${g},${b})`;
    const emergencyBar = emergency
      ? `<div style="background:rgba(${emergency.color[0]},${emergency.color[1]},${emergency.color[2]},0.2);border:1px solid rgba(${emergency.color[0]},${emergency.color[1]},${emergency.color[2]},0.8);color:rgb(${emergency.color[0]},${emergency.color[1]},${emergency.color[2]});padding:2px 6px;margin-bottom:5px;font-weight:bold;letter-spacing:2px;">⚠ ${emergency.label}</div>`
      : '';

    tooltip.innerHTML = `
      ${emergencyBar}
      <div class="tt-callsign" style="color:${altColor};text-shadow:0 0 6px ${altColor};">${callsign || a.hex.toUpperCase()}</div>
      ${airline ? `<div style="color:#00cc44;font-size:10px;margin-bottom:3px;">${airline}</div>` : ''}
      ${acType  ? `<div style="color:#006620;font-size:9px;margin-bottom:3px;letter-spacing:1px;">${acType}</div>` : ''}
      <div><span class="tt-label">ICAO&nbsp;&nbsp;&nbsp;</span>${a.hex.toUpperCase()}</div>
      <div><span class="tt-label">ALT&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:${altColor}">${alt}</span></div>
      ${vrate ? `<div><span class="tt-label">VRATE&nbsp;&nbsp;</span>${vrate}</div>` : ''}
      <div><span class="tt-label">SPEED&nbsp;&nbsp;</span>${speed}</div>
      <div><span class="tt-label">DIST&nbsp;&nbsp;&nbsp;</span>${nm} NM / ${bearing}°</div>
      <div><span class="tt-label">SQUAWK&nbsp;</span>${a.squawk || '---'}</div>
      ${a.track != null ? `<div><span class="tt-label">HDG&nbsp;&nbsp;&nbsp;&nbsp;</span>${Math.round(a.track)}°</div>` : ''}
      <div style="color:#004410;font-size:9px;margin-top:4px;">CLICK TO TRACK</div>
    `;
    tooltip.style.display = 'block';

    const tw = 200, th = 170;
    let tx = px + canvas.getBoundingClientRect().left + 18;
    let ty = py + canvas.getBoundingClientRect().top  - 70;
    if (tx + tw > window.innerWidth)  tx -= tw + 36;
    if (ty < 0)                       ty  = 10;
    if (ty + th > window.innerHeight) ty  = window.innerHeight - th - 10;
    tooltip.style.left = tx + 'px';
    tooltip.style.top  = ty + 'px';
  } else {
    tooltip.style.display = 'none';
  }

  requestAnimationFrame(render);
}

// ── Event listeners ────────────────────────────────────────
canvas.addEventListener('mousemove', (e) => {
  const r = canvas.getBoundingClientRect();
  mouseX = e.clientX - r.left;
  mouseY = e.clientY - r.top;
});
canvas.addEventListener('mouseleave', () => { mouseX = -9999; mouseY = -9999; });

canvas.addEventListener('click', (e) => {
  initAudio();
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const hitRadius = Math.max(14, canvas.width * 0.025);
  let closest = null, closestDist = Infinity;
  aircraft.forEach(a => {
    if (distNm(a.lat, a.lon) > CONFIG.rangeNm) return;
    const { x, y } = latLonToNm(a.lat, a.lon);
    const { px, py } = nmToCanvas(x, y);
    const d = Math.hypot(mx - px, my - py);
    if (d < hitRadius && d < closestDist) { closest = a; closestDist = d; }
  });
  if (closest) {
    trackedHex = (trackedHex === closest.hex) ? null : closest.hex;
    document.getElementById('tracked-panel').style.display = trackedHex ? 'block' : 'none';
  }
});

document.getElementById('tp-close').addEventListener('click', () => {
  trackedHex = null;
  document.getElementById('tracked-panel').style.display = 'none';
});

const filterBtn = document.getElementById('filter-btn');
filterBtn.addEventListener('click', () => {
  filterGround = !filterGround;
  filterBtn.textContent = `GND FILTER: ${filterGround ? 'ON' : 'OFF'}`;
  filterBtn.classList.toggle('active', filterGround);
});

const pingBtn = document.getElementById('ping-btn');
pingBtn.addEventListener('click', () => {
  pingEnabled = !pingEnabled;
  pingBtn.textContent = `PING: ${pingEnabled ? 'ON' : 'OFF'}`;
  pingBtn.classList.toggle('active', pingEnabled);
});

// Quick-zoom presets
document.querySelectorAll('.zoom-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    CONFIG.rangeNm = parseInt(btn.dataset.nm);
    document.querySelectorAll('.zoom-btn').forEach(b => b.classList.remove('zoom-active'));
    btn.classList.add('zoom-active');
  });
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  switch (e.key) {
    case 'Escape':
      trackedHex = null;
      document.getElementById('tracked-panel').style.display = 'none';
      break;
    case '+': case '=':
      CONFIG.rangeNm = Math.max(20, CONFIG.rangeNm * 0.83);
      break;
    case '-': case '_':
      CONFIG.rangeNm = Math.min(400, CONFIG.rangeNm * 1.2);
      break;
    case 'g': case 'G':
      filterBtn.click();
      break;
    case 'p': case 'P':
      pingBtn.click();
      break;
  }
});

// Initial fetch + start render loop
fetchAircraft().then(() => requestAnimationFrame(render));
</script>
</body>
</html>
