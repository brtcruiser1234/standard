<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docker File Browser</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .controls input,
    .controls button,
    .controls select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .controls select {
      flex: 1;
      min-width: 200px;
    }

    .controls button {
      background: #667eea;
      color: white;
      cursor: pointer;
      border: none;
      font-weight: 600;
      transition: background 0.3s;
    }

    .controls button:hover {
      background: #5568d3;
    }

    .main {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 20px;
    }

    .sidebar {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .sidebar h3 {
      background: #f5f5f5;
      padding: 15px;
      font-size: 12px;
      text-transform: uppercase;
      color: #666;
      border-bottom: 1px solid #eee;
    }

    .sidebar ul {
      list-style: none;
    }

    .sidebar li {
      padding: 0;
    }

    .sidebar a {
      display: block;
      padding: 10px 15px;
      color: #333;
      text-decoration: none;
      border-left: 3px solid transparent;
      font-size: 13px;
      transition: all 0.2s;
      word-break: break-all;
    }

    .sidebar a:hover {
      background: #f5f5f5;
      border-left-color: #667eea;
    }

    .sidebar a.active {
      background: #f0f4ff;
      border-left-color: #667eea;
      color: #667eea;
      font-weight: 600;
    }

    .content {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .breadcrumb {
      background: #f5f5f5;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
      color: #666;
      word-break: break-all;
    }

    .files-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .file-item {
      display: grid;
      grid-template-columns: 30px 1fr 100px 80px auto;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
      transition: background 0.2s;
    }

    .file-item:hover {
      background: #f9f9f9;
    }

    .file-icon {
      text-align: center;
      font-size: 16px;
    }

    .file-name {
      color: #333;
      word-break: break-all;
    }

    .file-size {
      text-align: right;
      color: #999;
    }

    .file-date {
      text-align: right;
      color: #999;
      min-width: 80px;
    }

    .file-actions {
      display: flex;
      gap: 5px;
    }

    .btn-download {
      background: #667eea;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .btn-download:hover {
      background: #5568d3;
    }

    .loading {
      padding: 40px;
      text-align: center;
      color: #999;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 4px;
      margin: 10px;
      font-size: 13px;
    }

    .empty {
      padding: 40px;
      text-align: center;
      color: #999;
    }

    .icon-folder { color: #f0ad4e; }
    .icon-file { color: #5bc0de; }
    .icon-image { color: #5cb85c; }
    .icon-archive { color: #d9534f; }

    @media (max-width: 768px) {
      .main {
        grid-template-columns: 1fr;
      }

      .file-item {
        grid-template-columns: 1fr auto;
      }

      .file-size,
      .file-date {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì¶ Docker File Browser</h1>
      <p>Browse and download files from Docker containers</p>

      <div class="controls">
        <select id="containerSelect">
          <option value="">Loading containers...</option>
        </select>
        <input type="text" id="pathInput" placeholder="/home/user/documents" value="/">
        <button onclick="loadFiles()">Browse</button>
      </div>
    </div>

    <div class="main">
      <div class="sidebar">
        <h3>Quick Paths</h3>
        <ul id="quickPaths">
          <li><a href="#" onclick="navigate('/'); return false;">/ (Root)</a></li>
          <li><a href="#" onclick="navigate('/root'); return false;">/root</a></li>
          <li><a href="#" onclick="navigate('/home'); return false;">/home</a></li>
          <li><a href="#" onclick="navigate('/tmp'); return false;">/tmp</a></li>
          <li><a href="#" onclick="navigate('/var/log'); return false;">/var/log</a></li>
          <li><a href="#" onclick="navigate('/app'); return false;">/app</a></li>
          <li><a href="#" onclick="navigate('/data'); return false;">/data</a></li>
        </ul>

        <h3 style="margin-top: 20px;">Directories</h3>
        <ul id="dirsList">
          <li><span style="padding: 10px 15px; display: block; color: #999;">Loading...</span></li>
        </ul>
      </div>

      <div class="content">
        <div class="breadcrumb" id="breadcrumb">/</div>

        <div id="errorContainer"></div>

        <div class="files-list" id="filesList">
          <div class="loading">Loading files...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentContainer = null;
    let currentPath = '/';

    // Load containers on startup
    async function loadContainers() {
      try {
        const res = await fetch('/api/containers');
        const containers = await res.json();

        const select = document.getElementById('containerSelect');
        select.innerHTML = '';

        if (containers.length === 0) {
          select.innerHTML = '<option>No running containers found</option>';
          return;
        }

        containers.forEach(c => {
          const option = document.createElement('option');
          option.value = c.id;
          option.textContent = `${c.name} (${c.state})`;
          select.appendChild(option);
        });

        if (containers.length > 0) {
          currentContainer = containers[0].id;
          select.value = currentContainer;
          loadFiles();
        }
      } catch (err) {
        showError('Failed to load containers: ' + err.message);
      }
    }

    // Load files and directories
    async function loadFiles() {
      currentContainer = document.getElementById('containerSelect').value;
      currentPath = document.getElementById('pathInput').value || '/';

      if (!currentContainer) {
        showError('No container selected');
        return;
      }

      try {
        // Update breadcrumb
        document.getElementById('breadcrumb').textContent = currentPath;

        // Load files
        const filesRes = await fetch(`/api/files?container=${currentContainer}&dir=${encodeURIComponent(currentPath)}`);
        const filesData = await filesRes.json();

        if (filesData.error) {
          showError(filesData.error);
          return;
        }

        displayFiles(filesData.files || []);
        clearError();

        // Load directories
        const dirsRes = await fetch(`/api/dirs?container=${currentContainer}&dir=${encodeURIComponent(currentPath)}`);
        const dirs = await dirsRes.json();
        displayDirs(dirs);

      } catch (err) {
        showError('Failed to load files: ' + err.message);
      }
    }

    // Display files in list
    function displayFiles(files) {
      const list = document.getElementById('filesList');

      if (files.length === 0) {
        list.innerHTML = '<div class="empty">No files in this directory</div>';
        return;
      }

      list.innerHTML = files.map(file => `
        <div class="file-item">
          <div class="file-icon">${getFileIcon(file.name)}</div>
          <div class="file-name">${escapeHtml(file.name)}</div>
          <div class="file-size">${file.size || '‚Äî'}</div>
          <div class="file-date">${file.modified?.slice(0, 10) || '‚Äî'}</div>
          <div class="file-actions">
            <button class="btn-download" onclick="downloadFile('${escapeAttr(currentPath)}', '${escapeAttr(file.name)}')">Download</button>
          </div>
        </div>
      `).join('');
    }

    // Display directories in sidebar
    function displayDirs(dirs) {
      const list = document.getElementById('dirsList');

      if (dirs.length === 0) {
        list.innerHTML = '<li><span style="padding: 10px 15px; display: block; color: #999;">No subdirectories</span></li>';
        return;
      }

      list.innerHTML = dirs.map(dir => `
        <li><a href="#" onclick="navigate('${escapeAttr(dir.path)}'); return false;">
          üìÅ ${escapeHtml(dir.name)}
        </a></li>
      `).join('');
    }

    // Navigate to directory
    function navigate(path) {
      document.getElementById('pathInput').value = path;
      loadFiles();
    }

    // Download file
    async function downloadFile(dir, filename) {
      const filePath = dir.endsWith('/') ? dir + filename : dir + '/' + filename;
      const url = `/api/download?container=${currentContainer}&path=${encodeURIComponent(filePath)}`;

      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Utility functions
    function getFileIcon(name) {
      const ext = name.split('.').pop().toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) return 'üñºÔ∏è';
      if (['zip', 'tar', 'gz', 'rar', '7z'].includes(ext)) return 'üì¶';
      if (['pdf'].includes(ext)) return 'üìÑ';
      if (['txt', 'log', 'md'].includes(ext)) return 'üìù';
      if (['mp4', 'avi', 'mov'].includes(ext)) return 'üé¨';
      return 'üìÑ';
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    function escapeAttr(text) {
      return text.replace(/'/g, "\\'");
    }

    function showError(msg) {
      const container = document.getElementById('errorContainer');
      container.innerHTML = `<div class="error">‚ö†Ô∏è ${escapeHtml(msg)}</div>`;
    }

    function clearError() {
      document.getElementById('errorContainer').innerHTML = '';
    }

    // Initialize on page load
    window.addEventListener('load', loadContainers);
  </script>
</body>
</html>
