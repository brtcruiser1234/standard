<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHL Team Tracker - Live Stats</title>
    <meta name="description" content="Live NHL stats, play-by-play, and highlights for your favorite team">
    <link rel="icon" href="" id="favicon" type="image/svg+xml">

    <!-- Open Graph / Social Media Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="NHL Team Tracker - Live Stats" id="ogTitle">
    <meta property="og:description" content="Live NHL stats, play-by-play, and highlights for your favorite team" id="ogDescription">
    <meta property="og:image" content="" id="ogImage">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="500">
    <meta property="og:image:height" content="500">
    <meta property="og:url" content="https://mammothlive.taylorshome.cc">

    <!-- Twitter / X Sharing -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NHL Team Tracker - Live Stats" id="twitterTitle">
    <meta name="twitter:description" content="Live NHL stats, play-by-play, and highlights for your favorite team" id="twitterDescription">
    <meta name="twitter:image" content="" id="twitterImage">

    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --mammoth-blue: #69B3E7;
            --mammoth-dark-blue: #1A4D7A;
            --mammoth-accent: #FFB81C;
            --stadium-black: #0A0A0A;
            --stadium-dark: #1a1a1a;
            --concrete: #2a2a2a;
            --metal: #3a3a3a;
            --led-glow: rgba(105, 179, 231, 0.3);
        }

        html, body {
            height: auto;
            overflow-y: auto;
        }

        body {
            font-family: 'Barlow Condensed', sans-serif;
            background: var(--stadium-black);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Stadium Atmosphere */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 50% 100%, rgba(105, 179, 231, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 20% 0%, rgba(255, 184, 28, 0.03) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        /* NHL Games Ticker */
        .nhl-ticker {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            max-width: 280px;
        }

        .nhl-ticker-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            color: #666;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .nhl-ticker-game {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 1px solid var(--concrete);
            min-width: 220px;
        }

        .nhl-ticker-team {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .nhl-ticker-team img {
            width: 24px;
            height: 24px;
        }

        .nhl-ticker-abbrev {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #ccc;
            min-width: 30px;
        }

        .nhl-ticker-score {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }

        .nhl-ticker-score.winner { color: #4CAF50; }

        .nhl-ticker-vs {
            color: #555;
            font-size: 12px;
            padding: 0 4px;
        }

        .nhl-ticker-status {
            font-size: 10px;
            color: #888;
            text-align: center;
            margin-top: 4px;
            letter-spacing: 1px;
        }

        .nhl-ticker-status.live {
            color: #f44336;
            font-weight: 700;
        }

        .nhl-ticker-nav {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 8px;
        }

        .nhl-ticker-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #444;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nhl-ticker-dot.active {
            background: var(--mammoth-blue);
        }

        @media (max-width: 900px) {
            .nhl-ticker {
                position: static;
                transform: none;
                max-width: 100%;
                margin-bottom: 15px;
            }
            .nhl-ticker-game {
                justify-content: center;
            }
        }

        /* Venue Header */
        .venue-header {
            text-align: center;
            padding: 30px 20px 20px;
            border-bottom: 2px solid var(--concrete);
            margin-bottom: 30px;
            position: relative;
        }

        .venue-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 6px;
            color: var(--mammoth-blue);
            text-transform: uppercase;
            text-shadow: 0 0 20px var(--led-glow), 0 0 40px var(--led-glow);
            margin-bottom: 5px;
        }

        .venue-location {
            font-size: 16px;
            color: #888;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .game-countdown {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            color: var(--mammoth-accent);
            margin-top: 10px;
            letter-spacing: 1px;
        }

        .countdown-timer {
            font-size: 24px;
            font-weight: 700;
            color: var(--mammoth-blue);
            margin-top: 5px;
        }

        /* TV / Fullscreen Mode */
        body.tv-mode .nav-tabs,
        body.tv-mode .venue-header {
            display: none;
        }

        .tv-exit {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 1200;
            display: none;
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 2px;
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.18);
            color: #fff;
            background: rgba(10,10,10,0.7);
            cursor: pointer;
            text-transform: uppercase;
            backdrop-filter: blur(6px);
        }

        body.tv-mode .tv-exit {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        body.tv-mode .last-updated {
            display: none;
        }

        body.tv-mode .container {
            max-width: 100%;
            padding: 10px 20px 30px;
        }

        body.tv-mode .scoreboard {
            padding: 55px 50px;
        }

        body.tv-mode .team-name {
            font-size: 52px;
        }

        body.tv-mode .score {
            font-size: 150px;
        }

        body.tv-mode .clock {
            font-size: 70px;
        }

        body.tv-mode .stat-value {
            font-size: 44px;
        }

        body.tv-mode .standings-team-name {
            font-size: 22px;
        }

        body.tv-mode .player-table td {
            font-size: 18px;
        }

        body.tv-mode #threeStars {
            display: none;
        }

        /* Goal banner */
        .goal-banner {
            position: fixed;
            left: 50%;
            top: 40px;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 18px 28px;
            border-radius: 14px;
            border: 2px solid rgba(255,255,255,0.22);
            background: linear-gradient(90deg, rgba(255, 184, 28, 0.18), rgba(105, 179, 231, 0.18));
            backdrop-filter: blur(8px);
            box-shadow: 0 18px 40px rgba(0,0,0,0.55);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 900;
            letter-spacing: 6px;
            text-transform: uppercase;
            text-align: center;
        }

        .goal-banner-main {
            display: inline-flex;
            align-items: baseline;
            justify-content: center;
            gap: 18px;
            font-size: 52px;
        }

        .goal-banner-detail {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #ddd;
            text-transform: none;
        }

        .goal-banner.on {
            display: inline-flex;
            animation: goalDrop 0.25s ease, goalPulse 1.1s ease infinite;
        }

        @keyframes goalDrop {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @keyframes goalPulse {
            0% { box-shadow: 0 18px 40px rgba(0,0,0,0.55); }
            50% { box-shadow: 0 18px 55px rgba(255,184,28,0.35); }
            100% { box-shadow: 0 18px 40px rgba(0,0,0,0.55); }
        }

        .goal-banner .goal-team {
            font-size: 18px;
            letter-spacing: 3px;
            color: #ddd;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .nav-tab {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            padding: 15px 35px;
            background: linear-gradient(145deg, var(--metal) 0%, var(--concrete) 100%);
            border: 2px solid var(--concrete);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .nav-tab:hover {
            border-color: var(--mammoth-blue);
            box-shadow: 0 0 20px var(--led-glow);
        }

        .nav-tab.active {
            background: linear-gradient(145deg, var(--mammoth-dark-blue) 0%, var(--mammoth-blue) 100%);
            border-color: var(--mammoth-accent);
            box-shadow: 0 0 30px var(--led-glow);
        }

        /* Mobile Hamburger Menu */
        .hamburger-menu {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1100;
            width: 50px;
            height: 50px;
            background: rgba(26, 77, 122, 0.95);
            border: 2px solid var(--mammoth-blue);
            border-radius: 10px;
            cursor: pointer;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 12px;
        }

        .hamburger-line {
            width: 100%;
            height: 3px;
            background: #fff;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-menu.open .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-menu.open .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.open .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .mobile-nav {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.98);
            z-index: 1050;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
        }

        .mobile-nav.open {
            display: flex;
        }

        .mobile-nav-btn {
            font-family: 'Rajdhani', sans-serif;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: 2px;
            padding: 18px 40px;
            background: linear-gradient(145deg, var(--metal) 0%, var(--concrete) 100%);
            border: 2px solid var(--concrete);
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            width: 100%;
            max-width: 300px;
            text-align: center;
        }

        .mobile-nav-btn:hover,
        .mobile-nav-btn.active {
            background: linear-gradient(145deg, var(--mammoth-dark-blue) 0%, var(--mammoth-blue) 100%);
            border-color: var(--mammoth-accent);
        }

        @media (max-width: 768px) {
            .nav-tabs {
                display: none !important;
            }
            .hamburger-menu {
                display: flex;
            }
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        #scoreboard.page.active {
            display: flex;
            flex-direction: column;
            padding-bottom: 50px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* SCOREBOARD STYLES */
        .scoreboard {
            position: relative;
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 3px solid var(--concrete);
            border-radius: 15px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .live-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.18);
            backdrop-filter: blur(6px);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 800;
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .live-badge.on { display: inline-flex; }
        .live-badge.live { background: rgba(255, 0, 0, 0.12); }
        .live-badge.pregame { background: rgba(255, 184, 28, 0.12); }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: livePulse 1.2s ease infinite;
        }

        .live-badge.live .live-dot {
            background: #ff2a2a;
            box-shadow: 0 0 12px rgba(255, 42, 42, 0.9);
        }

        .live-badge.pregame .live-dot {
            background: var(--mammoth-accent);
            box-shadow: 0 0 12px rgba(255, 184, 28, 0.7);
        }

        @keyframes livePulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.35); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        .game-status {
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
            font-size: 24px;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            margin-bottom: 20px;
            font-weight: 700;
        }

        /* New Scoreboard Layout: Name - Logo - Score | Clock | Score - Logo - Name */
        .scoreboard-main {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .team-side {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .utah-side {
            flex-direction: row;
        }

        .opp-side {
            flex-direction: row;
        }

        /* Goal Scorers on Scoreboard */
        .goal-scorers {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            max-width: 200px;
            min-width: 120px;
            max-height: 200px;
            overflow-y: auto;
        }

        .goal-scorers:empty {
            display: none;
        }

        .utah-scorers {
            text-align: right;
            align-items: flex-end;
        }

        .opp-scorers {
            text-align: left;
            align-items: flex-start;
        }

        .goal-scorer-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 2px 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .utah-scorers .goal-scorer-item {
            flex-direction: row-reverse;
            border-left: 2px solid var(--mammoth-blue);
        }

        .opp-scorers .goal-scorer-item {
            border-right: 2px solid var(--opp-color, #888);
        }

        .goal-scorer-name {
            font-weight: 600;
            color: #fff;
            font-size: 11px;
        }

        .goal-scorer-time {
            font-size: 10px;
            color: #888;
        }

        .goal-scorer-type {
            font-size: 9px;
            color: #ffd700;
            text-transform: uppercase;
        }

        @media (max-width: 1200px) {
            .goal-scorers {
                display: none;
            }
        }

        .team-info {
            text-align: center;
            min-width: 120px;
        }

        .team-logo {
            width: 100px;
            height: 100px;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4));
        }

        /* Power Play Indicator on Scoreboard */
        .pp-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            border-radius: 6px;
            padding: 6px 10px;
            animation: pp-pulse 1.5s ease-in-out infinite;
        }

        .pp-indicator.active {
            display: flex;
        }

        .pp-indicator.pk {
            background: linear-gradient(135deg, #c41e3a 0%, #8b0000 100%);
        }

        .pp-indicator-text {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pp-indicator.pk .pp-indicator-text {
            color: #fff;
        }

        @keyframes pp-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.85; transform: scale(1.02); }
        }

        .team-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            line-height: 1.1;
            text-shadow: 0 0 8px rgba(255,255,255,0.6), 0 0 15px rgba(255,255,255,0.3), 1px 1px 2px rgba(0,0,0,0.8);
        }

        .team-record {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            color: #888;
        }

        .utah-side .team-name {
            color: var(--mammoth-blue);
        }

        .team-stats-inline {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            color: #888;
            min-width: 45px;
        }

        .utah-side .team-stats-inline {
            text-align: right;
            margin-right: 10px;
        }

        .opp-side .team-stats-inline {
            text-align: left;
            margin-left: 10px;
        }

        .inline-stat {
            white-space: nowrap;
        }

        .inline-stat .stat-val {
            font-weight: 700;
            font-size: 13px;
            color: #fff;
        }

        .score {
            font-family: 'Rajdhani', sans-serif;
            font-size: 72px;
            font-weight: 700;
            line-height: 1;
            min-width: 60px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255,255,255,0.6), 0 0 20px rgba(255,255,255,0.3), 2px 2px 4px rgba(0,0,0,0.8);
        }

        .utah-side .score {
            color: var(--mammoth-blue);
        }

        .game-center {
            text-align: center;
            padding: 0 25px;
            border-left: 2px solid var(--concrete);
            border-right: 2px solid var(--concrete);
            min-width: 100px;
        }

        .clock {
            font-family: 'Rajdhani', sans-serif;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #fff;
            line-height: 1.2;
        }

        .period {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--mammoth-accent);
            font-weight: 600;
        }

        /* Scoreboard Info Row (Recent Plays | Last Meeting | Top Player) */
        .scoreboard-info-row {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--concrete);
        }

        .info-box {
            flex: 1;
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--concrete);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Rajdhani', sans-serif;
        }

        .info-box-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-align: center;
        }

        /* Recent Plays Box */
        .recent-plays-box {
            min-width: 0;
        }

        .recent-play-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
            color: #999;
        }

        .recent-play-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .recent-play-item:first-child {
            padding-top: 0;
        }

        .recent-play-time {
            color: var(--mammoth-accent);
            font-weight: 600;
            white-space: nowrap;
            font-size: 13px;
        }

        .recent-play-desc {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .recent-play-item.goal {
            color: #fff;
        }

        .recent-play-item.goal .recent-play-desc {
            font-weight: 600;
        }

        /* Last Meeting Box */
        .last-meeting-box {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .last-meeting-content {
            font-size: 15px;
            color: #888;
            line-height: 1.5;
        }

        .last-meeting-content strong {
            color: #aaa;
        }

        .last-meeting-content .result-win { color: #4CAF50; font-weight: 700; }
        .last-meeting-content .result-loss { color: #f44336; font-weight: 700; }
        .last-meeting-content .sog-info { color: #666; display: block; font-size: 13px; margin-top: 4px; }

        /* Top Player Box */
        .top-player-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .top-player-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .top-player-content img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--mammoth-blue);
        }

        .top-player-info {
            text-align: left;
        }

        .top-player-name {
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
        }

        .top-player-stats {
            font-size: 13px;
            color: #888;
        }

        /* Responsive: Tablet */
        @media (max-width: 900px) {
            .scoreboard-info-row {
                flex-wrap: wrap;
            }
            .recent-plays-box,
            .last-meeting-box {
                flex: 1 1 45%;
            }
            .top-player-box {
                flex: 1 1 100%;
                flex-direction: row;
                justify-content: center;
                gap: 15px;
            }
            .top-player-content {
                justify-content: center;
            }
        }

        /* Responsive: Phone */
        @media (max-width: 600px) {
            .scoreboard-info-row {
                flex-direction: column;
                gap: 10px;
            }
            .recent-plays-box,
            .last-meeting-box,
            .top-player-box {
                flex: 1 1 100%;
            }
            .info-box {
                padding: 10px;
            }
            .top-player-box {
                flex-direction: column;
            }
            .top-player-content {
                flex-direction: column;
                text-align: center;
            }
            .top-player-info {
                text-align: center;
            }
        }

        /* Goalie Row (without Player of Game) */
        .goalie-player-row {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px 0;
        }

        .goalie-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--concrete);
            border-radius: 8px;
            padding: 8px 12px;
            min-width: 140px;
        }

        .goalie-mini.utah-goalie {
            border-left: 3px solid var(--mammoth-blue);
        }

        .goalie-mini.opp-goalie {
            border-right: 3px solid var(--opp-color, #888);
        }

        .goalie-mini-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .goalie-mini-info {
            display: flex;
            flex-direction: column;
        }

        .goalie-mini-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
        }

        .goalie-mini-stats {
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            color: #888;
        }

        .player-of-game {
            flex: 1;
            text-align: center;
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--concrete);
            border-radius: 8px;
            padding: 8px 15px;
        }

        .player-of-game-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 10px;
            font-weight: 600;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .player-of-game-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .player-of-game-content img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .player-of-game-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
        }

        .player-of-game-stats {
            font-size: 11px;
            color: #888;
        }

        /* Rink-Centric Stats Layout */
        .rink-stats-layout {
            display: grid;
            grid-template-columns: 200px 1fr 200px;
            gap: 15px;
            align-items: stretch;
            margin-bottom: 15px;
        }

        .team-stats-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--concrete);
            border-radius: 10px;
            padding: 12px;
            overflow: hidden;
        }

        /* Team logo background for stat columns */
        .team-stats-column::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 85%;
            background-image: var(--column-team-logo);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.08;
            z-index: 0;
            pointer-events: none;
        }

        .team-stats-column > * {
            position: relative;
            z-index: 1;
        }

        .team-stats-column.utah {
            border-left: 4px solid var(--mammoth-blue);
        }

        .team-stats-column.opp {
            border-right: 4px solid var(--opp-color, #888);
        }

        .team-stat-item {
            position: relative;
            background: linear-gradient(145deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.2) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px 14px;
            overflow: hidden;
            flex: 1;
        }

        /* Team logo watermark in each stat box */
        .team-stat-item::before,
        .penalty-box::before,
        .goalie-compact::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            background-image: var(--box-team-logo);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.1;
            z-index: 0;
            pointer-events: none;
        }

        .team-stat-item > *,
        .penalty-box > *,
        .goalie-compact > * {
            position: relative;
            z-index: 1;
        }

        .team-stats-column.utah .team-stat-item {
            border-left: 3px solid var(--mammoth-blue);
        }

        .team-stats-column.opp .team-stat-item {
            border-right: 3px solid var(--opp-color, #888);
        }

        .team-stat-item .stat-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .team-stat-item .stat-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 30px;
            font-weight: 700;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .team-stats-column.opp .team-stat-item {
            text-align: right;
        }

        /* Penalty Box Display */
        .penalty-box {
            position: relative;
            background: linear-gradient(145deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.2) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 10px 12px;
            min-height: auto;
            overflow: visible;
            flex: 1 1 auto;
        }

        .team-stats-column.utah .penalty-box {
            border-left: 3px solid var(--mammoth-blue);
        }

        .team-stats-column.opp .penalty-box {
            border-right: 3px solid var(--opp-color, #888);
            text-align: right;
        }

        .penalty-box-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #c41e3a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .penalty-box-empty {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            color: #555;
        }

        .penalty-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .penalty-item:last-child {
            margin-bottom: 0;
        }

        .team-stats-column.opp .penalty-item {
            flex-direction: row-reverse;
        }

        .penalty-mugshot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #c41e3a;
            flex-shrink: 0;
        }

        .penalty-info {
            flex: 1;
            min-width: 0;
        }

        .penalty-player {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .penalty-time {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #c41e3a;
        }

        .penalty-type {
            font-family: 'Rajdhani', sans-serif;
            font-size: 10px;
            color: #888;
            text-transform: capitalize;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Penalty Box Mobile */
        @media (max-width: 768px) {
            .penalty-box {
                padding: 6px 8px;
            }
            .penalty-box-title {
                font-size: 9px;
                margin-bottom: 3px;
            }
            .penalty-item {
                gap: 4px;
            }
            .penalty-mugshot {
                width: 24px;
                height: 24px;
                border-width: 1px;
            }
            .penalty-player {
                font-size: 10px;
            }
            .penalty-time {
                font-size: 11px;
            }
            .penalty-type {
                font-size: 8px;
            }
            .penalty-info {
                line-height: 1.1;
            }
        }

        @media (max-width: 480px) {
            .penalty-box {
                padding: 5px 6px;
            }
            .penalty-mugshot {
                width: 20px;
                height: 20px;
            }
            .penalty-player {
                font-size: 9px;
            }
            .penalty-time {
                font-size: 10px;
            }
            .penalty-type {
                display: none;
            }
        }

        /* Compact Goalie Display */
        .goalie-compact {
            position: relative;
            background: linear-gradient(145deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.2) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: auto;
            overflow: hidden;
            flex: 1;
        }

        .team-stats-column.utah .goalie-compact {
            border-left: 3px solid var(--mammoth-blue);
        }

        .team-stats-column.opp .goalie-compact {
            border-right: 3px solid var(--opp-color, #888);
            flex-direction: row-reverse;
            text-align: right;
        }

        .goalie-compact-img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--mammoth-blue);
        }

        .team-stats-column.opp .goalie-compact-img {
            border-color: var(--opp-color, #888);
        }

        .goalie-compact-info {
            flex: 1;
        }

        .goalie-compact-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #fff;
        }

        .goalie-compact-sv {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--mammoth-accent);
        }

        /* Rink Center - Larger */
        .rink-center {
            display: flex;
            flex-direction: column;
        }

        .rink-center .shot-chart-container {
            flex: 1;
        }

        .rink-center-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--concrete);
            border-radius: 8px;
            padding: 10px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Legacy - Keep for backward compatibility but hidden */
        .main-stats-row {
            display: none;
        }

        .goalie-player-row {
            display: none;
        }

        .side-stat-card {
            display: none;
        }

        .penalty-mini-type {
            color: #888;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Faceoff Tracker */
        .faceoff-tracker {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .faceoff-period-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .faceoff-period-row:last-child {
            border-bottom: none;
        }

        .faceoff-period-label {
            color: #888;
            font-weight: 600;
            min-width: 50px;
        }

        .faceoff-period-stats {
            display: flex;
            gap: 20px;
        }

        .faceoff-team-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .faceoff-wins {
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }

        .faceoff-pct {
            color: #888;
            font-size: 11px;
        }

        .utah-fo { color: var(--mammoth-blue); }

        /* Goalie Stats Card */
        .goalie-stats-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .goalie-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .goalie-stats-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            text-transform: uppercase;
        }

        .goalie-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .goalie-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        .goalie-card.utah {
            border-left: 3px solid var(--mammoth-blue);
        }

        .goalie-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .goalie-info {
            flex: 1;
        }

        .goalie-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #fff;
        }

        .goalie-number {
            font-size: 12px;
            color: #888;
        }

        .goalie-stat-row {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .goalie-stat {
            text-align: center;
        }

        .goalie-stat-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .goalie-stat-value.highlight {
            color: var(--mammoth-blue);
        }

        .goalie-stat-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Power Play / Penalty Kill Timer */
        .special-teams-banner {
            display: none;
            background: linear-gradient(90deg, rgba(255,193,7,0.2) 0%, rgba(255,193,7,0.1) 100%);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .special-teams-banner.pk {
            background: linear-gradient(90deg, rgba(244,67,54,0.2) 0%, rgba(244,67,54,0.1) 100%);
            border-color: #f44336;
        }

        .special-teams-banner.active {
            display: block;
            animation: pulse-border 1.5s ease-in-out infinite;
        }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 10px rgba(255,193,7,0.3); }
            50% { box-shadow: 0 0 20px rgba(255,193,7,0.6); }
        }

        .special-teams-banner.pk {
            animation-name: pulse-border-pk;
        }

        @keyframes pulse-border-pk {
            0%, 100% { box-shadow: 0 0 10px rgba(244,67,54,0.3); }
            50% { box-shadow: 0 0 20px rgba(244,67,54,0.6); }
        }

        .special-teams-type {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .special-teams-banner .special-teams-type { color: #ffc107; }
        .special-teams-banner.pk .special-teams-type { color: #f44336; }

        .special-teams-time {
            font-family: 'Rajdhani', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #fff;
        }

        .special-teams-strength {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }

        /* Player of the Game */
        .player-of-game {
            background: linear-gradient(145deg, rgba(105,179,231,0.15) 0%, rgba(105,179,231,0.05) 100%);
            border: 2px solid var(--mammoth-blue);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .player-of-game-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .player-of-game-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .player-of-game img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid var(--mammoth-blue);
        }

        .player-of-game-info {
            text-align: left;
        }

        .player-of-game-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: #fff;
        }

        .player-of-game-stats {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .player-of-game-stat {
            background: rgba(0,0,0,0.3);
            padding: 5px 12px;
            border-radius: 5px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
        }

        .player-of-game-stat span {
            color: #888;
            font-weight: 400;
            margin-right: 5px;
        }

        /* Rotating Stats Card */
        .rotating-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 15px;
            min-height: 180px;
            position: relative;
            overflow: hidden;
        }

        .rotating-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .rotating-card-tabs {
            display: flex;
            gap: 6px;
        }

        .rotating-card-tab {
            padding: 4px 8px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: #666;
            background: rgba(0,0,0,0.2);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rotating-card-tab:hover {
            color: #aaa;
        }

        .rotating-card-tab.active {
            color: var(--mammoth-blue);
            background: rgba(105,179,231,0.15);
        }

        .rotating-card-auto {
            font-size: 9px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .rotating-card-auto input {
            width: 12px;
            height: 12px;
            cursor: pointer;
        }

        .rotating-card-content {
            position: relative;
        }

        .rotating-card-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .rotating-card-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Rink panel adjustments */
        .rotating-card .shot-chart-rink {
            max-width: 320px;
            margin: 0 auto;
        }

        /* Goalies panel adjustments */
        .rotating-card .goalie-container {
            flex-direction: row;
            gap: 10px;
        }

        .rotating-card .goalie-card {
            flex: 1;
        }

        /* Fastest shots panel adjustments */
        .rotating-card .fastest-shot-item {
            padding: 5px 8px;
            margin-bottom: 4px;
        }

        /* Shot Location Chart - New Layout */
        .shot-chart-container {
            display: flex;
            gap: 10px;
            height: 100%;
        }

        /* Left side - Legend & Stats Box */
        .shot-chart-sidebar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 90px;
        }

        .shot-chart-legend {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 10px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--concrete);
            border-radius: 6px;
            padding: 8px;
        }

        .shot-chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .shot-chart-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .shot-chart-legend-dot.utah { background: var(--mammoth-blue); }
        .shot-chart-legend-dot.opp { background: var(--opp-color, #f44336); }
        .shot-chart-legend-dot.goal { background: #FFD700; }

        .shot-zone-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .zone-stat {
            font-size: 12px;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--concrete);
        }

        .zone-stat.utah {
            border-left: 3px solid var(--mammoth-blue);
        }

        .zone-stat.opp {
            border-left: 3px solid var(--opp-color, #f44336);
        }

        .zone-label {
            color: #888;
            font-size: 9px;
            display: block;
            margin-bottom: 2px;
        }

        .zone-stat.utah span:last-child {
            font-weight: 700;
            font-size: 20px;
            color: var(--mammoth-blue);
            text-shadow: 0 0 8px rgba(255,255,255,0.6), 0 0 15px rgba(255,255,255,0.3), 1px 1px 2px rgba(0,0,0,0.8);
        }

        .zone-stat.opp span:last-child {
            font-weight: 700;
            font-size: 20px;
            color: var(--opp-color, #f44336);
            text-shadow: 0 0 8px rgba(255,255,255,0.6), 0 0 15px rgba(255,255,255,0.3), 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Period Selector - Vertical */
        .period-selector {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--concrete);
            border-radius: 6px;
            padding: 6px;
        }

        .period-btn {
            font-family: 'Rajdhani', sans-serif;
            font-size: 10px;
            font-weight: 600;
            padding: 5px 6px;
            border: 1px solid var(--concrete);
            border-radius: 4px;
            background: rgba(0,0,0,0.2);
            color: #888;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .period-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .period-btn.active {
            background: var(--mammoth-blue);
            border-color: var(--mammoth-blue);
            color: #fff;
        }

        /* Rink wrapper - fills remaining space */
        .shot-chart-rink-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 70%;
            margin: 0 auto;
        }

        .shot-chart-rink {
            position: relative;
            width: 100%;
            max-width: 100%;
            aspect-ratio: 2.1/1;
            background: #f5f5f5;
            border-radius: 10%;
            border: 2px solid #222;
            overflow: hidden;
        }

        /* Goal lines (red) - 11ft from end on 200ft rink = 5.5% */
        .rink-goal-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #c41e3a;
        }
        .rink-goal-line.left { left: 5.5%; }
        .rink-goal-line.right { right: 5.5%; }

        /* Center red line */
        .rink-center-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #c41e3a;
            transform: translateX(-50%);
        }

        /* Blue lines - 75ft from end on 200ft rink = 37.5% */
        .rink-blue-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #1e5aa8;
        }
        .rink-blue-line.left { left: 37.5%; }
        .rink-blue-line.right { right: 37.5%; }

        /* Center ice circle and dot */
        .rink-center-circle {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 12%;
            aspect-ratio: 1/1;
            border: 2px solid #1e5aa8;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .rink-center-dot {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 2%;
            aspect-ratio: 1/1;
            background: #1e5aa8;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        /* Faceoff circles - 31ft from end (15.5%), 22ft from center (26% from middle)
           NHL: 200ft x 85ft rink, circles are 30ft diameter (15% of length, 35% of height)
           Positioned at 15.5% from edge, 24% and 76% from top */
        .rink-faceoff-circle {
            position: absolute;
            width: 14%;
            height: 30%;
            border: 2px solid #c41e3a;
            border-radius: 50%;
        }
        .rink-faceoff-circle.left-top { left: 15.5%; top: 24%; transform: translate(-50%, -50%); }
        .rink-faceoff-circle.left-bottom { left: 15.5%; top: 76%; transform: translate(-50%, -50%); }
        .rink-faceoff-circle.right-top { right: 15.5%; top: 24%; transform: translate(50%, -50%); }
        .rink-faceoff-circle.right-bottom { right: 15.5%; top: 76%; transform: translate(50%, -50%); }

        /* Faceoff dots - center of each circle */
        .rink-faceoff-dot {
            position: absolute;
            width: 2.5%;
            height: 5%;
            background: #c41e3a;
            border-radius: 50%;
            z-index: 2;
        }
        .rink-faceoff-dot.left-top { left: 15.5%; top: 24%; transform: translate(-50%, -50%); }
        .rink-faceoff-dot.left-bottom { left: 15.5%; top: 76%; transform: translate(-50%, -50%); }
        .rink-faceoff-dot.right-top { right: 15.5%; top: 24%; transform: translate(50%, -50%); }
        .rink-faceoff-dot.right-bottom { right: 15.5%; top: 76%; transform: translate(50%, -50%); }

        /* Neutral zone dots - INSIDE neutral zone (blue lines at 37.5%, dots at 40%) */
        .rink-faceoff-dot.neutral-left-top { left: 40%; top: 24%; transform: translate(-50%, -50%); }
        .rink-faceoff-dot.neutral-left-bottom { left: 40%; top: 76%; transform: translate(-50%, -50%); }
        .rink-faceoff-dot.neutral-right-top { right: 40%; top: 24%; transform: translate(50%, -50%); }
        .rink-faceoff-dot.neutral-right-bottom { right: 40%; top: 76%; transform: translate(50%, -50%); }

        /* Goal crease - positioned at goal line (5.5%) */
        .rink-goal-crease {
            position: absolute;
            top: 50%;
            width: 3%;
            height: 20%;
            background: rgba(135, 206, 250, 0.6);
            border: 1px solid #1e5aa8;
            transform: translateY(-50%);
        }
        .rink-goal-crease.left {
            left: 5.5%;
            border-radius: 0 50% 50% 0;
            border-left: none;
        }
        .rink-goal-crease.right {
            right: 5.5%;
            border-radius: 50% 0 0 50%;
            border-right: none;
        }

        /* Goal net - behind goal line */
        .rink-goal-net {
            position: absolute;
            top: 50%;
            width: 1.5%;
            height: 16%;
            background: repeating-linear-gradient(
                0deg,
                #fff 0px, #fff 2px,
                #ccc 2px, #ccc 4px
            );
            border: 1px solid #666;
            transform: translateY(-50%);
        }
        .rink-goal-net.left {
            left: calc(5.5% - 1.5%);
            border-radius: 3px 0 0 3px;
        }
        .rink-goal-net.right {
            right: calc(5.5% - 1.5%);
            border-radius: 0 3px 3px 0;
        }

        /* Center logo - fills the center faceoff circle */
        .rink-center-logo {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 16%;
            height: auto;
            max-height: 80%;
            transform: translate(-50%, -50%);
            z-index: 1;
            opacity: 0.5;
            border-radius: 50%;
            object-fit: contain;
        }

        .shot-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.9;
            transition: all 0.15s;
            z-index: 5;
            font-family: 'Rajdhani', sans-serif;
            font-size: 8px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        .shot-dot:hover {
            transform: translate(-50%, -50%) scale(2);
            opacity: 1;
            z-index: 10;
        }

        .shot-dot.utah { background: var(--mammoth-blue); box-shadow: 0 0 2px rgba(0,0,0,0.4); }
        .shot-dot.opp { background: #f44336; box-shadow: 0 0 2px rgba(0,0,0,0.4); }
        .shot-dot.goal {
            background: #FFD700 !important;
            border: 2px solid #fff;
            width: 14px;
            height: 14px;
            box-shadow: 0 0 6px #FFD700;
            color: #000;
            z-index: 9 !important;
            font-size: 9px;
            text-shadow: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .shot-dot.goal:hover {
            box-shadow: 0 0 12px #FFD700, 0 0 20px rgba(255, 215, 0, 0.5);
            transform: translate(-50%, -50%) scale(1.4);
            z-index: 11 !important;
        }

        .shot-dot.in-circle {
            border: 1px solid #fff;
        }

        /* Goalie Indicator on Ice */
        .goalie-indicator {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            z-index: 4;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid #fff;
            box-shadow: 0 0 8px rgba(0,0,0,0.6);
            overflow: hidden;
        }

        .goalie-indicator img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .goalie-indicator.utah {
            box-shadow: 0 0 12px rgba(105, 179, 231, 0.8);
        }

        .goalie-indicator.opp {
            box-shadow: 0 0 12px rgba(244, 67, 54, 0.8);
        }

        .goalie-indicator:hover {
            transform: scale(1.4);
            z-index: 11;
            box-shadow: 0 0 16px rgba(255, 215, 0, 0.6);
        }

        /* Goalie Stats Popup */
        .goalie-stats-popup {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #FFD700;
            border-radius: 8px;
            padding: 12px 14px;
            color: #fff;
            font-size: 11px;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            animation: popupFadeIn 0.15s ease;
        }

        .goalie-stats-popup-name {
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 2px;
        }

        .goalie-stats-popup-sv {
            color: #aaa;
            font-size: 10px;
        }

        .goal-popup {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #FFD700;
            border-radius: 8px;
            padding: 12px 16px;
            color: #fff;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            animation: popupFadeIn 0.15s ease;
        }

        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .goal-popup-scorer {
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 4px;
        }

        .goal-popup-assist {
            color: #aaa;
            font-size: 11px;
        }

        .season-note {
            font-size: 9px;
            color: #888;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Fastest Shots */
        .fastest-shots-card {
            padding: 0;
        }

        .fastest-shots-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .fastest-shot-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .fastest-shot-item:last-child {
            margin-bottom: 0;
        }

        .fastest-shot-item.utah {
            border-left: 3px solid var(--mammoth-blue);
        }

        .fastest-shot-item.opp {
            border-left: 3px solid #f44336;
        }

        .fastest-shot-rank {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #555;
            min-width: 18px;
        }

        .fastest-shot-speed {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            min-width: 55px;
        }

        .fastest-shot-speed .unit {
            font-size: 10px;
            color: #888;
            font-weight: 400;
        }

        .fastest-shot-player {
            flex: 1;
            font-size: 11px;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fastest-shot-player .team {
            font-size: 9px;
            color: #666;
        }

        .no-shot-data {
            font-size: 11px;
            color: #666;
            text-align: center;
            padding: 10px;
        }

        .goal-light {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #f44336;
            border-radius: 50%;
            margin-left: 5px;
            animation: goal-flash 0.6s ease-in-out infinite;
            box-shadow: 0 0 6px #f44336;
        }

        @keyframes goal-flash {
            0%, 100% { opacity: 1; box-shadow: 0 0 6px #f44336; }
            50% { opacity: 0.4; box-shadow: 0 0 2px #f44336; }
        }

        /* Skating Speed Card */
        .skating-speed-card {
            padding: 5px;
        }

        .skating-speed-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            margin-bottom: 3px;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
            font-size: 11px;
        }

        .skating-speed-item.utah {
            border-left: 2px solid var(--mammoth-blue);
        }

        .skating-speed-item.opp {
            border-left: 2px solid #888;
        }

        .skating-speed-rank {
            width: 18px;
            color: #666;
            font-weight: 600;
        }

        .skating-speed-value {
            font-weight: 700;
            color: #4CAF50;
            min-width: 70px;
        }

        .skating-speed-value .unit {
            font-size: 9px;
            color: #888;
            font-weight: 400;
        }

        .skating-speed-player {
            flex: 1;
            color: #ccc;
        }

        .skating-speed-player .team {
            font-size: 9px;
            color: #666;
        }

        /* Time on Ice Card */
        .toi-card {
            padding: 5px;
        }

        .toi-team-section {
            margin-bottom: 8px;
        }

        .toi-team-header {
            font-size: 10px;
            font-weight: 600;
            color: var(--mammoth-blue);
            margin-bottom: 4px;
            padding-left: 4px;
        }

        .toi-team-header.opp {
            color: #888;
        }

        .toi-item {
            display: flex;
            align-items: center;
            padding: 3px 6px;
            margin-bottom: 2px;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
            font-size: 10px;
        }

        .toi-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 6px;
            object-fit: cover;
        }

        .toi-item .player-info {
            flex: 1;
            overflow: hidden;
        }

        .toi-item .player-name {
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toi-item .player-pos {
            font-size: 9px;
            color: #666;
        }

        .toi-item .toi-value {
            font-weight: 700;
            color: var(--mammoth-accent);
            min-width: 40px;
            text-align: right;
        }

        /* Compact Goalie Stats */
        .goalie-stats-card {
            padding: 0;
            margin-bottom: 12px;
        }

        .goalie-stats-header {
            margin-bottom: 6px;
        }

        .goalie-stats-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            text-transform: uppercase;
        }

        .goalie-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .goalie-card {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }

        .goalie-card.utah {
            border-left: 3px solid var(--mammoth-blue);
        }

        .goalie-card img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .goalie-info {
            flex: 1;
            min-width: 0;
        }

        .goalie-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .goalie-number {
            font-size: 9px;
            color: #888;
        }

        .goalie-stat-row {
            display: flex;
            gap: 6px;
            margin-top: 3px;
        }

        .goalie-stat {
            text-align: center;
        }

        .goalie-stat-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
        }

        .goalie-stat-value.highlight {
            color: var(--mammoth-blue);
        }

        .goalie-stat-label {
            font-size: 7px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Fit on MacBook Pro 16" and iPad Pro 12" without scrolling */
        @media (max-height: 900px) {
            .scoreboard {
                padding: 15px 20px;
            }
            .scoreboard-main {
                margin: 10px 0;
            }
            .team-logo {
                width: 80px;
                height: 80px;
            }
            .score {
                font-size: 56px;
            }
            .team-name {
                font-size: 22px;
            }
            .pp-indicator {
                padding: 4px 8px;
            }
            .pp-indicator-text {
                font-size: 10px;
            }
            .rink-stats-layout {
                grid-template-columns: 160px 1fr 160px;
                gap: 10px;
            }
            .team-stat-item {
                padding: 8px 10px;
            }
            .team-stat-item .stat-value {
                font-size: 18px;
            }
            .penalty-box {
                padding: 8px 10px;
                min-height: 60px;
            }
            .goalie-compact {
                padding: 8px 10px;
            }
            .goalie-compact-img {
                width: 30px;
                height: 30px;
            }
            .shot-chart-rink {
                max-width: 350px;
            }
            .rink-center-card {
                padding: 8px;
            }
        }

        @media (max-width: 1024px) {
            .rink-stats-layout {
                grid-template-columns: 150px 1fr 150px;
                gap: 8px;
            }
            .team-stat-item .stat-value {
                font-size: 18px;
            }
            .goalie-compact-name {
                font-size: 12px;
            }
            .goalie-compact-sv {
                font-size: 14px;
            }
        }

        @media (max-width: 768px) {
            .rink-stats-layout {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .rink-center {
                order: -1;
            }
            .shot-chart-rink-area {
                max-width: 100%;
            }
            .shot-chart-rink {
                max-width: 100%;
            }
            .team-stats-columns-mobile {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .team-stats-column.opp .team-stat-item,
            .team-stats-column.opp .penalty-box,
            .team-stats-column.opp .goalie-compact {
                text-align: left;
                border-right: none;
                border-left: 3px solid var(--opp-color, #888);
            }
            .team-stats-column.opp .goalie-compact {
                flex-direction: row;
            }
            .goalie-container {
                flex-direction: row;
            }
            .goalie-card {
                flex: 1;
            }
        }

        @media (max-width: 600px) {
            .goalie-container {
                flex-direction: column;
            }
            .team-stat-item .stat-value {
                font-size: 16px;
            }
            .goalie-compact-name {
                font-size: 11px;
            }
            .goalie-compact-sv {
                font-size: 13px;
            }
        }

        /* Past Game Selector */
        .past-game-section {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .past-game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .past-game-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            text-transform: uppercase;
        }

        .past-game-select {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--concrete);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            cursor: pointer;
            min-width: 200px;
        }

        .past-game-select:focus {
            outline: none;
            border-color: var(--mammoth-blue);
        }

        .past-game-card {
            display: none;
        }

        .past-game-card.active {
            display: block;
        }

        .past-game-matchup {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px 0;
            border-bottom: 1px solid var(--concrete);
            margin-bottom: 15px;
        }

        .past-game-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .past-game-team img {
            width: 60px;
            height: 60px;
        }

        .past-game-team-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .past-game-score {
            font-family: 'Rajdhani', sans-serif;
            font-size: 42px;
            font-weight: 700;
        }

        .past-game-score.winner {
            color: var(--mammoth-blue);
        }

        .past-game-vs {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            color: #555;
        }

        .past-game-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .past-game-stat {
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .past-game-stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .past-game-stat-values {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .past-game-stat-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            font-weight: 700;
        }

        .past-game-stat-value.utah { color: var(--mammoth-blue); }

        /* Stats Grid */
        /* Stats Row - grid with rotating card */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 1100px) {
            .stats-row {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 25px;
        }

        .stat-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 22px;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .stat-comparison {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 38px;
            font-weight: 700;
        }

        .utah-stat {
            color: var(--mammoth-blue);
        }

        .stat-bar-container {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--mammoth-blue), var(--mammoth-accent));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .stat-subtext {
            font-size: 13px;
            color: #aaa;
            margin-top: 10px;
            letter-spacing: 1px;
        }

        .shots-by-period {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .shots-pill {
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            padding: 8px 10px;
            text-align: center;
            background: rgba(255,255,255,0.03);
        }

        .shots-pill .label {
            font-size: 11px;
            letter-spacing: 2px;
            color: #888;
            text-transform: uppercase;
        }

        .shots-pill .nums {
            margin-top: 4px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            font-weight: 800;
        }

        .penalty-list {
            margin-top: 10px;
            display: grid;
            gap: 8px;
            max-height: 170px;
            overflow: auto;
            padding-right: 6px;
        }

        .penalty-item {
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 10px;
            padding: 8px 10px;
            background: rgba(255,255,255,0.03);
        }

        .penalty-headshot {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.15);
            flex: 0 0 auto;
        }

        .penalty-meta {
            min-width: 0;
        }

        .penalty-meta .who {
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .penalty-meta .what {
            font-size: 12px;
            color: #aaa;
            margin-top: 2px;
        }

        .penalty-time {
            margin-left: auto;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 800;
            color: var(--mammoth-accent);
            white-space: nowrap;
        }

        .three-stars {
            margin-top: 20px;
            margin-bottom: 30px;
            border: 2px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 18px;
            background: rgba(255,255,255,0.03);
        }

        .three-stars-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--mammoth-accent);
            text-align: center;
            margin-bottom: 12px;
        }

        .stars-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .star-card {
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.25);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .star-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: var(--star-team-logo);
            background-size: 80%;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.12;
            z-index: 0;
        }

        .star-card > * {
            position: relative;
            z-index: 1;
        }

        .star-card img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--star-team-color, var(--mammoth-blue));
            margin: 6px auto 10px;
        }

        .star-rank {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 900;
            letter-spacing: 2px;
            color: #ddd;
        }

        .star-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            font-weight: 800;
            margin-top: 6px;
        }

        .star-stats {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 800;
            color: var(--mammoth-accent);
            margin-top: 6px;
        }

        @media (max-width: 900px) {
            .stars-grid {
                grid-template-columns: 1fr;
            }
        }

        /* PLAYER STATS STYLES */
        .player-stats-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .team-panel {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 18px;
        }

        .team-panel.utah {
            border-color: var(--mammoth-blue);
            box-shadow: 0 0 20px rgba(105, 179, 231, 0.15);
        }

        .team-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(255,255,255,0.06);
        }

        .team-panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .team-panel-logo {
            width: 34px;
            height: 34px;
            flex: 0 0 auto;
        }

        .team-panel-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .team-panel-subtitle {
            font-size: 12px;
            color: #888;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .player-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 14px;
        }

        .player-table th {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #888;
            text-align: left;
            padding: 10px 8px;
            border-bottom: 2px solid rgba(255,255,255,0.06);
            text-transform: uppercase;
            white-space: nowrap;
        }

        .player-table td {
            padding: 9px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
            font-size: 16px;
        }

        .player-table tr:nth-child(even) {
            background: rgba(255,255,255,0.02);
        }

        .player-table .num {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-align: center;
            width: 52px;
            color: var(--mammoth-accent);
        }

        .player-table .stat {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-align: center;
            width: 56px;
        }

        .player-table .toi {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-align: center;
            width: 70px;
            color: #ddd;
        }

        .player-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .player-headshot {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.15);
            object-fit: cover;
            flex: 0 0 auto;
        }

        .player-name-text {
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-section-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            margin: 10px 0 8px;
        }

        @media (max-width: 900px) {
            .player-stats-columns {
                grid-template-columns: 1fr;
            }
        }

        /* Legacy player card styles (kept for fallback/older rendering) */
        .player-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .player-card:hover {
            border-color: var(--mammoth-blue);
            box-shadow: 0 8px 20px rgba(105, 179, 231, 0.2);
        }

        .player-card .player-headshot {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--mammoth-blue);
            object-fit: cover;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--mammoth-blue);
            margin-bottom: 5px;
        }

        .player-position {
            font-size: 14px;
            color: #888;
            letter-spacing: 1px;
        }

        .player-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 3px;
        }

        .stat-number {
            font-family: 'Rajdhani', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--mammoth-accent);
        }

        /* PLAY-BY-PLAY STYLES */
        .play-feed {
            max-height: 800px;
            overflow-y: auto;
        }

        .play-item {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-left: 4px solid var(--mammoth-accent);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .play-item.goal {
            border-left-color: var(--mammoth-blue);
            background: linear-gradient(145deg, rgba(105, 179, 231, 0.1) 0%, rgba(105, 179, 231, 0.05) 100%);
        }

        .play-time {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            color: var(--mammoth-accent);
            margin-bottom: 8px;
        }

        .play-description {
            font-size: 18px;
            line-height: 1.6;
        }

        /* Play-by-Play 4-Column Highlights Box */
        .pbp-highlights-box {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .highlights-column {
            min-height: 80px;
        }

        .highlights-column-header {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 12px 10px 10px 10px;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--concrete);
            text-align: center;
            color: var(--column-team-color, #888);
            border-bottom-color: var(--column-team-color, #888);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.3), inset 0 0 8px rgba(255, 255, 255, 0.05);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.4), 0 0 12px var(--column-team-color, rgba(255, 255, 255, 0.2));
        }

        .highlights-column-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .highlight-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            font-size: 12px;
            border-left: 3px solid var(--column-team-color, #888);
        }

        .highlight-item.penalty {
            border-left-color: #c41e3a;
        }

        .highlight-player-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .highlight-headshot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--column-team-color, #888);
            flex-shrink: 0;
        }

        .highlight-team-logo {
            width: 18px;
            height: 18px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .highlight-player {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 13px;
            color: #fff;
        }

        .highlight-details {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 34px;
        }

        .highlight-time {
            font-size: 11px;
            color: #888;
        }

        .highlight-info {
            font-size: 11px;
            color: #aaa;
        }

        .highlight-type {
            font-size: 10px;
            font-weight: 700;
            color: #ffd700;
            text-transform: uppercase;
        }

        .no-highlights {
            text-align: center;
            color: #555;
            font-size: 14px;
            padding: 10px;
        }

        @media (max-width: 900px) {
            .pbp-highlights-box {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .pbp-highlights-box {
                grid-template-columns: 1fr;
            }
        }

        .pbp-other-plays {
            margin-top: 20px;
        }

        .pbp-section-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* SCHEDULE STYLES */
        .schedule-section {
            margin-bottom: 40px;
        }

        .section-header {
            font-family: 'Rajdhani', sans-serif;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 3px;
            color: var(--mammoth-blue);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--concrete);
            text-transform: uppercase;
        }

        .game-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
        }

        .game-card.current {
            border-color: var(--mammoth-blue);
            box-shadow: 0 0 30px var(--led-glow);
        }

        .game-date {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            color: #888;
            min-width: 150px;
        }

        .game-teams {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }

        .game-team {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .game-team-logo {
            width: 50px;
            height: 50px;
        }

        .game-team-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 24px;
            font-weight: 700;
        }

        .game-score {
            font-family: 'Rajdhani', sans-serif;
            font-size: 36px;
            font-weight: 700;
            min-width: 100px;
            text-align: center;
        }

        .game-status-badge {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            padding: 8px 20px;
            background: var(--concrete);
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .game-status-badge.live {
            background: var(--mammoth-accent);
            color: var(--stadium-black);
            animation: pulse 2s ease infinite;
        }

        /* Schedule Mobile Styles */
        @media (max-width: 768px) {
            .game-card {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
                text-align: center;
            }
            .game-date {
                min-width: auto;
                font-size: 14px;
            }
            .game-teams {
                flex-direction: column;
                gap: 10px;
            }
            .game-team {
                gap: 10px;
            }
            .game-team-logo {
                width: 40px;
                height: 40px;
            }
            .game-team-name {
                font-size: 18px;
            }
            .game-score {
                font-size: 28px;
                min-width: auto;
            }
            .game-status-badge {
                font-size: 12px;
                padding: 6px 12px;
            }
            .section-header {
                font-size: 22px;
                letter-spacing: 1px;
            }
        }

        /* STANDINGS STYLES */
        .standings-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 0 0 25px;
            flex-wrap: wrap;
        }

        .standings-toggle {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 10px 18px;
            background: linear-gradient(145deg, var(--metal) 0%, var(--concrete) 100%);
            border: 2px solid var(--concrete);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            text-transform: uppercase;
        }

        .standings-toggle.active {
            background: linear-gradient(145deg, var(--mammoth-dark-blue) 0%, var(--mammoth-blue) 100%);
            border-color: var(--mammoth-accent);
            box-shadow: 0 0 20px var(--led-glow);
        }

        .standings-conference {
            margin-bottom: 50px;
        }

        .standings-section-header {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #ddd;
            margin: 10px 0 18px;
            text-align: center;
        }

        .conference-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 38px;
            font-weight: 700;
            letter-spacing: 3px;
            color: var(--team-color-text, var(--mammoth-blue));
            margin-bottom: 30px;
            text-align: center;
            text-transform: uppercase;
        }

        .division {
            margin-bottom: 40px;
        }

        .division-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--concrete);
            text-transform: uppercase;
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .standings-table th {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #888;
            text-align: left;
            padding: 15px 10px;
            border-bottom: 2px solid var(--concrete);
            text-transform: uppercase;
        }

        .standings-table td {
            padding: 15px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .standings-table tr:hover {
            background: rgba(105, 179, 231, 0.05);
        }

        .standings-table tr.utah-row {
            background: linear-gradient(90deg, rgba(105, 179, 231, 0.15) 0%, transparent 100%);
            border-left: 4px solid var(--mammoth-blue);
        }

        .standings-table tr.playoff-spot {
            background: linear-gradient(90deg, rgba(105, 179, 231, 0.08) 0%, transparent 100%);
        }

        .standings-table tr.wildcard-spot {
            background: linear-gradient(90deg, rgba(255, 184, 28, 0.08) 0%, transparent 100%);
        }

        .playoff-line {
            border-top: 3px dashed var(--mammoth-blue) !important;
        }

        .wildcard-line {
            border-top: 3px dashed var(--mammoth-accent) !important;
        }

        .standings-rank {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--mammoth-accent);
            min-width: 40px;
        }

        .playoff-badge {
            display: inline-block;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .playoff-badge.clinched {
            background: var(--team-color-text, var(--mammoth-blue));
            color: var(--stadium-black);
        }

        .playoff-badge.wildcard {
            background: var(--mammoth-accent);
            color: var(--stadium-black);
        }

        .playoff-badge.in-race {
            background: var(--concrete);
            color: #888;
        }

        .standings-team {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .standings-logo {
            width: 30px;
            height: 30px;
        }

        .standings-team-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 600;
        }

        .team-stat-num {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        /* Standings Mobile Styles */
        @media (max-width: 768px) {
            .standings-table {
                font-size: 12px;
            }
            .standings-table th {
                font-size: 10px;
                padding: 8px 4px;
                letter-spacing: 0;
            }
            .standings-table td {
                padding: 10px 4px;
            }
            .standings-logo {
                width: 22px;
                height: 22px;
            }
            .standings-team {
                gap: 8px;
            }
            .standings-team-name {
                font-size: 13px;
                max-width: 80px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .standings-rank {
                font-size: 12px;
                min-width: 20px;
            }
            .team-stat-num {
                font-size: 12px;
            }
            .conference-name {
                font-size: 24px;
            }
            .division-name {
                font-size: 18px;
            }
            .standings-section-header {
                font-size: 16px;
            }
            .standings-controls {
                gap: 5px;
            }
            .standings-toggle {
                font-size: 12px;
                padding: 8px 12px;
            }
            /* Hide less important columns on mobile */
            .standings-table th:nth-child(n+6),
            .standings-table td:nth-child(n+6) {
                display: none;
            }
        }

        /* Player Stats Mobile Styles */
        @media (max-width: 768px) {
            .player-table th {
                font-size: 10px;
                padding: 6px 4px;
                letter-spacing: 0;
            }
            .player-table td {
                padding: 6px 4px;
                font-size: 12px;
            }
            .player-table .num {
                width: 30px;
                font-size: 11px;
            }
            .player-table .stat {
                width: 32px;
                font-size: 11px;
            }
            .player-table .toi {
                width: 40px;
                font-size: 11px;
            }
            .player-headshot {
                width: 24px;
                height: 24px;
            }
            .player-name-cell {
                gap: 6px;
            }
            .player-name-text {
                font-size: 11px;
            }
            /* Hide some columns on mobile */
            .player-table th:nth-child(n+7),
            .player-table td:nth-child(n+7) {
                display: none;
            }
        }

        /* Play-by-Play Mobile Styles */
        @media (max-width: 768px) {
            .play-feed {
                max-height: none;
            }
            .play-item {
                padding: 12px;
                margin-bottom: 10px;
            }
            .play-time {
                font-size: 12px;
            }
            .play-description {
                font-size: 14px;
            }
        }

        /* Roster Mobile Styles */
        @media (max-width: 768px) {
            .roster-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .roster-card {
                padding: 12px;
            }
            .roster-headshot {
                width: 60px;
                height: 60px;
            }
            .roster-number {
                font-size: 22px;
            }
            .roster-name {
                font-size: 14px;
            }
            .roster-position {
                font-size: 11px;
            }
            .roster-section-title {
                font-size: 18px;
            }
        }

        /* Bracket Mobile Styles */
        @media (max-width: 768px) {
            .bracket-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .bracket-header {
                font-size: 24px;
            }
            .bracket-subtitle {
                font-size: 12px;
            }
        }

        /* Past Games Mobile Styles */
        @media (max-width: 768px) {
            .past-game-matchup {
                flex-direction: column;
                gap: 15px;
            }
            .past-game-team img {
                width: 40px;
                height: 40px;
            }
            .past-game-team-name {
                font-size: 12px;
            }
            .past-game-score {
                font-size: 32px;
            }
            .past-game-vs {
                font-size: 14px;
            }
            .past-game-stats {
                flex-direction: column;
                gap: 8px;
            }
            .past-game-stat {
                min-width: auto;
            }
            .past-game-select {
                min-width: auto;
                width: 100%;
                font-size: 12px;
            }
            .past-game-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
        }

        /* Last Updated */
        .last-updated {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 13px;
            color: #666;
            background: rgba(10,10,10,0.9);
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--concrete);
            z-index: 100;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 100px 20px;
        }

        .spinner {
            border: 6px solid var(--concrete);
            border-left-color: var(--mammoth-blue);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--stadium-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--mammoth-blue);
            border-radius: 5px;
        }

        /* MOBILE RESPONSIVE STYLES */
        @media (max-width: 900px) {
            .scoreboard {
                padding: 20px 15px;
            }

            .scoreboard-main {
                gap: 10px;
            }

            .team-side {
                gap: 8px;
            }

            .team-logo {
                width: 60px;
                height: 60px;
            }

            .pp-indicator {
                padding: 3px 6px;
            }

            .pp-indicator-text {
                font-size: 9px;
            }

            .team-name {
                font-size: 18px;
            }

            .team-record {
                font-size: 11px;
            }

            .team-info {
                min-width: 70px;
            }

            .score {
                font-size: 48px;
                min-width: 40px;
            }

            .game-center {
                padding: 0 12px;
                min-width: 70px;
            }

            .clock {
                font-size: 24px;
            }

            .period {
                font-size: 12px;
            }

            .game-status {
                font-size: 18px;
                margin-bottom: 15px;
            }

            .live-badge {
                top: 10px;
                right: 10px;
                padding: 5px 8px;
                font-size: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .scoreboard-main {
                flex-wrap: wrap;
                justify-content: center;
            }

            .team-side {
                flex-basis: 45%;
                justify-content: center;
            }

            .utah-side {
                order: 1;
                flex-direction: column;
                text-align: center;
            }

            .game-center {
                order: 2;
                flex-basis: 100%;
                border: none;
                border-top: 1px solid var(--concrete);
                border-bottom: 1px solid var(--concrete);
                padding: 10px 0;
                margin: 10px 0;
            }

            .opp-side {
                order: 3;
                flex-direction: column-reverse;
                text-align: center;
            }

            .team-logo {
                width: 60px;
                height: 60px;
            }

            .score {
                font-size: 56px;
            }

            .team-name {
                font-size: 20px;
            }

            .last-meeting {
                font-size: 11px;
            }
        }

        /* ROSTER & MODAL STYLES */
        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 30px;
        }

        .roster-section-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--mammoth-accent);
            margin: 30px 0 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--concrete);
            text-transform: uppercase;
        }

        .roster-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 2px solid var(--concrete);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .roster-card:hover {
            border-color: var(--mammoth-blue);
            box-shadow: 0 8px 20px rgba(105, 179, 231, 0.3);
            transform: translateY(-5px);
        }

        .roster-headshot {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--mammoth-blue);
            margin: 0 auto 12px;
            object-fit: cover;
        }

        .roster-number {
            font-family: 'Rajdhani', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--mammoth-blue);
            line-height: 1;
        }

        .roster-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 18px;
            font-weight: 700;
            margin: 8px 0 4px;
        }

        .roster-position {
            font-size: 13px;
            color: #888;
            letter-spacing: 1px;
        }

        /* EDGE Speed Stats Section */
        .edge-stats-section {
            background: linear-gradient(145deg, rgba(105, 179, 231, 0.1), rgba(26, 77, 122, 0.2));
            border: 2px solid var(--mammoth-blue);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .edge-stats-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            text-align: center;
        }

        .edge-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .edge-stat-card {
            background: linear-gradient(145deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edge-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(105, 179, 231, 0.3);
        }

        .edge-stat-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .edge-stat-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--mammoth-blue);
            line-height: 1;
            margin-bottom: 5px;
        }

        .edge-stat-unit {
            font-size: 14px;
            color: #aaa;
        }

        .edge-stat-player {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .edge-stat-headshot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--mammoth-blue);
            object-fit: cover;
        }

        .edge-stat-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .edge-stat-percentile {
            font-size: 11px;
            color: #4CAF50;
            margin-top: 4px;
        }

        .edge-stats-loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        @media (max-width: 600px) {
            .edge-stats-grid {
                grid-template-columns: 1fr;
            }
            .edge-stat-value {
                font-size: 28px;
            }
        }

        .player-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .player-modal-content {
            background: linear-gradient(145deg, var(--stadium-dark), var(--stadium-darker));
            border: 3px solid var(--mammoth-blue);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            padding: 40px;
            position: relative;
            box-shadow: 0 20px 60px rgba(105, 179, 231, 0.4);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 36px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #555;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .modal-close:hover,
        .modal-close:active {
            color: var(--mammoth-blue);
            border-color: var(--mammoth-blue);
            background: rgba(105, 179, 231, 0.2);
        }

        @media (max-width: 600px) {
            .modal-close {
                width: 60px;
                height: 60px;
                font-size: 40px;
                top: 5px;
                right: 5px;
            }
            .player-modal-content {
                padding: 20px;
                padding-top: 70px;
            }
        }

        .modal-player-header {
            display: flex;
            gap: 25px;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 2px solid var(--concrete);
        }

        .modal-player-photo {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            border: 4px solid var(--mammoth-blue);
            object-fit: cover;
        }

        .modal-player-info h2 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 38px;
            font-weight: 700;
            color: var(--mammoth-blue);
            margin-bottom: 10px;
        }

        .modal-player-details {
            font-size: 15px;
            color: #aaa;
            line-height: 1.7;
        }

        .modal-stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .modal-stat {
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--concrete);
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .modal-stat:hover {
            border-color: var(--mammoth-blue);
            background: rgba(105, 179, 231, 0.08);
        }

        .modal-stat-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .modal-stat-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--mammoth-blue);
        }

        .video-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .video-modal-content {
            background: linear-gradient(145deg, var(--stadium-dark), var(--stadium-darker));
            border: 3px solid var(--mammoth-blue);
            border-radius: 16px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            padding: 40px;
            position: relative;
            box-shadow: 0 20px 60px rgba(105, 179, 231, 0.4);
            animation: modalSlideIn 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .video-modal-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--mammoth-blue);
            text-align: center;
            text-transform: uppercase;
            margin-bottom: 25px;
            letter-spacing: 2px;
        }

        #videoIframeWrap {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 8px;
            background: rgba(0,0,0,0.4);
        }

        #videoIframeWrap iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        #goalVideoWrap {
            position: relative;
            width: 100%;
            min-height: 500px;
            height: 100%;
            flex: 1;
            overflow: hidden;
            border-radius: 8px;
            background: rgba(0,0,0,0.4);
        }

        #goalVideoWrap iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .video-no-content {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 16px;
            line-height: 1.6;
        }

        @media (max-width: 600px) {
            .video-modal-content {
                padding: 20px;
                padding-top: 70px;
            }

            .video-modal-title {
                font-size: 20px;
            }
        }

        /* BRACKET STYLES */
        .bracket-container {
            padding: 20px;
            overflow-x: auto;
        }

        .bracket-header {
            font-family: 'Rajdhani', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--mammoth-blue);
            text-align: center;
            margin-bottom: 5px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .bracket-subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .bracket-table {
            margin: 0 auto;
            border-collapse: separate;
            border-spacing: 8px 0;
        }

        .bracket-table td {
            vertical-align: middle;
            padding: 0;
        }

        .bracket-table .conf-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: var(--mammoth-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px 5px;
            text-align: center;
        }

        .bracket-table .west-label {
            transform: rotate(180deg);
        }

        .bracket-round {
            display: block;
            padding: 5px;
        }

        .bracket-round .matchup {
            display: block;
            margin: 0 0 12px 0;
            clear: both;
        }

        .bracket-round .matchup:last-child {
            margin-bottom: 0;
        }

        .matchup {
            display: block;
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 2px solid var(--concrete);
            border-radius: 6px;
            padding: 5px;
            width: 115px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .matchup:hover {
            border-color: var(--mammoth-blue);
            box-shadow: 0 4px 12px rgba(105, 179, 231, 0.3);
        }

        .matchup.tbd {
            border-style: dashed;
            opacity: 0.5;
        }

        .matchup-team {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 5px;
            margin: 2px 0;
            background: rgba(255,255,255,0.03);
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .matchup-team.utah {
            background: linear-gradient(90deg, rgba(105, 179, 231, 0.25), rgba(105, 179, 231, 0.08));
            border-left: 2px solid var(--mammoth-blue);
            box-shadow: 0 0 8px rgba(105, 179, 231, 0.3);
        }

        .matchup-team.tbd-team {
            opacity: 0.4;
        }

        .matchup.series-active {
            border-color: var(--mammoth-blue);
            box-shadow: 0 0 12px rgba(105, 179, 231, 0.3);
        }

        .matchup.series-complete {
            opacity: 0.85;
        }

        .matchup-team.series-winner {
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.25), rgba(76, 175, 80, 0.08));
            border-left: 2px solid #4CAF50;
        }

        .matchup-team.series-winner .matchup-team-name {
            color: #4CAF50;
        }

        .series-wins {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 12px;
            color: var(--mammoth-accent);
            margin-left: auto;
        }

        .matchup-logo {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .matchup-seed {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 10px;
            color: var(--mammoth-accent);
            min-width: 12px;
            text-align: center;
        }

        .matchup-info {
            flex: 1;
            min-width: 0;
        }

        .matchup-team-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 10px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .matchup-record {
            font-size: 8px;
            color: #888;
        }

        .connector-cell {
            width: 15px;
            text-align: center;
            color: var(--concrete);
        }

        .stanley-cup-cell {
            text-align: center;
            padding: 0 15px !important;
        }

        .stanley-cup-trophy {
            font-size: 36px;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 12px rgba(255, 184, 28, 0.5));
        }

        .stanley-cup-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            font-weight: 700;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .final-matchup {
            width: 115px;
            margin: 0 auto;
        }

        .vs-divider {
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 9px;
            color: #666;
            padding: 2px 0;
        }

        /* Responsive */
        @media (max-width: 1000px) {
            .bracket-table {
                transform: scale(0.85);
                transform-origin: top center;
            }
        }

        @media (max-width: 800px) {
            .bracket-table {
                transform: scale(0.7);
                transform-origin: top center;
            }
        }

        /* Pregame News Snippet (on Scoreboard) */
        #pregameSnippet {
            background: linear-gradient(135deg, rgba(26, 77, 122, 0.6) 0%, rgba(26, 77, 122, 0.3) 100%);
            border: 2px solid var(--mammoth-blue);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            color: #fff;
            display: none;
        }

        #pregameSnippet.show {
            display: block;
        }

        .snippet-label {
            font-size: 12px;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .snippet-headline {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.4;
            margin-bottom: 10px;
            color: #fff;
        }

        .snippet-description {
            font-size: 14px;
            line-height: 1.5;
            color: #ccc;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .snippet-open-btn {
            background: var(--mammoth-blue);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .snippet-open-btn:hover {
            background: var(--mammoth-accent);
            transform: translateY(-2px);
        }

        /* Game News Page */
        .gamenews-card {
            background: linear-gradient(135deg, rgba(26, 77, 122, 0.5) 0%, rgba(26, 77, 122, 0.2) 100%);
            border: 1px solid rgba(105, 179, 231, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            color: #fff;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gamenews-card:hover {
            background: linear-gradient(135deg, rgba(26, 77, 122, 0.7) 0%, rgba(26, 77, 122, 0.4) 100%);
            border-color: var(--mammoth-blue);
            transform: translateY(-2px);
        }

        .gamenews-type {
            display: inline-block;
            font-size: 11px;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .gamenews-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }

        .gamenews-headline {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.4;
            margin-bottom: 8px;
            color: #fff;
        }

        .gamenews-subhead {
            font-size: 14px;
            font-weight: 500;
            color: #ddd;
            margin-bottom: 10px;
        }

        .gamenews-description {
            font-size: 14px;
            line-height: 1.5;
            color: #bbb;
        }

        .gamenews-empty {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 16px;
        }

        /* Hide news tabs on TV mode */
        @media (max-width: 600px) {
            .gamenews-nav {
                display: none !important;
            }
        }

        /* TV mode hides news */
        body.tv-mode .gamenews-nav,
        body.tv-mode .gamenews-nav-mobile {
            display: none !important;
        }

        /* Goal Videos Section */
        #goalVideosSection {
            margin-top: 30px;
            border-top: 2px solid rgba(105, 179, 231, 0.3);
            padding-top: 20px;
        }

        .goal-videos-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--mammoth-accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .goal-videos-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .goal-video-card {
            background: rgba(26, 77, 122, 0.3);
            border: 1px solid rgba(105, 179, 231, 0.3);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .goal-video-card:hover {
            background: rgba(26, 77, 122, 0.5);
            border-color: var(--mammoth-blue);
            transform: translateY(-4px);
        }

        .goal-video-embed {
            width: 100%;
            height: 200px;
            background: #000;
        }

        .goal-video-info {
            padding: 15px;
        }

        .goal-scorer-name {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }

        .goal-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }

        .goal-teams {
            font-size: 13px;
            color: #ccc;
        }

        .goal-no-videos {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
     <div class="goal-banner" id="goalBanner">
         <div class="goal-banner-main">
             <span id="goalBannerText">GOAL</span>
             <span class="goal-team" id="goalBannerTeam"></span>
         </div>
         <div class="goal-banner-detail" id="goalBannerDetail"></div>
     </div>

     <div class="venue-header">
         <!-- NHL Games Ticker -->
         <div class="nhl-ticker" id="nhlTicker">
             <div class="nhl-ticker-title">Around the NHL</div>
             <div class="nhl-ticker-game" id="nhlTickerGame">
                 <div style="color: #666; font-size: 12px;">Loading...</div>
             </div>
             <div class="nhl-ticker-nav" id="nhlTickerNav"></div>
         </div>

         <div class="venue-name" id="venueName">LOADING...</div>

        <div class="venue-location" id="venueLocation">Checking for games...</div>
        <div class="game-countdown" id="gameCountdown"></div>
        <div class="countdown-timer" id="countdownTimer"></div>
    </div>

    <!-- Mobile Hamburger Menu -->
    <div class="hamburger-menu" id="hamburgerMenu" onclick="toggleMobileNav()">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
    </div>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav" id="mobileNav">
        <button class="mobile-nav-btn" onclick="mobileShowPage('scoreboard')">Scoreboard</button>
        <button class="mobile-nav-btn" onclick="toggleTvMode(); closeMobileNav();">TV Mode</button>
        <button class="mobile-nav-btn" onclick="mobileShowPage('players')">Player Stats</button>
        <button class="mobile-nav-btn" onclick="mobileShowPage('playbyplay')">Play-by-Play</button>
        <button class="mobile-nav-btn gamenews-nav-mobile" onclick="mobileShowPage('gamenews')" style="display:none;"> Game News</button>
        <button class="mobile-nav-btn" onclick="mobileShowPage('schedule')">Schedule</button>
        <button class="mobile-nav-btn" onclick="mobileShowPage('standings')">NHL Standings</button>
        <button class="mobile-nav-btn" onclick="mobileShowPage('roster')">Team Roster</button>
        <button class="mobile-nav-btn" onclick="mobileShowPage('bracket')">Playoff Bracket</button>
        <button class="mobile-nav-btn" onclick="mobileShowPage('pastgames')">Past Games</button>
        <button class="mobile-nav-btn" onclick="openHighlightsModal(); closeMobileNav();"> Highlights</button>
        <button class="mobile-nav-btn" onclick="changeTeam()" style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 20px;"> Change Team</button>
    </div>

    <div class="container">
         <div class="nav-tabs">
             <button class="nav-tab active" onclick="showPage('scoreboard')"> Scoreboard</button>
              <button class="nav-tab" onclick="toggleTvMode()"> TV Mode</button>

            <button class="nav-tab" onclick="showPage('players')"> Player Stats</button>
            <button class="nav-tab" onclick="showPage('playbyplay')"> Play-by-Play</button>
            <button class="nav-tab gamenews-nav" onclick="showPage('gamenews')" style="display:none;"> Game News</button>
            <button class="nav-tab" onclick="showPage('schedule')"> Schedule</button>
            <button class="nav-tab" onclick="showPage('standings')"> NHL Standings</button>
            <button class="nav-tab" onclick="showPage('roster')"> Team Roster</button>
            <button class="nav-tab" onclick="showPage('bracket')"> Playoff Bracket</button>
            <button class="nav-tab" onclick="showPage('pastgames')"> Past Games</button>
            <button class="nav-tab" onclick="openHighlightsModal()"> Highlights</button>
            <button class="nav-tab" onclick="changeTeam()" style="margin-left: auto;"> Change Team</button>
        </div>

        <!-- SCOREBOARD PAGE -->
        <div id="scoreboard" class="page active">
            <div class="scoreboard">
                <div class="live-badge" id="liveBadge"><span class="live-dot"></span><span id="liveBadgeText">LIVE</span></div>
                <div class="game-status" id="gameStatus">Loading...</div>

                <div class="scoreboard-main">
                    <!-- Utah Goal Scorers (Left) -->
                    <div class="goal-scorers utah-scorers" id="utahGoalScorers"></div>

                    <!-- Utah Side -->
                    <div class="team-side utah-side">
                        <div class="team-stats-inline" id="utahStatsInline">
                            <span class="inline-stat"><span class="stat-val" id="utahSogInline">-</span> SOG</span>
                            <span class="inline-stat"><span class="stat-val" id="utahHitsInline">-</span> HIT</span>
                        </div>
                        <div class="team-info">
                            <div class="team-name" id="utahName">HOME</div>
                            <div class="team-record" id="utahRecord"></div>
                        </div>
                        <div class="pp-indicator" id="utahPpIndicator">
                            <span class="pp-indicator-text">PP</span>
                        </div>
                        <img class="team-logo" id="utahLogo" src="" alt="Home Team">
                        <div class="score" id="utahScore">-</div>
                    </div>

                    <!-- Center Clock -->
                    <div class="game-center">
                        <div class="clock" id="clock">--:--</div>
                        <div class="period" id="period">-</div>
                    </div>

                    <!-- Opponent Side -->
                    <div class="team-side opp-side">
                        <div class="score" id="oppScore">-</div>
                        <img class="team-logo" id="oppLogo" src="" alt="Opponent">
                        <div class="pp-indicator" id="oppPpIndicator">
                            <span class="pp-indicator-text">PP</span>
                        </div>
                        <div class="team-info">
                            <div class="team-name" id="oppName">OPPONENT</div>
                            <div class="team-record" id="oppRecord"></div>
                        </div>
                        <div class="team-stats-inline" id="oppStatsInline">
                            <span class="inline-stat"><span class="stat-val" id="oppSogInline">-</span> SOG</span>
                            <span class="inline-stat"><span class="stat-val" id="oppHitsInline">-</span> HIT</span>
                        </div>
                    </div>

                    <!-- Opponent Goal Scorers (Right) -->
                    <div class="goal-scorers opp-scorers" id="oppGoalScorers"></div>
                </div>

                <!-- Combined Info Row: Recent Plays | Last Meeting | Top Player -->
                <div class="scoreboard-info-row">
                    <!-- Recent Plays -->
                    <div class="info-box recent-plays-box">
                        <div class="info-box-title">Recent Plays</div>
                        <div id="recentPlays">
                            <div class="recent-play-item"><span class="recent-play-desc">Waiting for game...</span></div>
                        </div>
                    </div>

                    <!-- Last Meeting -->
                    <div class="info-box last-meeting-box">
                        <div class="info-box-title">Last Meeting</div>
                        <div class="last-meeting-content" id="lastMeeting">-</div>
                    </div>

                    <!-- Top Player -->
                    <div class="info-box top-player-box" id="topPlayerBox">
                        <div class="info-box-title">Top Player</div>
                        <div class="top-player-content">
                            <img id="pogHeadshot" src="" alt="" onerror="this.style.display='none'">
                            <div class="top-player-info">
                                <div class="top-player-name" id="pogName">-</div>
                                <div class="top-player-stats" id="pogStats"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Special Teams Banner (PP/PK) -->
            <div class="special-teams-banner" id="specialTeamsBanner">
                <div class="special-teams-type" id="specialTeamsType">POWER PLAY</div>
                <div class="special-teams-time" id="specialTeamsTime">1:45</div>
                <div class="special-teams-strength" id="specialTeamsStrength">5 on 4</div>
            </div>

            <!-- Pregame Snippet -->
            <div id="pregameSnippet">
                <div class="snippet-label">Game Preview</div>
                <div class="snippet-headline" id="snippetHeadline"></div>
                <div class="snippet-description" id="snippetDescription"></div>
                <button class="snippet-open-btn" onclick="mobileShowPage('gamenews')">Full Preview</button>
            </div>

            <!-- TEST BUTTON - Remove after testing -->
            <!-- Rink-Centric Stats Layout -->
            <div class="rink-stats-layout">
                <!-- Utah Stats Column (Left) -->
                <div class="team-stats-column utah">
                    <div class="team-stat-item">
                        <div class="stat-label">Faceoff %</div>
                        <div class="stat-value" id="utahFoPct">-</div>
                    </div>
                    <div class="team-stat-item">
                        <div class="stat-label">Power Play</div>
                        <div class="stat-value" id="utahPpVal">0/0</div>
                    </div>
                    <div class="penalty-box" id="utahPenaltyBox">
                        <div class="penalty-box-title">Penalty Box</div>
                        <div class="penalty-box-empty">Clear</div>
                    </div>
                    <div class="goalie-compact" id="utahGoalieCompact">
                        <img class="goalie-compact-img" id="utahGoalieImg" src="" alt="" onerror="this.style.display='none'">
                        <div class="goalie-compact-info">
                            <div class="goalie-compact-name" id="utahGoalieName">-</div>
                            <div class="goalie-compact-sv" id="utahGoalieSv">-</div>
                        </div>
                    </div>
                </div>

                <!-- Rink Center -->
                <div class="rink-center">
                    <div class="rink-center-card">
                        <div class="shot-chart-container" id="shotChartContainer">
                            <!-- Left Sidebar: Legend, Stats, Period Selector -->
                            <div class="shot-chart-sidebar">
                                <div class="shot-chart-legend">
                                    <div class="shot-chart-legend-item">
                                        <div class="shot-chart-legend-dot utah"></div>
                                        <span id="utahLegendName">Home</span>
                                    </div>
                                    <div class="shot-chart-legend-item">
                                        <div class="shot-chart-legend-dot opp"></div>
                                        <span id="oppLegendName">Opp</span>
                                    </div>
                                    <div class="shot-chart-legend-item">
                                        <div class="shot-chart-legend-dot goal"></div>
                                        <span>Goal</span>
                                    </div>
                                </div>
                                <div class="shot-zone-stats" id="shotZoneStats">
                                    <div class="zone-stat utah"><span class="zone-label">Circle</span><span id="utahSlotPct">-</span></div>
                                    <div class="zone-stat opp"><span class="zone-label">Circle</span><span id="oppSlotPct">-</span></div>
                                </div>
                                <div class="period-selector" id="periodSelector">
                                    <button class="period-btn active" data-period="1">1st</button>
                                    <button class="period-btn" data-period="2">2nd</button>
                                    <button class="period-btn" data-period="3">3rd</button>
                                    <button class="period-btn" data-period="4" id="otPeriodBtn" style="display:none;">OT</button>
                                </div>
                            </div>
                            <!-- Rink Area -->
                            <div class="shot-chart-rink-area">
                                <div class="shot-chart-rink" id="shotChartRink">
                                    <div class="rink-goal-line left"></div>
                                    <div class="rink-goal-line right"></div>
                                    <div class="rink-blue-line left"></div>
                                    <div class="rink-blue-line right"></div>
                                    <div class="rink-center-line"></div>
                                    <div class="rink-center-circle"></div>
                                    <div class="rink-center-dot"></div>
                                    <img class="rink-center-logo" id="rinkCenterLogo" src="" alt="" onerror="this.style.display='none'">
                                    <div class="rink-goal-crease left"></div>
                                    <div class="rink-goal-crease right"></div>
                                    <div class="rink-goal-net left"></div>
                                    <div class="rink-goal-net right"></div>
                                    <div class="rink-faceoff-circle left-top"></div>
                                    <div class="rink-faceoff-circle left-bottom"></div>
                                    <div class="rink-faceoff-circle right-top"></div>
                                    <div class="rink-faceoff-circle right-bottom"></div>
                                    <div class="rink-faceoff-dot left-top"></div>
                                    <div class="rink-faceoff-dot left-bottom"></div>
                                    <div class="rink-faceoff-dot right-top"></div>
                                    <div class="rink-faceoff-dot right-bottom"></div>
                                    <div class="rink-faceoff-dot neutral-left-top"></div>
                                    <div class="rink-faceoff-dot neutral-left-bottom"></div>
                                    <div class="rink-faceoff-dot neutral-right-top"></div>
                                    <div class="rink-faceoff-dot neutral-right-bottom"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Opponent Stats Column (Right) -->
                <div class="team-stats-column opp" id="oppStatsColumn">
                    <div class="team-stat-item">
                        <div class="stat-label">Faceoff %</div>
                        <div class="stat-value" id="oppFoPct">-</div>
                    </div>
                    <div class="team-stat-item">
                        <div class="stat-label">Power Play</div>
                        <div class="stat-value" id="oppPpVal">0/0</div>
                    </div>
                    <div class="penalty-box" id="oppPenaltyBox">
                        <div class="penalty-box-title">Penalty Box</div>
                        <div class="penalty-box-empty">Clear</div>
                    </div>
                    <div class="goalie-compact" id="oppGoalieCompact">
                        <img class="goalie-compact-img" id="oppGoalieImg" src="" alt="" onerror="this.style.display='none'">
                        <div class="goalie-compact-info">
                            <div class="goalie-compact-name" id="oppGoalieName">-</div>
                            <div class="goalie-compact-sv" id="oppGoalieSv">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden legacy elements for JS compatibility -->
            <div id="faceoffTrackerMini" style="display:none;"></div>
            <div id="penaltiesMini" style="display:none;"></div>
            <div id="utahGoalieMini" style="display:none;"></div>
            <div id="oppGoalieMini" style="display:none;"></div>
            <div id="utahGoalieStats" style="display:none;"></div>
            <div id="oppGoalieStats" style="display:none;"></div>

            <!-- Hidden elements for compatibility -->
            <div id="statsGrid" style="display:none;"></div>
            <div id="goalieContainer" style="display:none;"></div>
            <div id="toiList" style="display:none;"></div>

            <div id="threeStars"></div>

            <!-- Goal Videos Section -->
            <div id="goalVideosSection" style="display:none;">
                <div class="goal-videos-title"> Goal Videos</div>
                <div class="goal-videos-container" id="goalVideosContainer"></div>
            </div>
        </div>


        <!-- PLAYER STATS PAGE -->
        <div id="players" class="page">
            <div id="playersList"></div>
        </div>

        <!-- PLAY-BY-PLAY PAGE -->
        <div id="playbyplay" class="page">
            <div class="play-feed" id="playFeed"></div>
        </div>

        <!-- GAME NEWS PAGE (pregame only) -->
        <div id="gamenews" class="page"></div>

        <!-- SCHEDULE PAGE -->
        <div id="schedule" class="page">
            <div id="scheduleContent"></div>
        </div>

        <!-- STANDINGS PAGE -->
        <div id="standings" class="page">
            <div id="standingsContent"></div>
        </div>

        <!-- TEAM ROSTER PAGE -->
        <div id="roster" class="page">
            <div id="rosterContent"></div>
        </div>

        <!-- PLAYOFF BRACKET PAGE -->
        <div id="bracket" class="page">
            <div id="bracketContent"></div>
        </div>

        <!-- PAST GAMES PAGE -->
        <div id="pastgames" class="page">
            <div class="past-game-section" style="margin: 0; border: none; background: none; padding: 0;">
                <div class="past-game-header">
                    <div class="past-game-title">Game History</div>
                    <select class="past-game-select" id="pastGameSelect" onchange="loadPastGame(this.value)">
                        <option value="">Select a game...</option>
                    </select>
                </div>
                <div class="past-game-card" id="pastGameCard"></div>
            </div>
        </div>
    </div>

     <button class="tv-exit" id="tvExit" onclick="toggleTvMode()"> Exit TV</button>

     <div class="last-updated" id="lastUpdated">Checking for game...</div>

    <!-- Player Modal -->
    <div class="player-modal" id="playerModal" style="display:none;">
        <div class="player-modal-content">
            <button class="modal-close" onclick="closePlayerModal()"></button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Video Modal -->
    <div class="video-modal" id="videoModal" style="display:none;">
        <div class="video-modal-content">
            <button class="modal-close" onclick="closeVideoModal()"></button>
            <div class="video-modal-title" id="videoModalTitle">Highlights</div>
            <div id="videoIframeWrap"></div>
        </div>
    </div>

    <!-- Goal Video Modal -->
    <div class="video-modal" id="goalVideoModal" style="display:none;">
        <div class="video-modal-content">
            <button class="modal-close" onclick="closeGoalVideoModal()"></button>
            <div class="video-modal-title" id="goalVideoModalTitle">Goal Video</div>
            <div id="goalVideoWrap"></div>
        </div>
    </div>

    <script>
        // ============================================
        // TEAM SELECTION LOGIC
        // ============================================
        // Parse URL parameter or localStorage to determine selected team
        // Priority: URL param > localStorage > redirect to team selector

        let selectedTeam = null;
        let teamsData = null;

        // Parse URL parameter
        function getTeamFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('team');
        }

        // Get team from localStorage
        function getTeamFromStorage() {
            return localStorage.getItem('selectedTeam');
        }

        // Load teams.json and find selected team
        async function initializeTeam() {
            try {
                // Get team abbreviation (URL param takes priority over localStorage)
                const teamAbbrev = getTeamFromUrl() || getTeamFromStorage();

                // If no team selected, redirect to team selector
                if (!teamAbbrev) {
                    console.log('No team selected, redirecting to team selector...');
                    window.location.href = 'index.html';
                    return null;
                }

                // Load teams data
                const response = await fetch('teams.json');
                teamsData = await response.json();

                // Find the selected team
                selectedTeam = teamsData.teams.find(t => t.abbrev === teamAbbrev);

                // If team not found, redirect to selector
                if (!selectedTeam) {
                    console.error(`Team "${teamAbbrev}" not found in teams.json`);
                    localStorage.removeItem('selectedTeam'); // Clear invalid selection
                    window.location.href = 'index.html';
                    return null;
                }

                // Save to localStorage if it came from URL (for future visits)
                if (getTeamFromUrl()) {
                    localStorage.setItem('selectedTeam', teamAbbrev);
                }

                console.log(`Selected team: ${selectedTeam.name} (${selectedTeam.abbrev})`);
                return selectedTeam;

            } catch (error) {
                console.error('Error loading team data:', error);
                alert('Error loading team data. Please try again.');
                window.location.href = 'index.html';
                return null;
            }
        }

        // Initialize team selection (this runs before anything else)
        // We'll use a flag to ensure the rest of the code waits for this
        let teamInitialized = false;
        initializeTeam().then(team => {
            if (team) {
                teamInitialized = true;
                // Update team constants with selected team
                UTAH_TEAM_ABBREV = team.abbrev;
                UTAH_TEAM_ID = team.id;

                // Update page branding
                document.title = `${team.name} - Live Stats`;

                // Update favicon
                const favicon = document.getElementById('favicon');
                if (favicon) {
                    favicon.href = `https://assets.nhle.com/logos/nhl/svg/${team.abbrev}_light.svg?season=20252026`;
                }

                // Update meta tags for social sharing
                const description = `Live NHL stats, play-by-play, and highlights for the ${team.name}`;
                const logoUrl = `https://assets.nhle.com/logos/nhl/png/${team.abbrev}_light_2024.png`;

                document.querySelector('meta[name="description"]')?.setAttribute('content', description);
                document.getElementById('ogTitle')?.setAttribute('content', `${team.name} - Live Stats`);
                document.getElementById('ogDescription')?.setAttribute('content', description);
                document.getElementById('ogImage')?.setAttribute('content', logoUrl);
                document.getElementById('twitterTitle')?.setAttribute('content', `${team.name} - Live Stats`);
                document.getElementById('twitterDescription')?.setAttribute('content', description);
                document.getElementById('twitterImage')?.setAttribute('content', logoUrl);

                console.log(`Team constants updated: ${UTAH_TEAM_ABBREV} (ID: ${UTAH_TEAM_ID})`);
                console.log(`Page branding updated for ${team.name}`);

                // Update CSS variable for team color (replaces all --mammoth-blue references)
                document.documentElement.style.setProperty('--mammoth-blue', team.color);
                console.log(`Team color updated to: ${team.color}`);

                // Check if team color is too dark for text visibility
                // If so, set a lighter fallback color for text elements
                function getColorBrightness(hexColor) {
                    const hex = hexColor.replace('#', '');
                    const r = parseInt(hex.substr(0, 2), 16);
                    const g = parseInt(hex.substr(2, 2), 16);
                    const b = parseInt(hex.substr(4, 2), 16);
                    // Calculate relative luminance
                    return (r * 299 + g * 587 + b * 114) / 1000;
                }

                const brightness = getColorBrightness(team.color);
                const textColor = brightness < 100 ? '#69B3E7' : team.color; // Use light blue if too dark
                document.documentElement.style.setProperty('--team-color-text', textColor);
                console.log(`Text color brightness: ${brightness}, using: ${textColor}`);

                // Start fetching data now that team is initialized
                // This prevents showing the last Utah/Mammoth game before team is ready
                if (typeof fetchRoster === 'function') {
                    fetchRoster();
                }

                // Connect to WebSocket for real-time updates
                if (typeof connectWebSocket === 'function') {
                    connectWebSocket();
                }
            }
        });

        // Dynamic team constants (will be set after team is initialized)
        // These replace the hardcoded UTAH_TEAM_ABBREV and UTAH_TEAM_ID
        function getTeamAbbrev() {
            return selectedTeam?.abbrev || 'UTA'; // Fallback to UTA
        }

        function getTeamId() {
            return selectedTeam?.id || 55; // Fallback to Utah ID
        }

        // Change team function - clears selection and redirects to team selector
        function changeTeam() {
            if (confirm('Change your team? This will return you to the team selection page.')) {
                localStorage.removeItem('selectedTeam');
                window.location.href = 'index.html';
            }
        }

        // Team constants - initialized with defaults, updated after team selection
        // Using 'let' instead of 'const' so they can be updated dynamically
        let UTAH_TEAM_ABBREV = 'UTA'; // Default fallback, will be updated
        let UTAH_TEAM_ID = 55; // Default fallback, will be updated
        const REFRESH_INTERVAL_DEFAULT = 10000;
        const REFRESH_INTERVAL_LIVE = 5000;

        // NHL Team Colors (primary)
        const TEAM_COLORS = {
            'ANA': '#F47A38', // Anaheim Ducks - Orange
            'ARI': '#8C2633', // Arizona Coyotes - Burgundy
            'BOS': '#FFB81C', // Boston Bruins - Gold
            'BUF': '#002654', // Buffalo Sabres - Navy
            'CGY': '#D2001C', // Calgary Flames - Red
            'CAR': '#CC0000', // Carolina Hurricanes - Red
            'CHI': '#CF0A2C', // Chicago Blackhawks - Red
            'COL': '#6F263D', // Colorado Avalanche - Burgundy
            'CBJ': '#002654', // Columbus Blue Jackets - Navy
            'DAL': '#006847', // Dallas Stars - Green
            'DET': '#CE1126', // Detroit Red Wings - Red
            'EDM': '#041E42', // Edmonton Oilers - Navy
            'FLA': '#041E42', // Florida Panthers - Navy
            'LAK': '#111111', // LA Kings - Black
            'MIN': '#154734', // Minnesota Wild - Green
            'MTL': '#AF1E2D', // Montreal Canadiens - Red
            'NSH': '#FFB81C', // Nashville Predators - Gold
            'NJD': '#CE1126', // New Jersey Devils - Red
            'NYI': '#00539B', // NY Islanders - Blue
            'NYR': '#0038A8', // NY Rangers - Blue
            'OTT': '#C52032', // Ottawa Senators - Red
            'PHI': '#F74902', // Philadelphia Flyers - Orange
            'PIT': '#FCB514', // Pittsburgh Penguins - Gold
            'SJS': '#006D75', // San Jose Sharks - Teal
            'SEA': '#99D9D9', // Seattle Kraken - Ice Blue
            'STL': '#002F87', // St. Louis Blues - Blue
            'TBL': '#002868', // Tampa Bay Lightning - Blue
            'TOR': '#00205B', // Toronto Maple Leafs - Blue
            'UTA': '#69B3E7', // Utah Hockey Club - Light Blue
            'VAN': '#00205B', // Vancouver Canucks - Blue
            'VGK': '#B4975A', // Vegas Golden Knights - Gold
            'WSH': '#C8102E', // Washington Capitals - Red
            'WPG': '#041E42'  // Winnipeg Jets - Navy
        };

        // Helper function to check if a color is dark (needs white outline)
        function isColorDark(hexColor) {
            if (!hexColor || !hexColor.startsWith('#')) return false;
            const hex = hexColor.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            // Calculate luminance - darker colors have lower values
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance < 0.4; // Consider dark if luminance < 40%
        }

        // Get text shadow style for dark colors
        function getTextShadowForColor(hexColor) {
            if (isColorDark(hexColor)) {
                return '0 0 3px #fff, 0 0 6px #fff, 1px 1px 1px #000';
            }
            return '1px 1px 2px rgba(0,0,0,0.5)';
        }

        let refreshTimer = null;
        let currentGameId = null;
        let gameData = null;
        let scheduleData = null;
        let standingsData = null;
        let rightRailData = null;
        let nhlGamesToday = [];
        let nhlTickerIndex = 0;
        let nhlTickerInterval = null;
        let nhlTickerRefreshCounter = 0;
        let rotatingPanelIndex = 0;
        let rotatingPanelInterval = null;
        let rotatingPanelAutoEnabled = true;
        let contentData = null;
        let goalsData = [];

        const DEBUG = new URLSearchParams(window.location.search).has('debug');
        function debugLog(...args) {
            if (DEBUG) console.log(...args);
        }

        let lastKnownScore = { utah: null, opp: null, gameId: null };
        let lastGoalEventId = null;
        let goalBannerTimer = null;

        function getLocalMidnightFromYMD(ymd) {
            const parts = String(ymd).split('-').map(Number);
            if (parts.length !== 3 || parts.some(n => Number.isNaN(n))) return null;
            const [year, month, day] = parts;
            return new Date(year, month - 1, day, 0, 0, 0, 0);
        }

        function getGameDayDate(game) {
            if (game?.gameDate) {
                const gameDateStr = String(game.gameDate);
                if (/^\d{4}-\d{2}-\d{2}$/.test(gameDateStr)) {
                    return getLocalMidnightFromYMD(gameDateStr);
                }

                const parsed = new Date(gameDateStr);
                if (!Number.isNaN(parsed.getTime())) {
                    parsed.setHours(0, 0, 0, 0);
                    return parsed;
                }
            }

            if (game?.startTimeUTC) {
                const parsed = new Date(game.startTimeUTC);
                if (!Number.isNaN(parsed.getTime())) {
                    parsed.setHours(0, 0, 0, 0);
                    return parsed;
                }
            }

            return null;
        }

        function getGameStartDate(game) {
            if (game?.startTimeUTC) {
                const parsed = new Date(game.startTimeUTC);
                if (!Number.isNaN(parsed.getTime())) return parsed;
            }

            if (game?.gameDate) {
                const gameDateStr = String(game.gameDate);
                if (/^\d{4}-\d{2}-\d{2}$/.test(gameDateStr)) {
                    return getLocalMidnightFromYMD(gameDateStr);
                }

                const parsed = new Date(gameDateStr);
                if (!Number.isNaN(parsed.getTime())) return parsed;
            }

            return null;
        }

        function getTodayLocalMidnight() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }

        // Navigation
        function showPage(pageName) {
            // Clean up any floating popups when changing pages
            document.querySelectorAll('.goal-popup, .goalie-stats-popup').forEach(p => p.remove());

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            event.target.classList.add('active');
        }

        // Mobile Navigation Functions
        function toggleMobileNav() {
            const hamburger = document.getElementById('hamburgerMenu');
            const mobileNav = document.getElementById('mobileNav');
            hamburger.classList.toggle('open');
            mobileNav.classList.toggle('open');
        }

        function closeMobileNav() {
            const hamburger = document.getElementById('hamburgerMenu');
            const mobileNav = document.getElementById('mobileNav');
            hamburger.classList.remove('open');
            mobileNav.classList.remove('open');
        }

        function mobileShowPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            // Highlight correct desktop tab too
            const desktopBtn = document.querySelector(`.nav-tab[onclick="showPage('${pageName}')"]`);
            if (desktopBtn) desktopBtn.classList.add('active');
            closeMobileNav();
        }

        // TEST FUNCTION - Shows what penalty box looks like with players
        // Call testPenaltyBox() in browser console to test
        // Call testPenaltyBox(false) to clear
        // Test function for Power Play display
        // Usage: testPenaltyBox('utah') - Utah has PP, opponent in box
        //        testPenaltyBox('opp') - Opponent has PP, Utah in box
        //        testPenaltyBox(false) - Clear test
        function testPenaltyBox(mode = 'utah') {
            const utahBox = document.getElementById('utahPenaltyBox');
            const oppBox = document.getElementById('oppPenaltyBox');
            const utahPpIndicator = document.getElementById('utahPpIndicator');
            const oppPpIndicator = document.getElementById('oppPpIndicator');

            const clearBox = `
                <div class="penalty-box-title">Penalty Box</div>
                <div class="penalty-box-empty">Clear</div>
            `;

            // Clear test mode
            if (mode === false) {
                utahBox.innerHTML = clearBox;
                oppBox.innerHTML = clearBox;
                if (utahPpIndicator) utahPpIndicator.classList.remove('active');
                if (oppPpIndicator) oppPpIndicator.classList.remove('active');
                console.log('Penalty box test cleared');
                return;
            }

            // Utah has PP - Opponent in penalty box
            if (mode === 'utah') {
                oppBox.innerHTML = `
                    <div class="penalty-box-title">Penalty Box</div>
                    <div class="penalty-item">
                        <img class="penalty-mugshot" src="https://assets.nhle.com/mugs/nhl/20252026/COL/8477492.png" alt="" onerror="this.style.display='none'">
                        <div class="penalty-info">
                            <div class="penalty-player">#29 MacKinnon</div>
                            <div class="penalty-time">1:32</div>
                            <div class="penalty-type">Hooking</div>
                        </div>
                    </div>
                `;
                utahBox.innerHTML = clearBox;
                if (utahPpIndicator) utahPpIndicator.classList.add('active');
                if (oppPpIndicator) oppPpIndicator.classList.remove('active');
                console.log('Test: Utah has PP, opponent in penalty box');
            }

            // Opponent has PP - Utah in penalty box
            if (mode === 'opp') {
                utahBox.innerHTML = `
                    <div class="penalty-box-title">Penalty Box</div>
                    <div class="penalty-item">
                        <img class="penalty-mugshot" src="https://assets.nhle.com/mugs/nhl/20252026/${UTAH_TEAM_ABBREV}/8478904.png" alt="" onerror="this.style.display='none'">
                        <div class="penalty-info">
                            <div class="penalty-player">#77 Kesselring</div>
                            <div class="penalty-time">0:47</div>
                            <div class="penalty-type">Tripping</div>
                        </div>
                    </div>
                `;
                oppBox.innerHTML = clearBox;
                if (oppPpIndicator) oppPpIndicator.classList.add('active');
                if (utahPpIndicator) utahPpIndicator.classList.remove('active');
                console.log('Test: Opponent has PP, Utah in penalty box');
            }
        }

        function toggleTvMode(force) {
            const shouldEnable = typeof force === 'boolean' ? force : !document.body.classList.contains('tv-mode');
            document.body.classList.toggle('tv-mode', shouldEnable);

            if (shouldEnable) {
                // Force scoreboard page without relying on click event
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('scoreboard').classList.add('active');

                // Keep scoreboard tab highlighted if visible (non-tv)
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                const scoreboardBtn = document.querySelector('.nav-tab[onclick="showPage(\'scoreboard\')"]');
                if (scoreboardBtn) scoreboardBtn.classList.add('active');

                try {
                    if (!document.fullscreenElement && document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    }
                } catch (e) {
                    // Ignore fullscreen errors (browser permission)
                }
            } else {
                try {
                    if (document.fullscreenElement && document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                } catch (e) {
                    // ignore
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.body.classList.contains('tv-mode')) {
                toggleTvMode(false);
            }
        });

        function showGoalBanner({ teamAbbrev, scorer, strength, timeInPeriod, assists } = {}) {
            const banner = document.getElementById('goalBanner');
            const teamEl = document.getElementById('goalBannerTeam');
            const detailEl = document.getElementById('goalBannerDetail');

            if (goalBannerTimer) clearTimeout(goalBannerTimer);

            const strengthLabel = strength ? String(strength).toUpperCase() : '';
            const parts = [];
            if (teamAbbrev) parts.push(teamAbbrev);
            if (scorer) parts.push(scorer);
            if (strengthLabel) parts.push(`(${strengthLabel})`);
            if (timeInPeriod) parts.push(timeInPeriod);

            teamEl.textContent = parts.length ? ` ${parts.join(' ')}` : '';

            const assistText = Array.isArray(assists) && assists.length
                ? `Assists: ${assists.join(', ')}`
                : '';
            detailEl.textContent = assistText;

            banner.classList.add('on');

            goalBannerTimer = setTimeout(() => {
                banner.classList.remove('on');
                detailEl.textContent = '';
            }, 6500);
        }

        function getLatestGoalFromLandingSummary() {
            const scoring = gameData?.landingSummary?.scoring;
            if (!Array.isArray(scoring)) return null;

            const allGoals = [];
            for (const period of scoring) {
                const periodNo = period?.periodDescriptor?.number;
                for (const goal of (period?.goals || [])) {
                    allGoals.push({
                        ...goal,
                        _periodNumber: periodNo
                    });
                }
            }

            if (allGoals.length === 0) return null;
            const last = allGoals[allGoals.length - 1];

            const teamAbbrev = last?.teamAbbrev?.default || null;
            const scorer = last?.name?.default || `${last?.firstName?.default || ''} ${last?.lastName?.default || ''}`.trim() || null;
            const strength = last?.strength || null;
            const timeInPeriod = last?.timeInPeriod ? `P${last._periodNumber || '?'} ${last.timeInPeriod}` : null;

            const assists = (last?.assists || [])
                .map(a => a?.name?.default || `${a?.firstName?.default || ''} ${a?.lastName?.default || ''}`.trim())
                .filter(Boolean);

            return {
                eventId: last?.eventId ?? null,
                teamAbbrev,
                scorer,
                strength,
                timeInPeriod,
                assists
            };
        }

        function normalizeTeamAbbrev(teamAbbrev) {
            if (!teamAbbrev) return '';
            if (typeof teamAbbrev === 'string') return teamAbbrev;
            if (typeof teamAbbrev === 'object' && teamAbbrev.default) return teamAbbrev.default;
            return String(teamAbbrev);
        }

        // Get team logo
        function getTeamLogoUrl(teamAbbrev) {
            const abbrev = normalizeTeamAbbrev(teamAbbrev);
            return `https://assets.nhle.com/logos/nhl/svg/${abbrev}_light.svg`;
        }

        // Get player headshot
        function getPlayerHeadshot(playerId, teamAbbrev) {
            return `https://assets.nhle.com/mugs/nhl/20252026/${teamAbbrev}/${playerId}.png`;
        }

        // Find Utah game
        async function findUtahGame() {
            try {
                const now = new Date();
                const today = getTodayLocalMidnight();
                const scheduleResponse = await fetch(`/api/v1/club-schedule/${UTAH_TEAM_ABBREV}/week/now`);
                const scheduleData = await scheduleResponse.json();

                let todayGame = null;
                let mostRecentCompletedGame = null;
                let nextScheduledGame = null;

                if (scheduleData.games) {
                    for (const game of scheduleData.games) {
                        const gameDay = getGameDayDate(game);
                        if (gameDay && gameDay.getTime() === today.getTime()) {
                            todayGame = game;
                            break;
                        }
                    }

                    // Find the most recent completed game and next scheduled game
                    for (const game of scheduleData.games) {
                        const gameTime = new Date(`${game.gameDate}T${game.startTimeUTC || '00:00:00'}Z`);

                        // Find most recent completed game
                        if ((game.gameState === 'OFF' || game.gameState === 'FINAL') && gameTime < now) {
                            if (!mostRecentCompletedGame || gameTime > new Date(`${mostRecentCompletedGame.gameDate}T${mostRecentCompletedGame.startTimeUTC || '00:00:00'}Z`)) {
                                mostRecentCompletedGame = game;
                            }
                        }

                        // Find next scheduled game
                        if (gameTime > now && !nextScheduledGame) {
                            nextScheduledGame = game;
                        }
                    }
                }

                // Return priority: today's game > last completed game (if next game is >1hr away) > nothing
                if (todayGame) {
                    return todayGame.id;
                }

                // If there's a most recent completed game, show it until 1 hour before the next game
                if (mostRecentCompletedGame && nextScheduledGame) {
                    const nextGameTime = new Date(`${nextScheduledGame.gameDate}T${nextScheduledGame.startTimeUTC || '00:00:00'}Z`);
                    const oneHourBeforeNextGame = new Date(nextGameTime.getTime() - 60 * 60 * 1000);

                    if (now < oneHourBeforeNextGame) {
                        return mostRecentCompletedGame.id;
                    }
                } else if (mostRecentCompletedGame) {
                    // No next game scheduled, keep showing the last one
                    return mostRecentCompletedGame.id;
                }

                const scoreResponse = await fetch('/api/v1/score/now');
                const scoreData = await scoreResponse.json();

                let games = [];
                if (scoreData.gameWeek) {
                    for (const gw of scoreData.gameWeek) {
                        if (gw.games) games = games.concat(gw.games);
                    }
                }

                for (const game of games) {
                    if (game.homeTeam?.abbrev === UTAH_TEAM_ABBREV ||
                        game.awayTeam?.abbrev === UTAH_TEAM_ABBREV) {
                        return game.id;
                    }
                }

                return null;
            } catch (error) {
                console.error('Error finding game:', error);
                return null;
            }
        }

        // WebSocket connection for real-time updates
        let ws = null;
        let wsReconnectTimer = null;
        let useWebSocket = true; // Feature flag to enable/disable WebSocket

        function connectWebSocket() {
            if (!useWebSocket) {
                console.log('WebSocket disabled, using HTTP fallback');
                startHttpPolling();
                return;
            }

            // Determine WebSocket URL (ws:// for http, wss:// for https)
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;

            console.log('Connecting to WebSocket:', wsUrl);

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('WebSocket connected');

                    // Subscribe to team updates
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        team: selectedTeam.abbrev,
                        teamId: selectedTeam.id
                    }));

                    // Clear HTTP polling if it was running as fallback
                    if (refreshTimer) {
                        clearInterval(refreshTimer);
                        refreshTimer = null;
                    }
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.type === 'gameData' && message.data) {
                            console.log('Received game data via WebSocket');

                            // Update all data variables from server broadcast
                            scheduleData = message.data.scheduleData;
                            nhlGamesToday = (message.data.nhlGamesToday?.games || []).filter(g => {
                                const isTeamGame = g.homeTeam?.abbrev === selectedTeam.abbrev || g.awayTeam?.abbrev === selectedTeam.abbrev;
                                return !isTeamGame;
                            });
                            gameData = message.data.gameData;
                            rightRailData = message.data.rightRailData;
                            contentData = message.data.contentData;
                            standingsData = message.data.standingsData;

                            // Update current game ID if needed
                            const newGameId = gameData?.game?.gameId || gameData?.id;
                            if (newGameId && newGameId !== currentGameId) {
                                console.log('Game ID changed:', currentGameId, '->', newGameId);
                                currentGameId = newGameId;
                            }

                            // Update last updated timestamp
                            const now = new Date();
                            document.getElementById('lastUpdated').textContent = `Updated: ${now.toLocaleTimeString()}`;

                            // Update UI
                            updateAll();
                            populatePastGameSelect();
                            renderNhlTicker();
                            startNhlTickerCycle();

                            // Update standings display if data is available
                            if (standingsData && typeof updateStandings === 'function') {
                                updateStandings();
                            }

                            // Refresh scoreboard to populate team records
                            if (gameData && typeof updateScoreboard === 'function') {
                                updateScoreboard();
                            }
                        }
                    } catch (error) {
                        console.error('Error processing WebSocket message:', error);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    ws = null;

                    // Attempt reconnection after 3 seconds
                    if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
                    wsReconnectTimer = setTimeout(() => {
                        console.log('Attempting WebSocket reconnection...');
                        connectWebSocket();
                    }, 3000);

                    // Start HTTP polling as fallback while reconnecting
                    if (!refreshTimer) {
                        console.log('Starting HTTP polling as fallback');
                        startHttpPolling();
                    }
                };

            } catch (error) {
                console.error('Failed to create WebSocket connection:', error);
                console.log('Falling back to HTTP polling');
                startHttpPolling();
            }
        }

        // Start HTTP polling (fallback)
        function startHttpPolling() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }

            fetchGameData(); // Initial fetch
            refreshTimer = setInterval(fetchGameData, REFRESH_INTERVAL_DEFAULT);
        }

        // Fetch game data (HTTP fallback or initial load)
        async function fetchGameData() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Updated: ${now.toLocaleTimeString()}`;
            
            // Fetch schedule
            await fetchSchedule();

            // Fetch other NHL games for ticker (every refresh = ~10 seconds for live score updates)
            fetchNhlGamesToday();

            // Always re-evaluate which game we should be showing
            // (so we can switch to pregame/live automatically)
            const selectedGameId = await findTodaysOrLastGame();
            if (selectedGameId && selectedGameId !== currentGameId) {
                debugLog('Switching gameId:', currentGameId, '->', selectedGameId);
                currentGameId = selectedGameId;
            }

            if (currentGameId) {
                try {
                    // Try game-story endpoint
                    const storyResponse = await fetch(`/api/v1/wsc/game-story/${currentGameId}`);
                    if (storyResponse.ok) {
                        gameData = await storyResponse.json();
                        debugLog('Game story data:', gameData);

                        // Game-story doesn't always include player stats for non-live games.
                        // If player list isn't present, enrich with boxscore playerByGameStats.
                        const hasStoryPlayers = Array.isArray(gameData?.players?.skaters) && gameData.players.skaters.length > 0;
                        if (!hasStoryPlayers) {
                            const boxscoreRes = await fetch(`/api/v1/gamecenter/${currentGameId}/boxscore`);
                            const boxscore = await boxscoreRes.json();

                            if (boxscore?.playerByGameStats) {
                                gameData.playerByGameStats = boxscore.playerByGameStats;
                            }

                            if (!gameData.teams && boxscore?.homeTeam && boxscore?.awayTeam) {
                                gameData.teams = {
                                    home: { ...boxscore.homeTeam, stats: {} },
                                    away: { ...boxscore.awayTeam, stats: {} }
                                };
                            }
                        }
                    } else {
                        // Fallback to boxscore
                        const boxscoreRes = await fetch(`/api/v1/gamecenter/${currentGameId}/boxscore`);
                        const landingRes = await fetch(`/api/v1/gamecenter/${currentGameId}/landing`);
                        const boxscore = await boxscoreRes.json();
                        const landing = await landingRes.json();
                        
                        // Convert to game-story format
                        gameData = {
                            game: {
                                gameId: currentGameId,
                                gameState: landing.gameState || boxscore.gameState
                            },
                            teams: {
                                home: { ...boxscore.homeTeam, stats: {} },
                                away: { ...boxscore.awayTeam, stats: {} }
                            },
                            playerByGameStats: boxscore.playerByGameStats
                        };
                    }
                    
                    // Fetch right-rail (team game stats like hits/PP/FO%)
                    try {
                        const rightRailRes = await fetch(`/api/v1/gamecenter/${currentGameId}/right-rail`);
                        if (rightRailRes.ok) {
                            rightRailData = await rightRailRes.json();
                        } else {
                            rightRailData = null;
                        }
                    } catch (e) {
                        rightRailData = null;
                    }

                    // Fetch landing (latest goal info, penalties, 3-stars, situation for PP/PK)
                    try {
                        const landingRes = await fetch(`/api/v1/gamecenter/${currentGameId}/landing`);
                        if (landingRes.ok) {
                            const landing = await landingRes.json();
                            if (landing) {
                                // keep a copy so scoreboard can read last goal/penalties/three stars
                                // Also capture situation data for PP/PK indicator
                                gameData = {
                                    ...gameData,
                                    landingSummary: landing.summary,
                                    situation: landing.situation,
                                    clock: landing.clock || gameData.clock
                                };
                            }
                        }
                    } catch (e) {
                        // ignore
                    }

                    // Fetch official play-by-play (rich events + roster headshots)
                    try {
                        const pbpRes = await fetch(`/api/v1/gamecenter/${currentGameId}/play-by-play`);
                        if (pbpRes.ok) {
                            const pbp = await pbpRes.json();
                            gameData = { ...gameData, playByPlay: pbp };
                        }
                    } catch (e) {
                        // ignore
                    }

                    // Fetch pregame content (articles/preview)
                    try {
                        const contentRes = await fetch(`/api/v1/gamecenter/${currentGameId}/content`);
                        if (contentRes.ok) {
                            contentData = await contentRes.json();
                            debugLog('Content data:', contentData);
                        } else {
                            contentData = null;
                        }
                    } catch (e) {
                        contentData = null;
                    }

                    updateAll();

                    // Dynamic refresh rate: faster during live games
                    const liveState = (gameData?.gameState || gameData?.game?.gameState) === 'LIVE' || (gameData?.gameState || gameData?.game?.gameState) === 'CRIT';
                    const desiredInterval = liveState ? REFRESH_INTERVAL_LIVE : REFRESH_INTERVAL_DEFAULT;
                    if (refreshTimer) {
                        clearInterval(refreshTimer);
                        refreshTimer = setInterval(fetchGameData, desiredInterval);
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                rightRailData = null;
                updateAll();
            }
            
            // Fetch standings
            await fetchStandings();
        }

        async function fetchSchedule() {
            try {
                const response = await fetch(`/api/v1/club-schedule-season/${UTAH_TEAM_ABBREV}/now`);
                scheduleData = await response.json();
                debugLog('Schedule data:', scheduleData);
                populatePastGameSelect();
            } catch (error) {
                console.error('Error fetching schedule:', error);
            }
        }

        // NHL Games Ticker
        async function fetchNhlGamesToday() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/v1/score/${today}`);
                if (!response.ok) return;
                const data = await response.json();

                // Filter out Utah's game and get other games
                nhlGamesToday = (data.games || []).filter(g => {
                    const isUtahGame = g.homeTeam?.abbrev === UTAH_TEAM_ABBREV || g.awayTeam?.abbrev === UTAH_TEAM_ABBREV;
                    return !isUtahGame;
                });

                debugLog('NHL games today (excluding Utah):', nhlGamesToday.length);
                renderNhlTicker();
                startNhlTickerCycle();
            } catch (e) {
                debugLog('Error fetching NHL games:', e);
                document.getElementById('nhlTickerGame').innerHTML = '<div style="color: #666; font-size: 12px;">No other games</div>';
            }
        }

        function renderNhlTicker() {
            const tickerGame = document.getElementById('nhlTickerGame');
            const tickerNav = document.getElementById('nhlTickerNav');

            if (!nhlGamesToday.length) {
                tickerGame.innerHTML = '<div style="color: #666; font-size: 12px;">No other games today</div>';
                tickerNav.innerHTML = '';
                return;
            }

            // Render navigation dots
            tickerNav.innerHTML = nhlGamesToday.map((_, i) =>
                `<div class="nhl-ticker-dot ${i === nhlTickerIndex ? 'active' : ''}" onclick="setNhlTickerIndex(${i})"></div>`
            ).join('');

            const game = nhlGamesToday[nhlTickerIndex];
            const away = game.awayTeam;
            const home = game.homeTeam;
            const awayScore = away?.score ?? 0;
            const homeScore = home?.score ?? 0;

            // Determine game status
            let statusText = '';
            let isLive = false;
            const state = game.gameState;

            if (state === 'LIVE' || state === 'CRIT') {
                isLive = true;
                const period = game.periodDescriptor?.number || 1;
                const periodName = period <= 3 ? `P${period}` : (period === 4 ? 'OT' : `${period - 3}OT`);
                const clock = game.clock?.timeRemaining || '';
                statusText = `${periodName} ${clock}`;
            } else if (state === 'FINAL' || state === 'OFF') {
                statusText = 'FINAL';
            } else if (state === 'FUT' || state === 'PRE') {
                const startTime = game.startTimeUTC ? new Date(game.startTimeUTC).toLocaleTimeString('en-US', {
                    hour: 'numeric', minute: '2-digit', hour12: true
                }) : '';
                statusText = startTime || 'Upcoming';
            }

            const awayWon = state === 'FINAL' || state === 'OFF' ? awayScore > homeScore : false;
            const homeWon = state === 'FINAL' || state === 'OFF' ? homeScore > awayScore : false;

            tickerGame.innerHTML = `
                <div class="nhl-ticker-team">
                    <img src="${getTeamLogoUrl(away?.abbrev)}" alt="${away?.abbrev}">
                    <span class="nhl-ticker-abbrev">${away?.abbrev || ''}</span>
                    <span class="nhl-ticker-score ${awayWon ? 'winner' : ''}">${awayScore}</span>
                </div>
                <span class="nhl-ticker-vs">@</span>
                <div class="nhl-ticker-team">
                    <span class="nhl-ticker-score ${homeWon ? 'winner' : ''}">${homeScore}</span>
                    <span class="nhl-ticker-abbrev">${home?.abbrev || ''}</span>
                    <img src="${getTeamLogoUrl(home?.abbrev)}" alt="${home?.abbrev}">
                </div>
            `;

            // Add status below
            const statusDiv = document.createElement('div');
            statusDiv.className = `nhl-ticker-status ${isLive ? 'live' : ''}`;
            statusDiv.textContent = statusText;
            tickerGame.appendChild(statusDiv);
        }

        function setNhlTickerIndex(index) {
            nhlTickerIndex = index;
            renderNhlTicker();
            // Reset the auto-cycle timer
            startNhlTickerCycle();
        }

        function startNhlTickerCycle() {
            if (nhlTickerInterval) clearInterval(nhlTickerInterval);
            if (nhlGamesToday.length <= 1) return;

            nhlTickerInterval = setInterval(() => {
                nhlTickerIndex = (nhlTickerIndex + 1) % nhlGamesToday.length;
                renderNhlTicker();
            }, 8000); // Cycle every 8 seconds
        }

        // Rotating Panel (Rink/Goalies/Fastest Shots)
        function setRotatingPanel(index) {
            rotatingPanelIndex = index;

            // Update panels
            document.querySelectorAll('.rotating-card-panel').forEach((panel, i) => {
                panel.classList.toggle('active', i === index);
            });

            // Update tabs
            document.querySelectorAll('.rotating-card-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });

            // Reset auto-rotate timer if enabled
            if (rotatingPanelAutoEnabled) {
                startRotatingPanelCycle();
            }
        }

        function toggleAutoRotate() {
            const checkbox = document.getElementById('autoRotateCheck');
            rotatingPanelAutoEnabled = checkbox?.checked ?? false;

            if (rotatingPanelAutoEnabled) {
                startRotatingPanelCycle();
            } else {
                if (rotatingPanelInterval) {
                    clearInterval(rotatingPanelInterval);
                    rotatingPanelInterval = null;
                }
            }
        }

        function startRotatingPanelCycle() {
            if (rotatingPanelInterval) clearInterval(rotatingPanelInterval);
            if (!rotatingPanelAutoEnabled) return;

            rotatingPanelInterval = setInterval(() => {
                rotatingPanelIndex = (rotatingPanelIndex + 1) % 3;
                setRotatingPanel(rotatingPanelIndex);
            }, 6000); // Cycle every 6 seconds
        }

        async function fetchStandings() {
            try {
                const response = await fetch('/api/v1/standings/now');
                standingsData = await response.json();
                debugLog('Standings data:', standingsData);
                updateStandings();

                // Refresh scoreboard to populate team records
                if (gameData) {
                    updateScoreboard();
                }
            } catch (error) {
                console.error('Error fetching standings:', error);
            }
        }

        async function findTodaysOrLastGame() {
            try {
                const now = new Date();
                const today = getTodayLocalMidnight();

                if (scheduleData && scheduleData.games) {
                    // 1) If there's a live game, always pick it.
                    const liveGame = scheduleData.games.find(g => g.gameState === 'LIVE' || g.gameState === 'CRIT');
                    if (liveGame) {
                        debugLog('Found live game:', liveGame.id);
                        return liveGame.id;
                    }

                    // 2) If there's a game today that has started or is live, pick it.
                    for (const game of scheduleData.games) {
                        const gameDay = getGameDayDate(game);
                        if (gameDay && gameDay.getTime() === today.getTime()) {
                            // Only return if game has started (LIVE/CRIT) or finished (OFF/FINAL)
                            // Don't return FUT games - those get handled in step 3 (within 1 hour check)
                            if (game.gameState === 'LIVE' || game.gameState === 'CRIT' || game.gameState === 'OFF' || game.gameState === 'FINAL') {
                                debugLog('Found today\'s game:', game.id);
                                return game.id;
                            }
                        }
                    }

                    // 3) If the next game is within 6 hours, switch early (pre-game mode).
                    const upcoming = scheduleData.games
                        .filter(g => g.gameState === 'FUT')
                        .map(g => ({ game: g, start: getGameStartDate(g) }))
                        .filter(x => x.start)
                        .sort((a, b) => a.start.getTime() - b.start.getTime());

                    if (upcoming.length > 0) {
                        const next = upcoming[0];
                        const msUntil = next.start.getTime() - now.getTime();
                        if (msUntil <= 6 * 60 * 60 * 1000 && msUntil >= -6 * 60 * 60 * 1000) {
                            // allow switching 6 hours before game and slightly after puck drop too, until live state arrives
                            debugLog('Switching to next game (within 6 hours):', next.game.id);
                            return next.game.id;
                        }
                    }

                    // 4) Otherwise show the last finished game.
                    const pastGames = scheduleData.games
                        .filter(g => {
                            const gameStart = getGameStartDate(g);
                            return gameStart && gameStart < now && g.gameState === 'OFF';
                        })
                        .sort((a, b) => {
                            const aStart = getGameStartDate(a);
                            const bStart = getGameStartDate(b);
                            return (bStart?.getTime() || 0) - (aStart?.getTime() || 0);
                        });

                    if (pastGames.length > 0) {
                        debugLog('Using last game:', pastGames[0].id);
                        return pastGames[0].id;
                    }
                }

                return null;
            } catch (error) {
                console.error('Error finding game:', error);
                return null;
            }
        }

        function updateAll() {
            updateVenueHeader();
            updateScoreboard();
            updateStats();
            updateGoalieStats();
            updateSpecialTeams();
            updatePenaltyBoxes();
            updatePlayerOfGame();
            updateShotChart();
            updateTimeOnIce();
            updatePlayers();
            updatePlayByPlay();
            updateRecentPlays();
            updateSchedule();
            updateGameNews();
            updateGoalVideos();
        }

        function updateGameNews() {
            if (!gameData || !contentData) {
                document.getElementById('pregameSnippet').classList.remove('show');
                document.querySelectorAll('.gamenews-nav').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.gamenews-nav-mobile').forEach(el => el.style.display = 'none');
                return;
            }

            const rawState = gameData.gameState || gameData.game?.gameState;

            // Hide news if game is not in FUT or PRE state
            if (rawState !== 'FUT' && rawState !== 'PRE') {
                document.getElementById('pregameSnippet').classList.remove('show');
                document.querySelectorAll('.gamenews-nav').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.gamenews-nav-mobile').forEach(el => el.style.display = 'none');

                // If user is on gamenews page, redirect to scoreboard
                if (document.getElementById('gamenews').classList.contains('active')) {
                    showPage('scoreboard');
                }
                return;
            }

            // Extract articles from content data
            const articles = [];
            if (contentData.editorial?.preview?.items) {
                articles.push(...contentData.editorial.preview.items);
            }
            if (contentData.editorial?.articles?.items) {
                articles.push(...contentData.editorial.articles.items);
            }

            // Hide everything if no articles
            if (articles.length === 0) {
                document.getElementById('pregameSnippet').classList.remove('show');
                document.querySelectorAll('.gamenews-nav').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.gamenews-nav-mobile').forEach(el => el.style.display = 'none');
                return;
            }

            // Show nav tabs
            document.querySelectorAll('.gamenews-nav').forEach(el => el.style.display = 'block');
            document.querySelectorAll('.gamenews-nav-mobile').forEach(el => el.style.display = 'block');

            // Update snippet with first article
            const firstArticle = articles[0];
            const snippetHeadline = document.getElementById('snippetHeadline');
            const snippetDescription = document.getElementById('snippetDescription');

            if (firstArticle) {
                snippetHeadline.textContent = firstArticle.headline || firstArticle.title || '';
                snippetDescription.textContent = firstArticle.seoDescription || firstArticle.description || '';
                document.getElementById('pregameSnippet').classList.add('show');
            }

            // Populate full news page
            const newsPageDiv = document.getElementById('gamenews');
            if (articles.length > 0) {
                newsPageDiv.innerHTML = articles.map((article, idx) => {
                    const pubDate = article.pubDate ? new Date(article.pubDate).toLocaleDateString() : '';
                    const type = article.type || 'Article';
                    const headline = article.headline || article.title || 'Untitled';
                    const subhead = article.subheadline || '';
                    const description = article.seoDescription || article.description || '';

                    return `
                        <div class="gamenews-card" onclick="window.open('${article.url || '#'}', '_blank')">
                            <div class="gamenews-type">${type}</div>
                            <div class="gamenews-date">${pubDate}</div>
                            <div class="gamenews-headline">${headline}</div>
                            ${subhead ? `<div class="gamenews-subhead">${subhead}</div>` : ''}
                            <div class="gamenews-description">${description}</div>
                        </div>
                    `;
                }).join('');
            } else {
                newsPageDiv.innerHTML = '<div class="gamenews-empty">No game news available</div>';
            }
        }

        function updateGoalVideos() {
            if (!gameData || !gameData.playByPlay || !gameData.playByPlay.plays) {
                goalsData = [];
                return;
            }

            // Build roster map from playByPlay data
            const rosterById = new Map();
            if (gameData.playByPlay.rosterSpots && Array.isArray(gameData.playByPlay.rosterSpots)) {
                gameData.playByPlay.rosterSpots.forEach(r => {
                    if (r?.playerId) {
                        const name = `${r.firstName?.default || ''} ${r.lastName?.default || ''}`.trim();
                        if (name) rosterById.set(r.playerId, name);
                    }
                });
            }

            // Build landing summary goals map for clip data fallback
            const landingSummaryGoals = new Map();
            if (gameData?.landingSummary?.summary?.scoring && Array.isArray(gameData.landingSummary.summary.scoring)) {
                gameData.landingSummary.summary.scoring.forEach(goal => {
                    const key = `${goal.playerId}-${goal.firstName?.default}-${goal.lastName?.default}`;
                    landingSummaryGoals.set(key, goal);
                });
            }

            // Filter for goals only
            const goals = gameData.playByPlay.plays.filter(p => p?.typeDescKey === 'goal');

            debugLog('Found goals:', goals.length, 'Landing summary goals:', landingSummaryGoals.size);

            goalsData = goals.map((goal, index) => {
                const details = goal?.details || {};
                const period = goal?.periodDescriptor?.number || 1;
                const time = goal?.timeInPeriod || '';

                // Get scorer and assists
                const scorerId = details.scoringPlayerId;
                const assist1Id = details.assist1PlayerId;
                const assist2Id = details.assist2PlayerId;

                const scorerName = scorerId ? rosterById.get(scorerId) : '';
                const assists = [];
                if (assist1Id && rosterById.has(assist1Id)) assists.push(rosterById.get(assist1Id));
                if (assist2Id && rosterById.has(assist2Id)) assists.push(rosterById.get(assist2Id));

                // Get scores from the play data
                const homeScore = goal?.homeTeamDefensiveStats?.shotsOnGoal || details.homeScore || 0;
                const awayScore = goal?.awayTeamDefensiveStats?.shotsOnGoal || details.awayScore || 0;

                // Get highlight clip from play-by-play, fallback to landing summary
                let highlightClipUrl = details.highlightClipSharingUrl || null;
                let highlightClip = details.highlightClip || null;

                // If clip missing from play-by-play, try landing summary (has English/French/discreteClip options)
                if (!highlightClip && scorerName) {
                    const landingGoal = landingSummaryGoals.get(`${scorerId}-${details.scoringPlayerId}`);
                    if (!landingGoal) {
                        // Search by name instead if ID lookup fails
                        for (let [, lg] of landingSummaryGoals) {
                            if (lg.timeInPeriod === time && lg.periodDescriptor?.number === period) {
                                highlightClip = lg.highlightClip || lg.highlightClipFr || lg.discreteClip || null;
                                highlightClipUrl = lg.highlightClipSharingUrl || lg.highlightClipSharingUrlFr || null;
                                debugLog('Found clip from landing summary for goal at P' + period + ' ' + time);
                                break;
                            }
                        }
                    } else {
                        highlightClip = landingGoal.highlightClip || landingGoal.highlightClipFr || landingGoal.discreteClip || null;
                        highlightClipUrl = landingGoal.highlightClipSharingUrl || landingGoal.highlightClipSharingUrlFr || null;
                    }
                }

                // Debug log first goal to see full structure
                if (index === 0) {
                    debugLog('First goal full API response:', JSON.stringify(goal, null, 2));
                    debugLog('First goal - all keys:', Object.keys(goal));
                }

                return {
                    period,
                    time,
                    scorerName,
                    assists,
                    homeScore,
                    awayScore,
                    highlightClipUrl,
                    highlightClip,
                    play: goal // Keep full play data for reference
                };
            });

            debugLog('Updated goalsData:', goalsData.length, goalsData);
        }

        function updateVenueHeader() {
            if (!scheduleData?.games) return;
            
            const now = new Date();
            const today = getTodayLocalMidnight();
            
            // Check if current game is today and not finished
            let currentGame = null;
            for (const game of scheduleData.games) {
                const gameDay = getGameDayDate(game);
                if (gameDay && gameDay.getTime() === today.getTime() && game.gameState !== 'OFF') {
                    currentGame = game;
                    break;
                }
            }
            
            // If game is today and not finished, show current venue
            if (currentGame && (currentGame.gameState === 'LIVE' || currentGame.gameState === 'CRIT')) {
                const venueName = currentGame.venue?.default || 'ARENA';
                document.getElementById('venueName').textContent = String(venueName).toUpperCase();
                document.getElementById('venueLocation').textContent = currentGame.venueLocation?.default || '';
                document.getElementById('gameCountdown').textContent = '';
                document.getElementById('countdownTimer').textContent = '';
                return;
            }
            
            // Otherwise show next game
            const futureGames = scheduleData.games
                .filter(g => {
                    const gameStart = getGameStartDate(g);
                    return gameStart && gameStart > now;
                })
                .sort((a, b) => {
                    const aStart = getGameStartDate(a);
                    const bStart = getGameStartDate(b);
                    return (aStart?.getTime() || 0) - (bStart?.getTime() || 0);
                });
            
            if (futureGames.length > 0) {
                const nextGame = futureGames[0];
                const gameDate = getGameStartDate(nextGame) || new Date();
                const isHome = nextGame.homeTeam.abbrev === UTAH_TEAM_ABBREV;
                
                // Show next game venue
                const venueName = nextGame.venue?.default || 'ARENA';
                const venueCity = nextGame.venueLocation?.default || '';
                
                document.getElementById('venueName').textContent = String(venueName).toUpperCase();
                document.getElementById('venueLocation').textContent = venueCity;
                
                 // Show game time and opponent
                 const opponent = isHome ? nextGame.awayTeam.abbrev : nextGame.homeTeam.abbrev;
                 const gameTime = gameDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                 const gameDay = gameDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

                 // Next game broadcasts (if present in schedule)
                 const broadcasts = (nextGame.tvBroadcasts || [])
                     .map(b => b?.network)
                     .filter(Boolean);
                 const broadcastText = broadcasts.length ? `  ${broadcasts.join(' / ')}` : '';
                 
                 document.getElementById('gameCountdown').textContent = 
                     `NEXT GAME: ${isHome ? 'vs' : '@'} ${opponent}  ${gameDay}  ${gameTime}${broadcastText}`;

                
                // Countdown timer
                updateCountdown(gameDate);
            }
        }

        function updateCountdown(targetDate) {
            const now = new Date();
            const diff = targetDate - now;
            
            if (diff <= 0) {
                document.getElementById('countdownTimer').textContent = '';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            let countdownText = '';
            if (days > 0) {
                countdownText = `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                countdownText = `${hours}h ${minutes}m ${seconds}s`;
            } else {
                countdownText = `${minutes}m ${seconds}s`;
            }
            
            document.getElementById('countdownTimer').textContent = countdownText;
        }

        function updateScoreboard() {
            if (!gameData) {
                document.getElementById('gameStatus').textContent = 'No Game Data';
                return;
            }
            debugLog('Full gameData:', gameData);

            
            // Handle different data structures
            const game = gameData.game || gameData;
            const teams = gameData.teams || { home: gameData.homeTeam, away: gameData.awayTeam };
            
            if (!teams || !teams.home || !teams.away) {
                debugLog('Missing team data:', gameData);
                document.getElementById('gameStatus').textContent = 'Loading...';
                return;
            }
            
            const utahIsHome = teams.home?.abbrev === UTAH_TEAM_ABBREV;
            const utahTeam = utahIsHome ? teams.home : teams.away;
            const oppTeam = utahIsHome ? teams.away : teams.home;
            
            debugLog('Utah team:', utahTeam);
            debugLog('Opp team:', oppTeam);
            
            // Update venue name
            if (game.venue) {
                const venueName = game.venue.name || game.venue.default || 'ARENA';
                document.getElementById('venueName').textContent = String(venueName).toUpperCase();
                const city = game.venue.city || game.venue.default || '';
                const state = game.venue.state || '';
                document.getElementById('venueLocation').textContent = city ? 
                    `${city}${state ? ', ' + state : ''}` : 
                    'Unknown Location';
            }
            
            // Status - with OT/SO detection
            const rawState = game.gameState || 'LIVE';
            let status = rawState;
            if (status === 'OFF') status = 'FINAL';
            if (status === 'FUT') status = 'UPCOMING';

            // Check for OT/SO from play-by-play data
            if ((status === 'FINAL' || status === 'LIVE') && gameData?.playByPlay?.plays) {
                const maxPeriod = Math.max(...gameData.playByPlay.plays.map(p => p?.periodDescriptor?.number || 0));
                if (maxPeriod > 3) {
                    // Check if shootout (period 5+) or just OT (period 4)
                    const hasSshootout = gameData.playByPlay.plays.some(p => p?.periodDescriptor?.periodType === 'SO' || p?.typeDescKey === 'shootout-goal' || p?.typeDescKey === 'shootout-attempt');
                    if (hasSshootout) {
                        status = `${status} (SO)`;
                    } else {
                        status = `${status} (OT)`;
                    }
                }
            }

            document.getElementById('gameStatus').textContent = status;

            // Live / Pregame indicator
            const isLive = rawState === 'LIVE' || rawState === 'CRIT';

            const gameStart = getGameStartDate(game) || getGameStartDate(gameData);
            const msUntilStart = gameStart ? (gameStart.getTime() - Date.now()) : null;
            const isPregameWindow = rawState === 'FUT' && msUntilStart !== null && msUntilStart <= 60 * 60 * 1000 && msUntilStart >= 0;

            const badge = document.getElementById('liveBadge');
            const badgeText = document.getElementById('liveBadgeText');

            badge.classList.toggle('on', isLive || isPregameWindow);
            badge.classList.toggle('live', isLive);
            badge.classList.toggle('pregame', !isLive && isPregameWindow);
            badgeText.textContent = isLive ? 'LIVE' : (isPregameWindow ? 'PREGAME' : '');
            
            // Extract team names - try all possible properties
            function getTeamName(team) {
                if (!team) return 'TEAM';
                
                // Try different property paths
                if (typeof team.name === 'string') return team.name;
                if (team.name?.default) return team.name.default;
                if (team.commonName?.default) return team.commonName.default;
                if (team.placeName?.default) return team.placeName.default;
                if (team.abbrev) return team.abbrev;
                
                return 'TEAM';
            }
            
            const utahName = getTeamName(utahTeam);
            const oppName = getTeamName(oppTeam);
            
            debugLog('Utah name:', utahName);
            debugLog('Opp name:', oppName);
            
            document.getElementById('utahName').textContent = String(utahName).toUpperCase();
            document.getElementById('oppName').textContent = String(oppName).toUpperCase();

            // Apply team colors to both teams
            const utahAbbrev = utahTeam.abbrev || UTAH_TEAM_ABBREV;
            const utahColor = TEAM_COLORS[utahAbbrev] || selectedTeam?.color || '#69B3E7';
            const oppAbbrev = oppTeam.abbrev;
            const oppColor = TEAM_COLORS[oppAbbrev] || '#fff';

            // Apply Utah/home team color
            const utahNameEl = document.getElementById('utahName');
            const utahScoreEl = document.getElementById('utahScore');
            if (utahNameEl) {
                utahNameEl.style.color = utahColor;
            }
            if (utahScoreEl) {
                utahScoreEl.style.color = utahColor;
            }

            // Apply opponent team color
            const oppNameEl = document.getElementById('oppName');
            const oppScoreEl = document.getElementById('oppScore');
            if (oppNameEl) {
                oppNameEl.style.color = oppColor;
            }
            if (oppScoreEl) {
                oppScoreEl.style.color = oppColor;
            }

            // Team records under logos (prefer standings; fallback to game payload)
            function formatRecordFromStandings(teamAbbrev) {
                const rows = standingsData?.standings;
                const abbrev = normalizeTeamAbbrev(teamAbbrev);
                if (!Array.isArray(rows) || !abbrev) return '';
                const row = rows.find(r => r?.teamAbbrev?.default === abbrev);
                if (!row) return '';
                const w = row.wins;
                const l = row.losses;
                const ot = row.otLosses;
                if (w == null || l == null || ot == null) return '';
                return `${w}-${l}-${ot}`;
            }

            function formatRecordFromTeam(team) {
                if (!team) return '';
                const w = team.wins ?? team.record?.wins;
                const l = team.losses ?? team.record?.losses;
                const ot = team.otLosses ?? team.record?.otLosses;
                if (w == null || l == null || ot == null) return '';
                return `${w}-${l}-${ot}`;
            }

            const utahRec = formatRecordFromStandings(utahTeam.abbrev) || formatRecordFromTeam(utahTeam);
            const oppRec = formatRecordFromStandings(oppTeam.abbrev) || formatRecordFromTeam(oppTeam);
            document.getElementById('utahRecord').textContent = utahRec;
            document.getElementById('oppRecord').textContent = oppRec;
            const utahScoreVal = utahTeam.score ?? null;
            const oppScoreVal = oppTeam.score ?? null;

            // GOAL banner (only when following the same gameId)
            if ((rawState === 'LIVE' || rawState === 'CRIT') && currentGameId) {
                const sameGame = lastKnownScore.gameId === currentGameId;

                if (sameGame) {
                    if (lastKnownScore.utah !== null && utahScoreVal !== null && utahScoreVal > lastKnownScore.utah) {
                        const latest = getLatestGoalFromLandingSummary();
                        if (latest && latest.eventId && latest.eventId !== lastGoalEventId) {
                            lastGoalEventId = latest.eventId;
                            showGoalBanner(latest);
                        } else {
                            showGoalBanner({ teamAbbrev: UTAH_TEAM_ABBREV });
                        }
                    } else if (lastKnownScore.opp !== null && oppScoreVal !== null && oppScoreVal > lastKnownScore.opp) {
                        const latest = getLatestGoalFromLandingSummary();
                        if (latest && latest.eventId && latest.eventId !== lastGoalEventId) {
                            lastGoalEventId = latest.eventId;
                            showGoalBanner(latest);
                        } else {
                            showGoalBanner({ teamAbbrev: String(oppTeam.abbrev || 'OPP') });
                        }
                    }
                }

                lastKnownScore = { utah: utahScoreVal, opp: oppScoreVal, gameId: currentGameId };
            } else {
                // reset tracking when not live
                lastKnownScore = { utah: utahScoreVal, opp: oppScoreVal, gameId: currentGameId };
            }

            document.getElementById('utahScore').textContent = utahScoreVal ?? '-';
            document.getElementById('oppScore').textContent = oppScoreVal ?? '-';
            
            // Logos
            document.getElementById('utahLogo').src = getTeamLogoUrl(utahTeam.abbrev || UTAH_TEAM_ABBREV);
            document.getElementById('oppLogo').src = getTeamLogoUrl(oppTeam.abbrev || 'OPP');
            
            // Period/Clock (includes intermissions)
            const periodInfo = game.periodDescriptor || {};
            const clock = game.clock || {};

            const periodNumber = periodInfo?.number;
            const periodType = periodInfo?.periodType; // REG, OT, SO
            const inIntermission = clock?.inIntermission === true;

            function ordinal(n) {
                if (n === 1) return '1ST';
                if (n === 2) return '2ND';
                if (n === 3) return '3RD';
                return `${n}TH`;
            }

            let periodText = '-';
            let clockText = '';

            // Clock value can be an object ({timeRemaining}) or a string in some payloads
            const timeRemaining = typeof clock === 'string' ? clock : (clock?.timeRemaining || '--:--');

            if (status === 'FINAL') {
                if (periodType === 'SO') {
                    periodText = 'FINAL/SO';
                } else if (periodType === 'OT') {
                    periodText = 'FINAL/OT';
                } else {
                    periodText = 'FINAL';
                }
                clockText = '';
            } else if (rawState === 'FUT' || rawState === 'PRE') {
                // Upcoming game or pregame: show countdown to puck drop
                const start = getGameStartDate(game) || getGameStartDate(gameData) || null;
                periodText = 'PUCK DROP';
                if (start) {
                    const now = new Date();
                    const diff = start - now;
                    if (diff > 0) {
                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        if (days > 0) {
                            clockText = `${days}d ${hours}h ${minutes}m`;
                        } else if (hours > 0) {
                            clockText = `${hours}h ${minutes}m ${seconds}s`;
                        } else {
                            clockText = `${minutes}m ${seconds}s`;
                        }
                    } else {
                        clockText = 'STARTING SOON';
                    }
                } else {
                    clockText = '';
                }
            } else if (inIntermission) {
                // Intermissions: NHL API keeps periodNumber on the period that just ended
                if (periodType === 'OT') {
                    periodText = 'OT INT';
                } else if (periodNumber === 1) {
                    periodText = '1ST INT';
                } else if (periodNumber === 2) {
                    periodText = '2ND INT';
                } else {
                    periodText = 'INT';
                }
                clockText = timeRemaining;
            } else {
                // In-period
                if (periodType === 'SO') {
                    periodText = 'SHOOTOUT';
                    clockText = '';
                } else if (periodType === 'OT') {
                    periodText = 'OT';
                    clockText = timeRemaining;
                } else if (typeof periodNumber === 'number') {
                    periodText = ordinal(periodNumber);
                    clockText = timeRemaining;
                } else {
                    periodText = '-';
                    clockText = timeRemaining;
                }
            }

            document.getElementById('period').textContent = periodText;
            document.getElementById('clock').textContent = clockText || '';

            // Postgame 3 Stars (only show after FINAL)
            const starsEl = document.getElementById('threeStars');
            if (status === 'FINAL') {
                const stars = gameData?.landingSummary?.threeStars;
                if (Array.isArray(stars) && stars.length) {
                    const sortedStars = [...stars].sort((a, b) => (a.star || 99) - (b.star || 99));
                    starsEl.innerHTML = `
                        <div class="three-stars">
                            <div class="three-stars-title">3 Stars of the Game</div>
                            <div class="stars-grid">
                                ${sortedStars.slice(0, 3).map(s => {
                                    const name = s?.name?.default || 'Player';
                                    const teamAbbrev = s?.teamAbbrev || '';
                                    const isUtahPlayer = teamAbbrev === UTAH_TEAM_ABBREV;
                                    const teamColor = isUtahPlayer ? (TEAM_COLORS[UTAH_TEAM_ABBREV] || selectedTeam?.color || '#69B3E7') : (TEAM_COLORS[teamAbbrev] || '#888');
                                    const teamLogo = getTeamLogoUrl(teamAbbrev);
                                    const pts = (s?.points ?? ((s?.goals || 0) + (s?.assists || 0)));
                                    const line = `${s?.goals || 0}G ${s?.assists || 0}A  ${pts} PTS`;
                                    return `
                                        <div class="star-card" style="--star-team-color: ${teamColor}; --star-team-logo: url('${teamLogo}')">
                                            <div class="star-rank"> ${s.star || ''}</div>
                                            ${s?.headshot ? `<img src="${s.headshot}" alt="${name}" onerror="this.style.display='none'">` : ''}
                                            <div class="star-name">${name}</div>
                                            <div class="stat-subtext">${teamAbbrev}</div>
                                            <div class="star-stats">${line}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    starsEl.innerHTML = '';
                }
            } else {
                starsEl.innerHTML = '';
            }

            // Update last meeting info
            updateLastMeeting(oppTeam.abbrev);

            // Update goal scorers on scoreboard
            updateGoalScorers(utahIsHome);
        }

        // Update goal scorers displayed on scoreboard
        function updateGoalScorers(utahIsHome) {
            const utahScorersEl = document.getElementById('utahGoalScorers');
            const oppScorersEl = document.getElementById('oppGoalScorers');
            if (!utahScorersEl || !oppScorersEl) return;

            const scoring = gameData?.landingSummary?.scoring;
            if (!Array.isArray(scoring)) {
                utahScorersEl.innerHTML = '';
                oppScorersEl.innerHTML = '';
                return;
            }

            // Collect all goals
            const utahGoals = [];
            const oppGoals = [];

            scoring.forEach(period => {
                const periodNum = period.periodDescriptor?.number || 0;
                const periodType = period.periodDescriptor?.periodType || 'REG';
                let periodLabel = periodNum <= 3 ? `P${periodNum}` : (periodType === 'OT' ? 'OT' : `P${periodNum}`);

                (period.goals || []).forEach(goal => {
                    const teamAbbrev = goal.teamAbbrev?.default || '';
                    const isUtahGoal = teamAbbrev === UTAH_TEAM_ABBREV;
                    const name = goal.name?.default || goal.lastName?.default || 'Goal';
                    const time = goal.timeInPeriod || '';
                    const strength = goal.strength || 'ev';
                    const goalType = strength === 'pp' ? 'PP' : (strength === 'sh' ? 'SH' : '');

                    const goalInfo = {
                        name: name,
                        time: `${periodLabel} ${time}`,
                        type: goalType,
                        teamAbbrev: teamAbbrev
                    };

                    if (isUtahGoal) {
                        utahGoals.push(goalInfo);
                    } else {
                        oppGoals.push(goalInfo);
                    }
                });
            });

            // Render all goal scorers with team logos
            const renderGoals = (goals) => {
                return goals.map(g => `
                    <div class="goal-scorer-item">
                        <img src="${getTeamLogoUrl(g.teamAbbrev)}" alt="${g.teamAbbrev}" style="width: 16px; height: 16px; border-radius: 2px;">
                        <span class="goal-scorer-name">${g.name}</span>
                        <span class="goal-scorer-time">${g.time}</span>
                        ${g.type ? `<span class="goal-scorer-type">${g.type}</span>` : ''}
                    </div>
                `).join('');
            };

            utahScorersEl.innerHTML = renderGoals(utahGoals);
            oppScorersEl.innerHTML = renderGoals(oppGoals);
        }

        // Cache for last meeting data to prevent flashing
        let lastMeetingCache = { oppAbbrev: null, gameId: null, html: null };

        function updateLastMeeting(oppAbbrev) {
            debugLog('updateLastMeeting called with:', oppAbbrev);
            const lastMeetingEl = document.getElementById('lastMeeting');
            if (!lastMeetingEl || !scheduleData?.games || !oppAbbrev) {
                debugLog('updateLastMeeting early return - el:', !!lastMeetingEl, 'games:', !!scheduleData?.games, 'opp:', oppAbbrev);
                if (lastMeetingEl && lastMeetingEl.innerHTML !== '') lastMeetingEl.innerHTML = '';
                return;
            }

            const normalizedOpp = normalizeTeamAbbrev(oppAbbrev);

            // Check if we already have cached data for this opponent
            if (lastMeetingCache.oppAbbrev === normalizedOpp && lastMeetingCache.html) {
                // Only update if content changed
                if (lastMeetingEl.innerHTML !== lastMeetingCache.html) {
                    lastMeetingEl.innerHTML = lastMeetingCache.html;
                }
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            // Find past games against this opponent
            const pastGames = scheduleData.games.filter(g => {
                if (!g.gameDate || g.gameDate >= today) return false;
                const oppInGame = g.awayTeam?.abbrev === normalizedOpp || g.homeTeam?.abbrev === normalizedOpp;
                const gameCompleted = g.gameState === 'OFF' || g.gameState === 'FINAL';
                return oppInGame && gameCompleted;
            }).sort((a, b) => new Date(b.gameDate) - new Date(a.gameDate));

            debugLog('Past games against', normalizedOpp, ':', pastGames.length);

            if (pastGames.length === 0) {
                const html = 'First matchup this season';
                lastMeetingCache = { oppAbbrev: normalizedOpp, gameId: null, html };
                if (lastMeetingEl.innerHTML !== html) lastMeetingEl.innerHTML = html;
                return;
            }

            const lastGame = pastGames[0];
            debugLog('Last game:', lastGame.id, lastGame.gameDate);

            // If we already fetched this game, don't re-fetch
            if (lastMeetingCache.oppAbbrev === normalizedOpp && lastMeetingCache.gameId === lastGame.id) {
                return;
            }

            const utahIsHome = lastGame.homeTeam?.abbrev === UTAH_TEAM_ABBREV;
            const utahScore = utahIsHome ? lastGame.homeTeam?.score : lastGame.awayTeam?.score;
            const oppScore = utahIsHome ? lastGame.awayTeam?.score : lastGame.homeTeam?.score;

            if (utahScore == null || oppScore == null) {
                lastMeetingCache = { oppAbbrev: normalizedOpp, gameId: lastGame.id, html: '' };
                if (lastMeetingEl.innerHTML !== '') lastMeetingEl.innerHTML = '';
                return;
            }

            const utahWon = utahScore > oppScore;
            const gameDate = new Date(lastGame.gameDate);
            const dateStr = gameDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            const resultClass = utahWon ? 'result-win' : 'result-loss';
            const resultText = utahWon ? 'W' : 'L';

            // Set basic info immediately
            const basicHtml = `${dateStr}  <span class="${resultClass}">${resultText} ${utahScore}-${oppScore}</span><span class="sog-info" id="lastMeetingStats"></span>`;
            lastMeetingEl.innerHTML = basicHtml;
            lastMeetingCache = { oppAbbrev: normalizedOpp, gameId: lastGame.id, html: basicHtml };

            // Fetch boxscore for shots on goal and hits
            if (lastGame.id) {
                debugLog('Fetching stats for game:', lastGame.id, 'utahIsHome:', utahIsHome);
                fetchLastGameStats(lastGame.id, utahIsHome, normalizedOpp);
            }
        }

        async function fetchLastGameStats(gameId, utahIsHome, oppAbbrev) {
            debugLog('fetchLastGameStats started for game:', gameId);
            try {
                // Fetch multiple endpoints for best chance of getting SOG
                const [landingRes, rightRailRes] = await Promise.allSettled([
                    fetch(`/api/v1/gamecenter/${gameId}/landing`),
                    fetch(`/api/v1/gamecenter/${gameId}/right-rail`)
                ]);

                debugLog('Landing response:', landingRes.status, landingRes.value?.ok);
                debugLog('RightRail response:', rightRailRes.status, rightRailRes.value?.ok);

                let data = {};

                if (landingRes.status === 'fulfilled' && landingRes.value.ok) {
                    const landing = await landingRes.value.json();
                    debugLog('Landing data keys:', Object.keys(landing));
                    data = { ...data, ...landing };
                }

                if (rightRailRes.status === 'fulfilled' && rightRailRes.value.ok) {
                    const rightRail = await rightRailRes.value.json();
                    debugLog('RightRail data keys:', Object.keys(rightRail));
                    debugLog('RightRail teamGameStats:', rightRail.teamGameStats);
                    debugLog('RightRail shotsByPeriod:', rightRail.shotsByPeriod);
                    data.rightRail = rightRail;
                }

                const statsEl = document.getElementById('lastMeetingStats');
                debugLog('Stats element found:', !!statsEl);
                if (!statsEl) return;

                let utahSog = null, oppSog = null;
                let utahHits = null, oppHits = null;

                // Try teamGameStats array from various sources
                const teamGameStats = data.teamGameStats || data.summary?.teamGameStats ||
                                      data.rightRail?.teamGameStats || [];
                debugLog('teamGameStats length:', teamGameStats.length);

                const sogStat = teamGameStats.find(s => s.category === 'sog');
                if (sogStat) {
                    debugLog('Found SOG stat:', sogStat);
                    utahSog = utahIsHome ? sogStat.homeValue : sogStat.awayValue;
                    oppSog = utahIsHome ? sogStat.awayValue : sogStat.homeValue;
                }

                const hitsStat = teamGameStats.find(s => s.category === 'hits');
                if (hitsStat) {
                    debugLog('Found Hits stat:', hitsStat);
                    utahHits = utahIsHome ? hitsStat.homeValue : hitsStat.awayValue;
                    oppHits = utahIsHome ? hitsStat.awayValue : hitsStat.homeValue;
                }

                // Try shotsByPeriod to calculate total SOG
                if (utahSog == null) {
                    const shotsByPeriod = data.shotsByPeriod || data.summary?.shotsByPeriod ||
                                          data.rightRail?.shotsByPeriod || [];
                    debugLog('shotsByPeriod length:', shotsByPeriod.length);
                    let totalHome = 0, totalAway = 0;
                    shotsByPeriod.forEach(p => {
                        totalHome += (p.home || 0);
                        totalAway += (p.away || 0);
                    });
                    if (totalHome > 0 || totalAway > 0) {
                        utahSog = utahIsHome ? totalHome : totalAway;
                        oppSog = utahIsHome ? totalAway : totalHome;
                    }
                }

                // Fallback to team.teamStats object
                if (utahSog == null) {
                    const homeStats = data?.homeTeam?.teamStats || {};
                    const awayStats = data?.awayTeam?.teamStats || {};
                    utahSog = utahIsHome ? homeStats.sog : awayStats.sog;
                    oppSog = utahIsHome ? awayStats.sog : homeStats.sog;
                }

                debugLog('Last meeting SOG result:', utahSog, oppSog);
                debugLog('Last meeting Hits result:', utahHits, oppHits);

                let statsText = '';
                if (utahSog != null && oppSog != null) {
                    statsText += `| SOG: ${utahSog}-${oppSog}`;
                }
                if (utahHits != null && oppHits != null) {
                    statsText += ` | Hits: ${utahHits}-${oppHits}`;
                }

                if (statsText) {
                    statsEl.innerHTML = statsText;
                    // Update cache with full HTML including stats
                    const lastMeetingEl = document.getElementById('lastMeeting');
                    if (lastMeetingEl && oppAbbrev) {
                        lastMeetingCache.html = lastMeetingEl.innerHTML;
                    }
                    debugLog('Stats element updated');
                } else {
                    debugLog('Stats values are null, not updating element');
                }
            } catch (e) {
                debugLog('Error fetching last game SOG:', e);
            }
        }

        // Faceoff tracking by period
        function getFaceoffTracker() {
            const pbp = gameData?.playByPlay;
            if (!pbp?.plays) return null;

            const game = gameData?.game || gameData;
            const teams = gameData?.teams || { home: gameData?.homeTeam, away: gameData?.awayTeam };
            const utahIsHome = teams?.home?.abbrev === UTAH_TEAM_ABBREV;

            // Track faceoffs by period
            const periodStats = {};
            let totalUtah = 0, totalOpp = 0;

            // Build a map of player IDs to team IDs from roster
            const playerTeamMap = new Map();
            if (Array.isArray(pbp.rosterSpots)) {
                pbp.rosterSpots.forEach(r => {
                    if (r?.playerId && r?.teamId) {
                        playerTeamMap.set(r.playerId, r.teamId);
                    }
                });
            }

            const homeTeamId = pbp.homeTeam?.id || gameData?.homeTeam?.id;
            const awayTeamId = pbp.awayTeam?.id || gameData?.awayTeam?.id;
            const utahTeamId = utahIsHome ? homeTeamId : awayTeamId;

            pbp.plays.forEach(play => {
                if (play?.typeDescKey !== 'faceoff') return;

                const period = play?.periodDescriptor?.number || 1;

                if (!periodStats[period]) {
                    periodStats[period] = { utah: 0, opp: 0 };
                }

                // Determine which team won the faceoff
                // eventOwnerTeamId is the winning team for faceoff events
                let winningTeamId = play?.details?.eventOwnerTeamId;

                // Fallback: use winningPlayerId to look up team
                if (!winningTeamId && play?.details?.winningPlayerId) {
                    winningTeamId = playerTeamMap.get(play.details.winningPlayerId);
                }

                const isUtahWin = winningTeamId === utahTeamId;

                if (isUtahWin) {
                    periodStats[period].utah++;
                    totalUtah++;
                } else {
                    periodStats[period].opp++;
                    totalOpp++;
                }
            });

            return { periodStats, totalUtah, totalOpp };
        }

        function renderFaceoffTracker() {
            const tracker = getFaceoffTracker();
            if (!tracker || (tracker.totalUtah === 0 && tracker.totalOpp === 0)) {
                return '';
            }

            const periods = Object.keys(tracker.periodStats).sort((a, b) => a - b);

            let html = '<div class="faceoff-tracker">';

            periods.forEach(period => {
                const stats = tracker.periodStats[period];
                const total = stats.utah + stats.opp;
                const utahPct = total > 0 ? ((stats.utah / total) * 100).toFixed(0) : 0;
                const oppPct = total > 0 ? ((stats.opp / total) * 100).toFixed(0) : 0;

                const periodLabel = period <= 3 ? `P${period}` : (period === 4 ? 'OT' : `OT${period - 3}`);

                html += `
                    <div class="faceoff-period-row">
                        <span class="faceoff-period-label">${periodLabel}</span>
                        <div class="faceoff-period-stats">
                            <div class="faceoff-team-stat">
                                <span class="faceoff-wins utah-fo">${stats.utah}</span>
                                <span class="faceoff-pct">(${utahPct}%)</span>
                            </div>
                            <div class="faceoff-team-stat">
                                <span class="faceoff-wins">${stats.opp}</span>
                                <span class="faceoff-pct">(${oppPct}%)</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add total row
            const total = tracker.totalUtah + tracker.totalOpp;
            const totalUtahPct = total > 0 ? ((tracker.totalUtah / total) * 100).toFixed(0) : 0;
            const totalOppPct = total > 0 ? ((tracker.totalOpp / total) * 100).toFixed(0) : 0;

            html += `
                <div class="faceoff-period-row" style="border-top: 1px solid rgba(255,255,255,0.15); margin-top: 5px; padding-top: 8px;">
                    <span class="faceoff-period-label" style="font-weight: 700;">TOTAL</span>
                    <div class="faceoff-period-stats">
                        <div class="faceoff-team-stat">
                            <span class="faceoff-wins utah-fo">${tracker.totalUtah}</span>
                            <span class="faceoff-pct">(${totalUtahPct}%)</span>
                        </div>
                        <div class="faceoff-team-stat">
                            <span class="faceoff-wins">${tracker.totalOpp}</span>
                            <span class="faceoff-pct">(${totalOppPct}%)</span>
                        </div>
                    </div>
                </div>
            `;

            html += '</div>';
            return html;
        }

        // Past game loader
        function populatePastGameSelect() {
            const select = document.getElementById('pastGameSelect');
            if (!select || !scheduleData?.games) return;

            const today = new Date().toISOString().split('T')[0];
            const pastGames = scheduleData.games
                .filter(g => g.gameDate < today && (g.gameState === 'OFF' || g.gameState === 'FINAL'))
                .sort((a, b) => new Date(b.gameDate) - new Date(a.gameDate))
                .slice(0, 20); // Last 20 games

            select.innerHTML = '<option value="">Select a past game...</option>';

            pastGames.forEach(game => {
                // Parse date in local timezone to avoid UTC conversion issues
                const parts = game.gameDate.split('-');
                const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const utahIsHome = game.homeTeam?.abbrev === UTAH_TEAM_ABBREV;
                const opponent = utahIsHome ? game.awayTeam : game.homeTeam;
                const utahScore = utahIsHome ? game.homeTeam?.score : game.awayTeam?.score;
                const oppScore = utahIsHome ? game.awayTeam?.score : game.homeTeam?.score;
                const result = utahScore > oppScore ? 'W' : 'L';
                const location = utahIsHome ? 'vs' : '@';

                select.innerHTML += `
                    <option value="${game.id}">${dateStr} ${location} ${opponent?.abbrev || 'TBD'} (${result} ${utahScore}-${oppScore})</option>
                `;
            });
        }

        async function loadPastGame(gameId) {
            const card = document.getElementById('pastGameCard');
            if (!card || !gameId) {
                if (card) card.classList.remove('active');
                return;
            }

            card.innerHTML = '<div class="loading">Loading game data...</div>';
            card.classList.add('active');

            try {
                // Fetch multiple endpoints in parallel for best chance of getting stats
                const [landingRes, boxscoreRes, rightRailRes] = await Promise.allSettled([
                    fetch(`/api/v1/gamecenter/${gameId}/landing`),
                    fetch(`/api/v1/gamecenter/${gameId}/boxscore`),
                    fetch(`/api/v1/gamecenter/${gameId}/right-rail`)
                ]);

                let gameData = {};

                // Merge data from all successful responses
                if (landingRes.status === 'fulfilled' && landingRes.value.ok) {
                    const landing = await landingRes.value.json();
                    debugLog('Past game landing:', landing);
                    gameData = { ...gameData, ...landing };
                }

                if (boxscoreRes.status === 'fulfilled' && boxscoreRes.value.ok) {
                    const boxscore = await boxscoreRes.value.json();
                    debugLog('Past game boxscore:', boxscore);
                    // Merge boxscore data, preserving existing
                    gameData.boxscore = boxscore;
                    if (!gameData.homeTeam) gameData.homeTeam = boxscore.homeTeam;
                    if (!gameData.awayTeam) gameData.awayTeam = boxscore.awayTeam;
                    if (!gameData.gameDate) gameData.gameDate = boxscore.gameDate;
                }

                if (rightRailRes.status === 'fulfilled' && rightRailRes.value.ok) {
                    const rightRail = await rightRailRes.value.json();
                    debugLog('Past game right-rail:', rightRail);
                    gameData.rightRail = rightRail;
                }

                if (!gameData.homeTeam && !gameData.awayTeam) {
                    throw new Error('No data available');
                }

                renderPastGameCard(gameData, card);
            } catch (e) {
                card.innerHTML = '<div class="loading">Unable to load game data</div>';
                debugLog('Error loading past game:', e);
            }
        }

        function renderPastGameCard(data, card, source = 'boxscore') {
            debugLog('Past game data (' + source + '):', data);

            const homeTeam = data.homeTeam;
            const awayTeam = data.awayTeam;
            const utahIsHome = homeTeam?.abbrev === UTAH_TEAM_ABBREV;

            const utahTeam = utahIsHome ? homeTeam : awayTeam;
            const oppTeam = utahIsHome ? awayTeam : homeTeam;

            const utahScore = utahTeam?.score ?? 0;
            const oppScore = oppTeam?.score ?? 0;
            const utahWon = utahScore > oppScore;

            // Debug: log all possible stat locations
            debugLog('Data keys:', Object.keys(data));
            debugLog('data.summary:', data.summary);
            debugLog('data.boxscore:', data.boxscore);
            debugLog('homeTeam keys:', homeTeam ? Object.keys(homeTeam) : 'none');
            debugLog('shotsByPeriod:', data.shotsByPeriod || data.summary?.shotsByPeriod);

            // Try multiple locations for stats
            // 1. teamGameStats array (various locations)
            // 2. rightRail.teamGameStats (right-rail endpoint)
            // 3. team.teamStats object
            const teamGameStats = data.teamGameStats || data.summary?.teamGameStats ||
                                  data.boxscore?.teamGameStats || data.rightRail?.teamGameStats || [];
            debugLog('teamGameStats:', teamGameStats);
            debugLog('rightRail data:', data.rightRail);

            const getStatValue = (category, isUtah) => {
                const stat = teamGameStats.find(s => s.category === category);
                if (!stat) return null;
                if (utahIsHome) {
                    return isUtah ? stat.homeValue : stat.awayValue;
                } else {
                    return isUtah ? stat.awayValue : stat.homeValue;
                }
            };

            // Also check for shotsByPeriod to calculate total SOG
            const shotsByPeriod = data.shotsByPeriod || data.summary?.shotsByPeriod ||
                                  data.boxscore?.shotsByPeriod || data.rightRail?.shotsByPeriod || [];
            debugLog('shotsByPeriod found:', shotsByPeriod.length, 'periods');
            let totalHomeSog = 0, totalAwaySog = 0;
            shotsByPeriod.forEach(p => {
                totalHomeSog += (p.home || 0);
                totalAwaySog += (p.away || 0);
            });
            debugLog('Calculated SOG from periods - Home:', totalHomeSog, 'Away:', totalAwaySog);

            // Try teamGameStats array first, then fall back to team stats or calculated values
            const utahRawStats = utahTeam?.teamStats || {};
            const oppRawStats = oppTeam?.teamStats || {};

            // SOG - try multiple sources
            let utahSog = getStatValue('sog', true);
            let oppSog = getStatValue('sog', false);
            if (utahSog == null && totalHomeSog > 0) {
                utahSog = utahIsHome ? totalHomeSog : totalAwaySog;
                oppSog = utahIsHome ? totalAwaySog : totalHomeSog;
            }
            utahSog = utahSog ?? utahRawStats.sog ?? '-';
            oppSog = oppSog ?? oppRawStats.sog ?? '-';

            const utahHits = getStatValue('hits', true) ?? utahRawStats.hits ?? '-';
            const oppHits = getStatValue('hits', false) ?? oppRawStats.hits ?? '-';
            const utahPim = getStatValue('pim', true) ?? utahRawStats.pim ?? '-';
            const oppPim = getStatValue('pim', false) ?? oppRawStats.pim ?? '-';
            const utahBlocked = getStatValue('blockedShots', true) ?? utahRawStats.blockedShots ?? '-';
            const oppBlocked = getStatValue('blockedShots', false) ?? oppRawStats.blockedShots ?? '-';

            // Faceoff percentage
            const utahFoRaw = getStatValue('faceoffWinningPctg', true) ?? utahRawStats.faceoffWinningPctg;
            const oppFoRaw = getStatValue('faceoffWinningPctg', false) ?? oppRawStats.faceoffWinningPctg;
            const utahFo = utahFoRaw != null ? ((utahFoRaw > 1 ? utahFoRaw : utahFoRaw * 100).toFixed(1)) + '%' : '-';
            const oppFo = oppFoRaw != null ? ((oppFoRaw > 1 ? oppFoRaw : oppFoRaw * 100).toFixed(1)) + '%' : '-';

            // Power play
            const utahPp = getStatValue('powerPlay', true) ?? utahRawStats.powerPlayConversion ?? '-';
            const oppPp = getStatValue('powerPlay', false) ?? oppRawStats.powerPlayConversion ?? '-';

            // Get game date (parse the date string directly without timezone conversion)
            let gameDate = '';
            if (data.gameDate) {
                const parts = data.gameDate.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                    const day = parseInt(parts[2]);
                    // Create date at noon to avoid timezone issues
                    const date = new Date(year, month, day, 12, 0, 0);
                    gameDate = date.toLocaleDateString('en-US', {
                        weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
                    });
                    console.log('Game date debug:', data.gameDate, '->', gameDate);
                }
            }

            debugLog('Extracted stats - SOG:', utahSog, oppSog, 'Hits:', utahHits, oppHits);

            card.innerHTML = `
                ${gameDate ? `<div style="text-align: center; color: #888; font-size: 13px; margin-bottom: 15px; letter-spacing: 1px;">${gameDate}</div>` : ''}
                <div class="past-game-matchup">
                    <div class="past-game-team">
                        <img src="${getTeamLogoUrl(utahTeam?.abbrev)}" alt="${utahTeam?.abbrev}">
                        <div class="past-game-team-name">${utahTeam?.name?.default || utahTeam?.abbrev || 'Utah'}</div>
                        <div class="past-game-score ${utahWon ? 'winner' : ''}">${utahScore}</div>
                    </div>
                    <div class="past-game-vs">FINAL</div>
                    <div class="past-game-team">
                        <img src="${getTeamLogoUrl(oppTeam?.abbrev)}" alt="${oppTeam?.abbrev}">
                        <div class="past-game-team-name">${oppTeam?.name?.default || oppTeam?.abbrev || 'OPP'}</div>
                        <div class="past-game-score ${!utahWon ? 'winner' : ''}">${oppScore}</div>
                    </div>
                </div>
                <div style="text-align: center; margin: 15px 0;">
                    <button onclick="openPastGameHighlights(${data.id})" style="
                        background: #FF0000;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        font-weight: bold;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                         Watch Highlights
                    </button>
                </div>
                <div class="past-game-stats">
                    <div class="past-game-stat">
                        <div class="past-game-stat-label">Shots on Goal</div>
                        <div class="past-game-stat-values">
                            <span class="past-game-stat-value utah">${utahSog}</span>
                            <span class="past-game-stat-value">${oppSog}</span>
                        </div>
                    </div>
                    <div class="past-game-stat">
                        <div class="past-game-stat-label">Hits</div>
                        <div class="past-game-stat-values">
                            <span class="past-game-stat-value utah">${utahHits}</span>
                            <span class="past-game-stat-value">${oppHits}</span>
                        </div>
                    </div>
                    <div class="past-game-stat">
                        <div class="past-game-stat-label">Faceoff %</div>
                        <div class="past-game-stat-values">
                            <span class="past-game-stat-value utah">${utahFo}</span>
                            <span class="past-game-stat-value">${oppFo}</span>
                        </div>
                    </div>
                    <div class="past-game-stat">
                        <div class="past-game-stat-label">Power Play</div>
                        <div class="past-game-stat-values">
                            <span class="past-game-stat-value utah">${utahPp}</span>
                            <span class="past-game-stat-value">${oppPp}</span>
                        </div>
                    </div>
                    <div class="past-game-stat">
                        <div class="past-game-stat-label">PIM</div>
                        <div class="past-game-stat-values">
                            <span class="past-game-stat-value utah">${utahPim}</span>
                            <span class="past-game-stat-value">${oppPim}</span>
                        </div>
                    </div>
                    <div class="past-game-stat">
                        <div class="past-game-stat-label">Blocked Shots</div>
                        <div class="past-game-stat-values">
                            <span class="past-game-stat-value utah">${utahBlocked}</span>
                            <span class="past-game-stat-value">${oppBlocked}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const statsEl = document.getElementById('statsGrid');

            function getRightRailStat(category) {
                const list = rightRailData?.teamGameStats;
                if (!Array.isArray(list)) return null;
                return list.find(s => s?.category === category) || null;
            }

            function getShotsByPeriodHtml(utahIsHome) {
                const list = rightRailData?.shotsByPeriod;
                if (!Array.isArray(list) || list.length === 0) return '';

                // Format: [{periodDescriptor:{number,periodType}, away: X, home: Y}, ...]
                const relevant = list
                    .filter(p => (p?.periodDescriptor?.periodType || 'REG') === 'REG')
                    .slice(0, 3);

                if (relevant.length === 0) return '';

                const pills = relevant.map(p => {
                    const n = p?.periodDescriptor?.number;
                    const label = n ? `P${n}` : 'P';
                    const utahVal = utahIsHome ? p?.home : p?.away;
                    const oppVal = utahIsHome ? p?.away : p?.home;
                    return `
                        <div class="shots-pill">
                            <div class="label">${label}</div>
                            <div class="nums"><span class="utah-stat">${utahVal ?? 0}</span> - ${oppVal ?? 0}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="stat-subtext">Shots by period</div>
                    <div class="shots-by-period">${pills}</div>
                `;
            }

            function getPenaltiesHtml() {
                const pbp = gameData?.playByPlay;
                if (!pbp?.plays || pbp.plays.length === 0) return '';

                const rosterById = new Map();
                if (Array.isArray(pbp.rosterSpots)) {
                    for (const r of pbp.rosterSpots) {
                        if (r?.playerId) rosterById.set(r.playerId, r);
                    }
                }

                function titleCase(s) {
                    return String(s || '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                }

                function playerName(id) {
                    const r = rosterById.get(id);
                    if (!r) return 'Penalty';
                    return `${r.firstName?.default || ''} ${r.lastName?.default || ''}`.trim() || 'Penalty';
                }

                function playerHeadshot(id) {
                    const r = rosterById.get(id);
                    return r?.headshot || '';
                }

                const penalties = pbp.plays
                    .filter(p => p?.typeDescKey === 'penalty')
                    .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

                if (penalties.length === 0) return '';

                const items = penalties.slice(-6).reverse().map(p => {
                    const d = p?.details || {};
                    const team = d?.eventOwnerTeamAbbrev || d?.teamAbbrev || '';
                    const committedId = d?.committedByPlayerId;
                    const drawnId = d?.drawnByPlayerId;

                    const who = committedId ? playerName(committedId) : 'Penalty';
                    const headshot = committedId ? playerHeadshot(committedId) : '';

                    const infraction = titleCase(d?.descKey || 'Penalty');
                    const mins = d?.duration ? `${d.duration} min` : '';
                    const drawnBy = drawnId ? `  Drawn by ${playerName(drawnId)}` : '';

                    const per = p?.periodDescriptor?.number ? `P${p.periodDescriptor.number}` : '';
                    const time = p?.timeInPeriod || '';
                    const when = [per, time].filter(Boolean).join(' ');

                    return `
                        <div class="penalty-item">
                            ${headshot ? `<img class="penalty-headshot" src="${headshot}" alt="" onerror="this.style.display='none'">` : ''}
                            <div class="penalty-meta">
                                <div class="who">${who}</div>
                                <div class="what">${team ? team + '  ' : ''}${infraction}${mins ? `  ${mins}` : ''}${drawnBy}</div>
                            </div>
                            <div class="penalty-time">${when}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="stat-subtext">Recent penalties</div>
                    <div class="penalty-list">${items}</div>
                `;
            }

            // Determine if Utah is home/away using whatever game data we have.
            const game = gameData?.game || gameData;
            const teams = gameData?.teams || { home: gameData?.homeTeam, away: gameData?.awayTeam };
            const utahIsHome = teams?.home?.abbrev === UTAH_TEAM_ABBREV;

            // Prefer right-rail stats (most reliable for SOG/PP/Hits/FO%).
            const sog = getRightRailStat('sog');
            const foPct = getRightRailStat('faceoffWinningPctg');
            const pp = getRightRailStat('powerPlay');
            const hits = getRightRailStat('hits');

            if (sog && foPct && pp && hits) {
                const utahSog = utahIsHome ? sog.homeValue : sog.awayValue;
                const oppSog = utahIsHome ? sog.awayValue : sog.homeValue;

                const utahHits = utahIsHome ? hits.homeValue : hits.awayValue;
                const oppHits = utahIsHome ? hits.awayValue : hits.homeValue;

                const utahFo = utahIsHome ? foPct.homeValue : foPct.awayValue;
                const oppFo = utahIsHome ? foPct.awayValue : foPct.homeValue;

                const utahPp = utahIsHome ? pp.homeValue : pp.awayValue;
                const oppPp = utahIsHome ? pp.awayValue : pp.homeValue;

                const shotsByPeriodHtml = getShotsByPeriodHtml(utahIsHome);
                const penaltiesHtml = getPenaltiesHtml();

                // Update inline scoreboard stats
                const utahSogInline = document.getElementById('utahSogInline');
                const utahHitsInline = document.getElementById('utahHitsInline');
                const oppSogInline = document.getElementById('oppSogInline');
                const oppHitsInline = document.getElementById('oppHitsInline');
                if (utahSogInline) utahSogInline.textContent = utahSog ?? 0;
                if (utahHitsInline) utahHitsInline.textContent = utahHits ?? 0;
                if (oppSogInline) oppSogInline.textContent = oppSog ?? 0;
                if (oppHitsInline) oppHitsInline.textContent = oppHits ?? 0;

                // Update Faceoff side card
                const utahFoPctEl = document.getElementById('utahFoPct');
                const oppFoPctEl = document.getElementById('oppFoPct');
                const oppFoLabelEl = document.getElementById('oppFoLabel');
                if (utahFoPctEl) utahFoPctEl.textContent = `${((utahFo || 0) * 100).toFixed(0)}%`;
                if (oppFoPctEl) oppFoPctEl.textContent = `${((oppFo || 0) * 100).toFixed(0)}%`;

                // Update PP side card
                const utahPpValEl = document.getElementById('utahPpVal');
                const oppPpValEl = document.getElementById('oppPpVal');
                const oppPpLabelEl = document.getElementById('oppPpLabel');
                if (utahPpValEl) utahPpValEl.textContent = utahPp || '0/0';
                if (oppPpValEl) oppPpValEl.textContent = oppPp || '0/0';

                // Update opponent labels and colors
                const oppAbbrev = utahIsHome ? teams?.away?.abbrev : teams?.home?.abbrev;
                if (oppFoLabelEl && oppAbbrev) oppFoLabelEl.textContent = oppAbbrev;
                if (oppPpLabelEl && oppAbbrev) oppPpLabelEl.textContent = oppAbbrev;

                // Apply opponent color to side cards
                const oppColor = TEAM_COLORS[oppAbbrev] || '#888';
                document.querySelectorAll('.side-stat-team.opp').forEach(el => {
                    el.style.borderLeftColor = oppColor;
                });

                // Update penalties mini in PP card
                const penaltiesMini = document.getElementById('penaltiesMini');
                if (penaltiesMini) {
                    const pbp = gameData?.playByPlay;
                    if (pbp?.plays) {
                        const penalties = pbp.plays
                            .filter(p => p?.typeDescKey === 'penalty')
                            .slice(-4).reverse();
                        if (penalties.length > 0) {
                            penaltiesMini.innerHTML = penalties.map(p => {
                                const d = p?.details || {};
                                const team = d?.eventOwnerTeamAbbrev || '';
                                const desc = d?.descKey?.replace(/-/g, ' ') || 'Penalty';
                                return `<div class="penalty-mini-item"><span class="penalty-mini-team">${team}</span><span class="penalty-mini-type">${desc}</span></div>`;
                            }).join('');
                        } else {
                            penaltiesMini.innerHTML = '<div style="color:#666;font-size:9px;">No penalties</div>';
                        }
                    }
                }

                // Update faceoff tracker mini
                const faceoffTrackerMini = document.getElementById('faceoffTrackerMini');
                if (faceoffTrackerMini) {
                    faceoffTrackerMini.innerHTML = renderFaceoffTracker();
                }

                if (!statsEl) return;

                statsEl.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-title">Shots on Goal</div>
                        <div class="stat-comparison">
                            <span class="stat-value utah-stat">${utahSog ?? 0}</span>
                            <span class="stat-value">${oppSog ?? 0}</span>
                        </div>
                        <div class="stat-bar-container">
                            <div class="stat-bar" style="width: ${getStatPercent(utahSog, oppSog)}%"></div>
                        </div>
                        ${shotsByPeriodHtml}
                    </div>

                    <div class="stat-card">
                        <div class="stat-title">Power Play</div>
                        <div class="stat-comparison">
                            <span class="stat-value utah-stat">${utahPp || '0/0'}</span>
                            <span class="stat-value">${oppPp || '0/0'}</span>
                        </div>
                        ${penaltiesHtml}
                    </div>

                    <div class="stat-card">
                        <div class="stat-title">Hits</div>
                        <div class="stat-comparison">
                            <span class="stat-value utah-stat">${utahHits ?? 0}</span>
                            <span class="stat-value">${oppHits ?? 0}</span>
                        </div>
                        <div class="stat-bar-container">
                            <div class="stat-bar" style="width: ${getStatPercent(utahHits, oppHits)}%"></div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-title">Faceoff %</div>
                        <div class="stat-comparison">
                            <span class="stat-value utah-stat">${((utahFo || 0) * 100).toFixed(1)}%</span>
                            <span class="stat-value">${((oppFo || 0) * 100).toFixed(1)}%</span>
                        </div>
                        ${renderFaceoffTracker()}
                    </div>
                `;

                return;
            }

            // Fallback: use older team stats structures if present.
            if (!gameData?.teams) {
                statsEl.innerHTML = '<div class="loading">Stats will appear when game starts</div>';
                return;
            }

            const utahStats = utahIsHome ? gameData.teams.home?.stats : gameData.teams.away?.stats;
            const oppStats = utahIsHome ? gameData.teams.away?.stats : gameData.teams.home?.stats;

            if (!utahStats || !oppStats) {
                statsEl.innerHTML = '<div class="loading">Stats will appear when game starts</div>';
                return;
            }

            const utahSogFallback = utahStats.shotsOnGoal || 0;
            const oppSogFallback = oppStats.shotsOnGoal || 0;

            statsEl.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">Shots on Goal</div>
                    <div class="stat-comparison">
                        <span class="stat-value utah-stat">${utahSogFallback}</span>
                        <span class="stat-value">${oppSogFallback}</span>
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar" style="width: ${getStatPercent(utahSogFallback, oppSogFallback)}%"></div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-title">Power Play</div>
                    <div class="stat-comparison">
                        <span class="stat-value utah-stat">${utahStats.powerPlay?.goals || 0}/${utahStats.powerPlay?.opportunities || 0}</span>
                        <span class="stat-value">${oppStats.powerPlay?.goals || 0}/${oppStats.powerPlay?.opportunities || 0}</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-title">Hits</div>
                    <div class="stat-comparison">
                        <span class="stat-value utah-stat">${utahStats.hits || 0}</span>
                        <span class="stat-value">${oppStats.hits || 0}</span>
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar" style="width: ${getStatPercent(utahStats.hits, oppStats.hits)}%"></div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-title">Faceoff %</div>
                    <div class="stat-comparison">
                        <span class="stat-value utah-stat">${((utahStats.faceoffPct || 0) * 100).toFixed(1)}%</span>
                        <span class="stat-value">${((oppStats.faceoffPct || 0) * 100).toFixed(1)}%</span>
                    </div>
                    ${renderFaceoffTracker()}
                </div>
            `;
        }

        function getStatPercent(utahVal, oppVal) {
            const total = (utahVal || 0) + (oppVal || 0);
            return total > 0 ? ((utahVal || 0) / total * 100) : 50;
        }

        // Goalie Stats
        function updateGoalieStats() {
            const container = document.getElementById('goalieContainer');
            if (!container) return;

            const boxscore = gameData?.boxscore || gameData;
            const homeTeam = boxscore?.homeTeam;
            const awayTeam = boxscore?.awayTeam;
            const rawState = gameData?.gameState || gameData?.game?.gameState || '';

            if (!homeTeam || !awayTeam) {
                container.innerHTML = '<div class="loading">Goalie stats will appear when game starts</div>';
                return;
            }

            const utahIsHome = homeTeam?.abbrev === UTAH_TEAM_ABBREV;
            const utahTeam = utahIsHome ? homeTeam : awayTeam;
            const oppTeam = utahIsHome ? awayTeam : homeTeam;

            // Get goalies from playerByGameStats or goalies array
            const getGoalies = (team, isHome) => {
                debugLog('getGoalies called for', isHome ? 'home' : 'away', 'team:', team?.abbrev);

                // First check boxscore goalies (live game data)
                if (team.goalies && Array.isArray(team.goalies) && team.goalies.length > 0) {
                    debugLog('Found boxscore goalies:', team.goalies.map(g => g.name?.default || g.lastName?.default));
                    return team.goalies;
                }

                // Try to get from playerByGameStats
                const playerStats = boxscore?.playerByGameStats;
                if (playerStats) {
                    const teamKey = isHome ? 'homeTeam' : 'awayTeam';
                    const goalies = playerStats[teamKey]?.goalies || [];
                    if (goalies.length > 0) {
                        debugLog('Found playerByGameStats goalies:', goalies.map(g => g.name?.default || g.lastName?.default));
                        return goalies;
                    }
                }

                // For pregame, check rightRailData for starter info
                if (rightRailData?.gameInfo) {
                    debugLog('Checking rightRailData.gameInfo for starters:', rightRailData.gameInfo);
                    const teamInfo = isHome ? rightRailData.gameInfo.homeTeam : rightRailData.gameInfo.awayTeam;
                    if (teamInfo?.starter) {
                        debugLog('Found starter from rightRail:', teamInfo.starter);
                        return [teamInfo.starter];
                    }
                }

                // Check landing data for goalie comparison/matchup
                if (gameData?.landingSummary?.goalieComparison) {
                    debugLog('Found goalieComparison:', gameData.landingSummary.goalieComparison);
                    const comparison = gameData.landingSummary.goalieComparison;
                    const goalie = isHome ? comparison.homeTeam : comparison.awayTeam;
                    if (goalie) return [goalie];
                }
                return [];
            };

            const utahGoalies = getGoalies(utahTeam, utahIsHome);
            const oppGoalies = getGoalies(oppTeam, !utahIsHome);

            debugLog('Utah goalies found:', utahGoalies.length, utahGoalies.map(g => ({name: g.name?.default, toi: g.toi})));
            debugLog('Opp goalies found:', oppGoalies.length, oppGoalies.map(g => ({name: g.name?.default, toi: g.toi})));

            const renderGoalie = (goalie, isUtah) => {
                if (!goalie) return '';

                const name = goalie.name?.default || `${goalie.firstName?.default || ''} ${goalie.lastName?.default || ''}`.trim() || 'Goalie';
                const sweater = goalie.sweaterNumber || goalie.jersey || '';
                const headshot = goalie.headshot || getPlayerHeadshot(goalie.playerId, isUtah ? UTAH_TEAM_ABBREV : '');

                // Get stats
                const saves = goalie.saveShotsAgainst?.split('/')[0] || goalie.saves || 0;
                const shotsAgainst = goalie.saveShotsAgainst?.split('/')[1] || goalie.shotsAgainst || 0;
                const savePct = goalie.savePctg != null ? (goalie.savePctg * 100).toFixed(1) :
                               (shotsAgainst > 0 ? ((saves / shotsAgainst) * 100).toFixed(1) : '0.0');
                const goalsAgainst = goalie.goalsAgainst ?? (shotsAgainst - saves) ?? 0;
                const toi = goalie.toi || goalie.timeOnIce || '-';

                debugLog('Goalie stats for', name, '- savePctg:', goalie.savePctg, 'saves:', saves, 'shotsAgainst:', shotsAgainst, 'calculated savePct:', savePct);

                return `
                    <div class="goalie-card ${isUtah ? 'utah' : ''}">
                        <img src="${headshot}" alt="${name}" onerror="this.style.display='none'">
                        <div class="goalie-info">
                            <div class="goalie-name">${name}</div>
                            <div class="goalie-number">#${sweater}</div>
                            <div class="goalie-stat-row">
                                <div class="goalie-stat">
                                    <div class="goalie-stat-value ${isUtah ? 'highlight' : ''}">${saves}/${shotsAgainst}</div>
                                    <div class="goalie-stat-label">Saves</div>
                                </div>
                                <div class="goalie-stat">
                                    <div class="goalie-stat-value">${savePct}%</div>
                                    <div class="goalie-stat-label">SV%</div>
                                </div>
                                <div class="goalie-stat">
                                    <div class="goalie-stat-value">${goalsAgainst}</div>
                                    <div class="goalie-stat-label">GA</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            };

            // Get the active goalie - the one currently playing (most recent TOI or first with any TOI)
            const getActiveGoalie = (goalies) => {
                if (!goalies || goalies.length === 0) return null;
                if (goalies.length === 1) return goalies[0];

                // For live games, find goalie with TOI (the one currently in net)
                // Sort by TOI descending to get the active goalie
                const sorted = [...goalies].sort((a, b) => {
                    const toiA = parseTimeToSeconds(a.toi || a.timeOnIce || '0:00');
                    const toiB = parseTimeToSeconds(b.toi || b.timeOnIce || '0:00');
                    return toiB - toiA;
                });
                return sorted[0];
            };

            // Helper to parse time string to seconds
            const parseTimeToSeconds = (toi) => {
                if (!toi || toi === '-') return 0;
                const parts = String(toi).split(':');
                if (parts.length === 2) {
                    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
                }
                return 0;
            };

            const utahGoalie = getActiveGoalie(utahGoalies);
            const oppGoalie = getActiveGoalie(oppGoalies);

            debugLog('==== GOALIE SELECTION ====');
            debugLog('utahGoalie object:', utahGoalie);
            debugLog('oppGoalie object:', oppGoalie);

            // Update compact goalie display in new layout
            const updateCompactGoalie = (goalie, prefix, teamAbbrev) => {
                const nameEl = document.getElementById(`${prefix}GoalieName`);
                const svEl = document.getElementById(`${prefix}GoalieSv`);
                const imgEl = document.getElementById(`${prefix}GoalieImg`);

                if (!goalie) {
                    if (nameEl) nameEl.textContent = 'TBD';
                    if (svEl) svEl.textContent = '-';
                    if (imgEl) imgEl.style.display = 'none';
                    return;
                }

                const name = goalie.name?.default || `${goalie.firstName?.default || ''} ${goalie.lastName?.default || ''}`.trim() || 'Goalie';
                const saves = parseInt(goalie.saveShotsAgainst?.split('/')[0]) || parseInt(goalie.saves) || 0;
                const shotsAgainst = parseInt(goalie.saveShotsAgainst?.split('/')[1]) || parseInt(goalie.shotsAgainst) || 0;
                const savePct = goalie.savePctg != null ? parseFloat(goalie.savePctg) :
                               (shotsAgainst > 0 ? (saves / shotsAgainst) : 0);
                // Format as .XXX (e.g., .923 for 92.3%) or 100% for perfect
                let savePctFormatted = '-';
                if (savePct > 0) {
                    if (savePct >= 0.999) {
                        savePctFormatted = '100%';
                    } else {
                        const pctStr = Math.round(savePct * 1000).toString().padStart(3, '0');
                        savePctFormatted = '.' + pctStr.slice(-3);
                    }
                }
                const headshot = goalie.headshot || `https://assets.nhle.com/mugs/nhl/20252026/${teamAbbrev}/${goalie.playerId}.png`;

                if (nameEl) nameEl.textContent = name.split(' ').pop(); // Last name only
                if (svEl) svEl.textContent = savePctFormatted;
                if (imgEl) {
                    imgEl.src = headshot;
                    imgEl.style.display = 'block';
                }
            };

            const oppTeamAbbrev = utahIsHome ? awayTeam?.abbrev : homeTeam?.abbrev;
            updateCompactGoalie(utahGoalie, 'utah', UTAH_TEAM_ABBREV);
            updateCompactGoalie(oppGoalie, 'opp', oppTeamAbbrev);

            // Update column styling with team colors and logos
            const utahColumn = document.querySelector('.team-stats-column.utah');
            const oppColumn = document.getElementById('oppStatsColumn');
            const utahLogo = getTeamLogoUrl(UTAH_TEAM_ABBREV);

            // Set Utah column logo
            if (utahColumn) {
                utahColumn.style.setProperty('--column-team-logo', `url('${utahLogo}')`);
            }

            // Set logo watermark on each Utah stat box
            document.querySelectorAll('.team-stats-column.utah .team-stat-item, .team-stats-column.utah .penalty-box, .team-stats-column.utah .goalie-compact').forEach(el => {
                el.style.setProperty('--box-team-logo', `url('${utahLogo}')`);
            });

            // Set opponent column color and logo
            if (oppTeamAbbrev) {
                const oppColor = TEAM_COLORS[oppTeamAbbrev] || '#888';
                const oppLogo = getTeamLogoUrl(oppTeamAbbrev);
                document.documentElement.style.setProperty('--opp-color', oppColor);

                if (oppColumn) {
                    oppColumn.style.setProperty('--column-team-logo', `url('${oppLogo}')`);
                }

                // Apply border color and logo watermark to opp column items
                document.querySelectorAll('.team-stats-column.opp .team-stat-item, .team-stats-column.opp .penalty-box, .team-stats-column.opp .goalie-compact').forEach(el => {
                    el.style.borderRightColor = oppColor;
                    el.style.setProperty('--box-team-logo', `url('${oppLogo}')`);
                });
            }

            if (!utahGoalie && !oppGoalie) {
                return;
            }

            if (container) {
                container.innerHTML = `
                    ${renderGoalie(utahGoalie, true)}
                    ${renderGoalie(oppGoalie, false)}
                `;
            }
        }

        // Power Play / Penalty Kill Detection
        function updateSpecialTeams() {
            const banner = document.getElementById('specialTeamsBanner');
            const utahPpIndicator = document.getElementById('utahPpIndicator');
            const oppPpIndicator = document.getElementById('oppPpIndicator');

            // Reset all indicators
            const resetIndicators = () => {
                if (banner) banner.classList.remove('active', 'pk');
                if (utahPpIndicator) {
                    utahPpIndicator.classList.remove('active', 'pk');
                    utahPpIndicator.querySelector('.pp-indicator-text').textContent = 'PP';
                }
                if (oppPpIndicator) {
                    oppPpIndicator.classList.remove('active', 'pk');
                    oppPpIndicator.querySelector('.pp-indicator-text').textContent = 'PP';
                }
            };

            const pbp = gameData?.playByPlay;
            const game = gameData?.game || gameData;

            // Check if game is live
            const gameState = game?.gameState || gameData?.gameState;
            if (gameState !== 'LIVE' && gameState !== 'CRIT') {
                resetIndicators();
                return;
            }

            // Get current situation from game data or calculate from penalties
            const situation = game?.situation || gameData?.situation;

            if (situation) {
                const homeSkaters = situation.homeTeam?.strength || 5;
                const awaySkaters = situation.awayTeam?.strength || 5;
                const utahIsHome = (game?.homeTeam?.abbrev || gameData?.homeTeam?.abbrev) === UTAH_TEAM_ABBREV;

                const utahSkaters = utahIsHome ? homeSkaters : awaySkaters;
                const oppSkaters = utahIsHome ? awaySkaters : homeSkaters;

                if (utahSkaters > oppSkaters) {
                    // Utah on Power Play
                    if (banner) {
                        banner.classList.add('active');
                        banner.classList.remove('pk');
                        document.getElementById('specialTeamsType').textContent = 'POWER PLAY';
                        document.getElementById('specialTeamsStrength').textContent = `${utahSkaters} on ${oppSkaters}`;
                        const timeRemaining = situation.timeRemaining || '';
                        document.getElementById('specialTeamsTime').textContent = timeRemaining || 'ACTIVE';
                    }

                    // Show PP indicator on Utah side (they have the advantage)
                    if (utahPpIndicator) {
                        utahPpIndicator.classList.add('active');
                        utahPpIndicator.classList.remove('pk');
                        utahPpIndicator.querySelector('.pp-indicator-text').textContent = 'PP';
                    }
                    if (oppPpIndicator) oppPpIndicator.classList.remove('active', 'pk');

                } else if (utahSkaters < oppSkaters) {
                    // Utah on Penalty Kill (opponent has PP)
                    if (banner) {
                        banner.classList.add('active', 'pk');
                        document.getElementById('specialTeamsType').textContent = 'PENALTY KILL';
                        document.getElementById('specialTeamsStrength').textContent = `${utahSkaters} on ${oppSkaters}`;
                        const timeRemaining = situation.timeRemaining || '';
                        document.getElementById('specialTeamsTime').textContent = timeRemaining || 'ACTIVE';
                    }

                    // Show PP indicator on Opponent side (they have the advantage)
                    if (oppPpIndicator) {
                        oppPpIndicator.classList.add('active');
                        oppPpIndicator.classList.remove('pk');
                        oppPpIndicator.querySelector('.pp-indicator-text').textContent = 'PP';
                    }
                    if (utahPpIndicator) utahPpIndicator.classList.remove('active', 'pk');

                } else {
                    resetIndicators();
                }
            } else {
                resetIndicators();
            }
        }

        // Update Penalty Boxes with active penalties
        function updatePenaltyBoxes() {
            const utahBox = document.getElementById('utahPenaltyBox');
            const oppBox = document.getElementById('oppPenaltyBox');
            if (!utahBox || !oppBox) return;

            const pbp = gameData?.playByPlay;
            const game = gameData?.game || gameData;
            const gameState = game?.gameState || gameData?.gameState;

            // Get current period and time
            const currentPeriod = gameData?.period || game?.period || 1;
            const clockStr = gameData?.clock?.timeRemaining || game?.clock?.timeRemaining || '20:00';

            // Parse clock to seconds remaining in period
            const parseTime = (timeStr) => {
                if (!timeStr) return 1200; // 20 min default
                const parts = timeStr.split(':');
                return (parseInt(parts[0] || 0) * 60) + parseInt(parts[1] || 0);
            };
            const currentTimeInPeriod = parseTime(clockStr);

            // Determine which team is Utah
            const homeTeam = game?.homeTeam || gameData?.homeTeam;
            const awayTeam = game?.awayTeam || gameData?.awayTeam;
            const utahIsHome = homeTeam?.abbrev === UTAH_TEAM_ABBREV;
            const utahAbbrev = UTAH_TEAM_ABBREV;
            const oppAbbrev = utahIsHome ? awayTeam?.abbrev : homeTeam?.abbrev;

            // Default empty state
            const renderEmpty = () => `
                <div class="penalty-box-title">Penalty Box</div>
                <div class="penalty-box-empty">Clear</div>
            `;

            // If no live game, show empty
            if (!gameState || (gameState !== 'LIVE' && gameState !== 'CRIT')) {
                utahBox.innerHTML = renderEmpty();
                oppBox.innerHTML = renderEmpty();
                return;
            }

            // Build team ID to abbreviation mapping
            const teamIdToAbbrev = {};
            if (homeTeam?.id) teamIdToAbbrev[homeTeam.id] = homeTeam.abbrev;
            if (awayTeam?.id) teamIdToAbbrev[awayTeam.id] = awayTeam.abbrev;

            // Also check play-by-play header for team info (more reliable during live games)
            if (pbp?.homeTeam?.id) teamIdToAbbrev[pbp.homeTeam.id] = pbp.homeTeam.abbrev;
            if (pbp?.awayTeam?.id) teamIdToAbbrev[pbp.awayTeam.id] = pbp.awayTeam.abbrev;

            // Build player ID to name/sweater lookup from boxscore
            const playerById = {};
            const boxscore = gameData?.boxscore || gameData;
            const addPlayers = (teamData) => {
                if (!teamData) return;
                const allPlayers = [
                    ...(teamData.forwards || []),
                    ...(teamData.defense || []),
                    ...(teamData.goalies || [])
                ];
                allPlayers.forEach(p => {
                    if (p?.playerId) {
                        playerById[p.playerId] = {
                            name: p.name?.default || 'Player',
                            sweater: p.sweaterNumber || ''
                        };
                    }
                });
            };
            debugLog('Building playerById from boxscore...');
            debugLog('homeTeam playerByGameStats exists:', !!boxscore?.playerByGameStats?.homeTeam);
            debugLog('awayTeam playerByGameStats exists:', !!boxscore?.playerByGameStats?.awayTeam);
            addPlayers(boxscore?.playerByGameStats?.homeTeam);
            addPlayers(boxscore?.playerByGameStats?.awayTeam);
            debugLog('PlayerById map has', Object.keys(playerById).length, 'players');

            // Debug: Show sample playerIds in the map
            const samplePlayerIds = Object.keys(playerById).slice(0, 10);
            debugLog('Sample playerIds in map:', samplePlayerIds);

            // Also try landing summary penalties for player names
            const landingPenalties = gameData?.landingSummary?.penalties || [];
            landingPenalties.forEach(periodPenalties => {
                (periodPenalties.penalties || []).forEach(p => {
                    if (p?.committedByPlayer) {
                        const name = `${p.committedByPlayer.firstName?.default || ''} ${p.committedByPlayer.lastName?.default || ''}`.trim();
                        if (name && p.committedByPlayer.sweaterNumber) {
                            // Store by sweater number as backup lookup
                            const team = p.teamAbbrev?.default || '';
                            const key = `${team}-${p.committedByPlayer.sweaterNumber}`;
                            playerById[key] = { name, sweater: p.committedByPlayer.sweaterNumber };
                        }
                    }
                });
            });

            // First, check if any goals have been scored that would end power plays
            // When a team scores on a power play, the power play ends and penalty is waived
            const goalsWithTimestamps = [];
            if (pbp?.plays) {
                pbp.plays.forEach(play => {
                    if (play?.typeDescKey === 'goal') {
                        goalsWithTimestamps.push({
                            scoringTeamId: play?.details?.eventOwnerTeamId,
                            period: play?.periodDescriptor?.number || 1,
                            time: play?.timeInPeriod || '00:00'
                        });
                    }
                });
            }

            // Parse active penalties from play-by-play
            const penalties = [];
            const allPenaltiesDebug = [];
            if (pbp?.plays) {
                pbp.plays.forEach(play => {
                    if (play?.typeDescKey === 'penalty') {
                        const details = play?.details || {};
                        const penaltyPeriod = play.periodDescriptor?.number || play.period || 1;

                        // HARD FILTER: Skip penalties from periods older than current period
                        // (They should not be in the plays array if properly cleaned, but enforce it)
                        if (penaltyPeriod > currentPeriod) {
                            debugLog('Skipping penalty from future period:', penaltyPeriod, 'current:', currentPeriod);
                            return;  // Skip future period penalties
                        }
                        const penaltyTime = play.timeInPeriod || '00:00';
                        const duration = details.duration || 2; // Default 2 min
                        // Map team ID to abbreviation (API returns eventOwnerTeamId, not abbrev)
                        const teamId = details.eventOwnerTeamId;
                        const team = teamIdToAbbrev[teamId] || details.eventOwnerTeamAbbrev || '';
                        const playerId = details.committedByPlayerId || null;
                        const sweaterNum = details.committedBySweaterNumber || '';

                        // Look up player name from boxscore or landing data
                        let playerName = 'Player';
                        let sweater = sweaterNum || '';

                        // DEBUG: Log all penalty lookups, especially Utah ones
                        const isUtahTeam = team === utahAbbrev;
                        debugLog('Penalty details for team', team, '(Utah?:', isUtahTeam, ') - playerId:', playerId, 'sweater:', sweater, 'details keys:', Object.keys(details).slice(0, 15));
                        debugLog('Full penalty details object:', details);

                        if (isUtahTeam && playerId) {
                            debugLog('Utah penalty playerId lookup - searching map with id:', playerId, 'map has', Object.keys(playerById).length, 'entries');
                        }

                        if (playerId && playerById[playerId]) {
                            playerName = playerById[playerId].name;
                            sweater = playerById[playerId].sweater;
                            if (isUtahTeam) debugLog(' Utah penalty: Found player in map:', playerName);
                            else debugLog(' Opp penalty: Found player in map:', playerName);
                        } else {
                            // Debug: show if playerId exists in map at all
                            if (playerId) {
                                const playerInMap = playerById.hasOwnProperty(playerId);
                                if (isUtahTeam) {
                                    debugLog(` Utah penalty: PlayerId ${playerId} in map: ${playerInMap}. Map has ${Object.keys(playerById).length} entries total.`);
                                } else {
                                    debugLog(` Opp penalty: PlayerId ${playerId} in map: ${playerInMap}. Map has ${Object.keys(playerById).length} entries total.`);
                                }
                            }

                            if (sweater && team) {
                                // Try lookup by team + sweater as fallback
                                const sweaterKey = `${team}-${sweater}`;
                                if (playerById[sweaterKey]) {
                                    playerName = playerById[sweaterKey].name;
                                    debugLog('Found player by sweater key:', playerName);
                                } else {
                                    debugLog('Sweater key not found:', sweaterKey);
                                }
                            } else if (details.committedByName) {
                                // Use name from penalty details if available
                                playerName = details.committedByName;
                                debugLog('Using name from details:', playerName);
                            } else if (playerId) {
                                debugLog('Penalty player ID not found in map:', playerId, 'Sweater:', sweater, 'Team:', team);
                            }
                        }
                        const penaltyType = details.descKey?.replace(/-/g, ' ') || 'Penalty';

                        // timeInPeriod is ELAPSED time (counts up 0:00 to 20:00)
                        // We need to convert to REMAINING time to match clock
                        const elapsedSeconds = parseTime(penaltyTime);
                        const penaltyStartRemainingSeconds = 1200 - elapsedSeconds; // Convert to remaining time
                        const penaltyEndRemainingSeconds = penaltyStartRemainingSeconds - (duration * 60);

                        // Check if penalty is still active
                        // Penalty is active if we're in the same period and time hasn't expired
                        // Or if penalty rolled over to next period
                        let isActive = false;
                        let timeRemaining = 0;

                        debugLog('Penalty check for', playerName, '- penaltyPeriod:', penaltyPeriod, 'currentPeriod:', currentPeriod, 'penaltyStartRemaining:', penaltyStartRemainingSeconds, 'penaltyEndRemaining:', penaltyEndRemainingSeconds, 'currentTimeInPeriod:', currentTimeInPeriod);

                        if (penaltyPeriod === currentPeriod) {
                            // Same period - check if current time is between penalty start and end
                            // (both in "remaining seconds" scale)
                            const shouldBeActive = currentTimeInPeriod >= penaltyEndRemainingSeconds && currentTimeInPeriod <= penaltyStartRemainingSeconds;
                            debugLog('Same period check - currentTime >= penaltyEnd?', currentTimeInPeriod, '>=', penaltyEndRemainingSeconds, '=', currentTimeInPeriod >= penaltyEndRemainingSeconds, 'AND currentTime <= penaltyStart?', currentTimeInPeriod, '<=', penaltyStartRemainingSeconds, '=', currentTimeInPeriod <= penaltyStartRemainingSeconds, '-> shouldBeActive:', shouldBeActive);
                            if (shouldBeActive) {
                                timeRemaining = Math.max(0, currentTimeInPeriod - penaltyEndRemainingSeconds);
                                isActive = timeRemaining > 0;
                            }
                        } else if (penaltyPeriod < currentPeriod) {
                            // Previous period - check if rolled over
                            // Only roll over if penalty end time was NEGATIVE (would go past end of period)
                            if (penaltyEndRemainingSeconds < 0 && penaltyPeriod === currentPeriod - 1) {
                                // Penalty rolled over: calculate how much time is left in next period
                                const secondsIntoNextPeriod = Math.abs(penaltyEndRemainingSeconds);
                                timeRemaining = Math.max(0, currentTimeInPeriod - (1200 - secondsIntoNextPeriod));
                                isActive = timeRemaining > 0;
                                debugLog('Rollover penalty from P' + penaltyPeriod + ' to P' + currentPeriod + ' - active:', isActive, 'remaining:', timeRemaining);
                            }
                        }

                        // Debug: log all penalties found
                        allPenaltiesDebug.push({
                            player: playerName,
                            team,
                            type: penaltyType,
                            duration,
                            period: penaltyPeriod,
                            time: penaltyTime,
                            isActive,
                            timeRemaining: timeRemaining > 0 ? `${Math.floor(timeRemaining/60)}:${(timeRemaining%60).toString().padStart(2,'0')}` : '0:00'
                        });

                        // STRICT: Only add penalty if it's active AND meets ALL conditions
                        // 1. Must be from current period, OR
                        // 2. Must be from immediately previous period AND have rolled over (negative end time)
                        let shouldAddPenalty = false;

                        if (penaltyPeriod === currentPeriod) {
                            // Penalty from current period - add if active
                            shouldAddPenalty = isActive;
                            if (shouldAddPenalty) debugLog('Adding current-period penalty:', playerName);
                        } else if (penaltyPeriod === currentPeriod - 1 && penaltyEndRemainingSeconds < 0 && isActive) {
                            // Penalty from previous period that rolled over - add only if explicitly rolled over
                            shouldAddPenalty = true;
                            debugLog('Adding rolled-over penalty from P' + penaltyPeriod + ':', playerName);
                        } else if (penaltyPeriod < currentPeriod - 1) {
                            // Penalty from 2+ periods ago - NEVER add
                            debugLog('REJECTING old penalty from P' + penaltyPeriod + ':', playerName, '(current period:', currentPeriod + ')');
                        }

                        if (shouldAddPenalty) {
                            // Check if a goal was scored on the power play that would waive this penalty
                            // If the team that's ON the power play (opposite team) scored after this penalty, penalty is waived
                            const teamIdWithPenalty = details.eventOwnerTeamId;
                            const otherTeam = homeTeam?.id === teamIdWithPenalty ? awayTeam?.id : homeTeam?.id;

                            // Check if the OTHER team scored after this penalty was called
                            const penaltyWaived = goalsWithTimestamps.some(goal => {
                                // Goal must be scored by the team that's on the power play (opposite of penalty team)
                                if (goal.scoringTeamId !== otherTeam) return false;
                                // Goal must be after penalty was called in same or later period
                                if (goal.period < penaltyPeriod) return false;
                                if (goal.period === penaltyPeriod) {
                                    // Same period - check if goal time is after penalty call time
                                    const goalElapsed = parseTime(goal.time);
                                    const penaltyElapsed = parseTime(penaltyTime);
                                    return goalElapsed > penaltyElapsed;
                                }
                                // Different period - goal is definitely after penalty
                                return true;
                            });

                            if (penaltyWaived) {
                                debugLog('Penalty waived due to goal scored on power play:', playerName);
                            } else {
                                const mins = Math.floor(timeRemaining / 60);
                                const secs = timeRemaining % 60;
                                const finalPlayerName = playerName.split(' ').pop(); // Last name only
                                debugLog('Active penalty:', { team, playerName: finalPlayerName, playerId, originalPlayerName: playerName, period: penaltyPeriod, currentPeriod });
                                penalties.push({
                                    team,
                                    playerName: finalPlayerName,
                                    playerId,
                                    sweater,
                                    penaltyType,
                                    timeRemaining: `${mins}:${secs.toString().padStart(2, '0')}`
                                });
                            }
                        }
                    }
                });
            }
            debugLog('ALL penalties parsed:', allPenaltiesDebug);
            debugLog('Current period:', currentPeriod, 'Current time in period:', currentTimeInPeriod, 'Clock:', clockStr);
            debugLog('Active penalties that passed the filter:', penalties);

            // Also check situation data for active penalties if available
            const situation = game?.situation || gameData?.situation;
            if (situation && gameState === 'LIVE') {
                // Update special teams banner based on situation
                const homeSkaters = situation.homeTeam?.strength || 5;
                const awaySkaters = situation.awayTeam?.strength || 5;
                const utahSkaters = utahIsHome ? homeSkaters : awaySkaters;
                const oppSkaters = utahIsHome ? awaySkaters : homeSkaters;

                // If there's an imbalance but no parsed penalties, show generic indicator
                // (Only during LIVE play, not during intermissions/stoppages)
                if ((utahSkaters !== oppSkaters) && penalties.length === 0) {
                    const timeRemaining = situation.timeRemaining || 'ACTIVE';
                    if (utahSkaters < oppSkaters) {
                        // Utah has a penalty
                        penalties.push({
                            team: utahAbbrev,
                            playerName: 'In Box',
                            playerId: null,
                            sweater: '',
                            penaltyType: '',
                            timeRemaining
                        });
                    }
                    if (oppSkaters < utahSkaters) {
                        // Opponent has a penalty
                        penalties.push({
                            team: oppAbbrev,
                            playerName: 'In Box',
                            playerId: null,
                            sweater: '',
                            penaltyType: '',
                            timeRemaining
                        });
                    }
                }
            }

            // Filter penalties by team
            // Remove generic "In Box" penalties from the fallback if we have real penalties
            const hasRealPenalties = penalties.some(p => p.playerId !== null);
            const filteredPenalties = hasRealPenalties
                ? penalties.filter(p => p.playerId !== null)  // Remove fallback "In Box" if we have real penalties
                : penalties;  // Keep fallback if no real penalties

            const utahPenalties = filteredPenalties.filter(p => p.team === utahAbbrev);
            const oppPenalties = filteredPenalties.filter(p => p.team === oppAbbrev);

            debugLog('Utah penalties after filter:', utahPenalties);
            debugLog('Opponent penalties after filter:', oppPenalties);

            // Render penalty box
            const renderPenaltyBox = (teamPenalties, isUtah) => {
                if (teamPenalties.length === 0) {
                    return renderEmpty();
                }

                const teamAbbrev = isUtah ? utahAbbrev : oppAbbrev;
                const penaltyItems = teamPenalties.map(p => {
                    // Get mugshot URL if we have a player ID
                    // Note: Team abbreviation must be UPPERCASE (UTA, DET, etc.)
                    const mugshotUrl = p.playerId
                        ? `https://assets.nhle.com/mugs/nhl/20252026/${p.team.toUpperCase()}/${p.playerId}.png`
                        : '';

                    // Debug all mugshots - both Utah and opponent
                    if (p.playerId) {
                        debugLog(`${isUtah ? ' Utah' : ' Opp'} penalty mugshot: player=${p.playerName}, team=${p.team}, playerId=${p.playerId}, url=${mugshotUrl}`);
                    }

                    const mugshotHtml = mugshotUrl
                        ? `<img class="penalty-mugshot" src="${mugshotUrl}" alt="${p.playerName}" onerror="console.log('Mugshot failed to load:', '${mugshotUrl}'); this.style.display='none'">`
                        : '';

                    return `
                    <div class="penalty-item">
                        ${mugshotHtml}
                        <div class="penalty-info">
                            <div class="penalty-player">${p.playerName}${p.sweater ? ' #' + p.sweater : ''}</div>
                            <div class="penalty-time">${p.timeRemaining}</div>
                            ${p.penaltyType ? `<div class="penalty-type">${p.penaltyType}</div>` : ''}
                        </div>
                    </div>`;
                }).join('');

                return `
                    <div class="penalty-box-title">Penalty Box</div>
                    ${penaltyItems}
                `;
            };

            const utahHTML = renderPenaltyBox(utahPenalties, true);
            const oppHTML = renderPenaltyBox(oppPenalties, false);
            debugLog('Utah penalty box HTML:', utahHTML);
            debugLog('Opponent penalty box HTML:', oppHTML);
            utahBox.innerHTML = utahHTML;
            oppBox.innerHTML = oppHTML;
        }

        // Player of the Game (Top Player)
        function updatePlayerOfGame() {
            const container = document.getElementById('topPlayerBox');
            if (!container) return;

            // Only show during/after game
            const gameState = gameData?.gameState || gameData?.game?.gameState;
            if (!gameState || gameState === 'FUT' || gameState === 'PRE') {
                container.style.opacity = '0.5';
                document.getElementById('pogName').textContent = '-';
                document.getElementById('pogStats').innerHTML = '';
                return;
            }

            const boxscore = gameData?.boxscore || gameData;
            const homeTeam = boxscore?.homeTeam;
            const awayTeam = boxscore?.awayTeam;
            const utahIsHome = homeTeam?.abbrev === UTAH_TEAM_ABBREV;
            const utahTeam = utahIsHome ? homeTeam : awayTeam;

            // Get Utah players from various sources
            let utahPlayers = [];

            // Try playerByGameStats
            const playerStats = boxscore?.playerByGameStats;
            if (playerStats) {
                const teamKey = utahIsHome ? 'homeTeam' : 'awayTeam';
                const forwards = playerStats[teamKey]?.forwards || [];
                const defense = playerStats[teamKey]?.defense || [];
                utahPlayers = [...forwards, ...defense];
            }

            // Fallback to team.skaters
            if (utahPlayers.length === 0 && utahTeam?.skaters) {
                utahPlayers = utahTeam.skaters;
            }

            if (utahPlayers.length === 0) {
                container.style.opacity = '0.5';
                return;
            }

            // Calculate "game score" for each player
            // Points = goals + assists, plus bonus for hits, blocks, etc.
            const scored = utahPlayers.map(p => {
                const goals = p.goals || 0;
                const assists = p.assists || 0;
                const points = goals + assists;
                const hits = p.hits || 0;
                const blocks = p.blockedShots || p.blocked || 0;
                const plusMinus = p.plusMinus || 0;
                const sog = p.sog || p.shots || 0;

                // Simple game score formula
                const gameScore = (goals * 3) + (assists * 2) + (hits * 0.3) + (blocks * 0.5) + (plusMinus * 0.5) + (sog * 0.2);

                return { ...p, gameScore, goals, assists, points, hits, blocks, plusMinus, sog };
            }).sort((a, b) => b.gameScore - a.gameScore);

            const topPlayer = scored[0];

            if (!topPlayer || topPlayer.gameScore <= 0) {
                container.style.opacity = '0.5';
                return;
            }

            container.style.opacity = '1';

            const name = topPlayer.name?.default || `${topPlayer.firstName?.default || ''} ${topPlayer.lastName?.default || ''}`.trim();
            const headshot = topPlayer.headshot || getPlayerHeadshot(topPlayer.playerId, UTAH_TEAM_ABBREV);

            document.getElementById('pogHeadshot').src = headshot;
            document.getElementById('pogName').textContent = name;

            // Build compact stats display
            let statParts = [];
            if (topPlayer.goals > 0) statParts.push(`${topPlayer.goals}G`);
            if (topPlayer.assists > 0) statParts.push(`${topPlayer.assists}A`);
            if (topPlayer.hits > 0) statParts.push(`${topPlayer.hits}H`);
            if (topPlayer.sog > 0) statParts.push(`${topPlayer.sog}SOG`);
            if (topPlayer.plusMinus !== 0) statParts.push(`${topPlayer.plusMinus > 0 ? '+' : ''}${topPlayer.plusMinus}`);

            document.getElementById('pogStats').textContent = statParts.length > 0 ? statParts.join('  ') : 'Top performer';
        }

        // Shot Location Chart
        let selectedShotPeriod = '1'; // Track selected period filter

        // Initialize period selector buttons
        function initPeriodSelector() {
            const buttons = document.querySelectorAll('.period-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Clean up any floating popups when changing periods
                    document.querySelectorAll('.goal-popup, .goalie-stats-popup').forEach(p => p.remove());

                    // Update active state
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // Update filter and redraw
                    selectedShotPeriod = btn.dataset.period;
                    updateShotChart();
                });
            });
        }

        // Call init once DOM is ready
        document.addEventListener('DOMContentLoaded', initPeriodSelector);

        // Goal popup on hover
        let currentGoalPopup = null;

        function showGoalPopup(event, scorer, assists, period, time) {
            // Remove existing popup if any
            hideGoalPopup();

            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'goal-popup';

            let html = `<div class="goal-popup-scorer"> ${scorer}</div>`;
            if (assists.length > 0) {
                html += `<div class="goal-popup-assist">Assist: ${assists.join(', ')}</div>`;
            }
            html += `<div class="goal-popup-assist">P${period} ${time}</div>`;

            popup.innerHTML = html;
            document.body.appendChild(popup);
            currentGoalPopup = popup;

            // Position popup near cursor
            const rect = event.target.getBoundingClientRect();
            popup.style.left = (rect.right + 10) + 'px';
            popup.style.top = (rect.top - 10) + 'px';
        }

        function hideGoalPopup() {
            if (currentGoalPopup) {
                currentGoalPopup.remove();
                currentGoalPopup = null;
            }
        }

        function updateShotChart() {
            const rink = document.getElementById('shotChartRink');
            if (!rink) return;

            // Set center logo to home team
            const centerLogo = document.getElementById('rinkCenterLogo');
            if (centerLogo) {
                const homeAbbrev = gameData?.homeTeam?.abbrev || gameData?.game?.homeTeam?.abbrev;
                if (homeAbbrev) {
                    centerLogo.src = getTeamLogoUrl(homeAbbrev);
                    centerLogo.style.display = 'block';
                }
            }

            const pbp = gameData?.playByPlay;
            if (!pbp?.plays) {
                // Clear existing shot dots but keep rink elements
                rink.querySelectorAll('.shot-dot').forEach(dot => dot.remove());
                return;
            }

            const game = gameData?.game || gameData;
            const utahIsHome = (game?.homeTeam?.abbrev || gameData?.homeTeam?.abbrev) === UTAH_TEAM_ABBREV;
            const homeTeamId = pbp.homeTeam?.id || gameData?.homeTeam?.id;
            const awayTeamId = pbp.awayTeam?.id || gameData?.awayTeam?.id;
            const utahTeamId = utahIsHome ? homeTeamId : awayTeamId;

            // Get opponent team color
            const oppAbbrev = utahIsHome
                ? (game?.awayTeam?.abbrev || gameData?.awayTeam?.abbrev)
                : (game?.homeTeam?.abbrev || gameData?.homeTeam?.abbrev);
            const oppColor = TEAM_COLORS[oppAbbrev] || '#f44336';
            const utahColor = TEAM_COLORS[UTAH_TEAM_ABBREV] || selectedTeam?.color || '#69B3E7';

            // Update legend colors and name dynamically
            const oppLegendDot = document.querySelector('.shot-chart-legend-dot.opp');
            if (oppLegendDot) oppLegendDot.style.background = oppColor;
            const oppLegendName = document.getElementById('oppLegendName');
            if (oppLegendName && oppAbbrev) oppLegendName.textContent = oppAbbrev;

            const utahLegendDot = document.querySelector('.shot-chart-legend-dot.utah');
            if (utahLegendDot) utahLegendDot.style.background = utahColor;
            const utahLegendName = document.getElementById('utahLegendName');
            if (utahLegendName) utahLegendName.textContent = UTAH_TEAM_ABBREV;

            // Update zone-stat opp color
            const oppZoneStat = document.querySelector('.zone-stat.opp');
            if (oppZoneStat) {
                oppZoneStat.style.borderLeftColor = oppColor;
                const oppPctSpan = oppZoneStat.querySelector('span:last-child');
                if (oppPctSpan) oppPctSpan.style.color = oppColor;
            }

            // Clear existing shot dots
            rink.querySelectorAll('.shot-dot').forEach(dot => dot.remove());

            // Filter for shot and goal events
            const shotEvents = pbp.plays.filter(p => {
                const type = p?.typeDescKey;
                return type === 'shot-on-goal' || type === 'goal' || type === 'missed-shot' || type === 'blocked-shot';
            });

            // Check if there's OT and show/hide OT button
            const hasOT = shotEvents.some(s => (s?.periodDescriptor?.number || 0) > 3);
            const otBtn = document.getElementById('otPeriodBtn');
            if (otBtn) {
                otBtn.style.display = hasOT ? 'block' : 'none';
            }

            // Track shots inside faceoff circles vs outside
            // Offensive zone faceoff circles are at x=69, y=22 with radius of 15 feet
            let utahTotal = 0, utahInCircle = 0;
            let oppTotal = 0, oppInCircle = 0;

            const isInFaceoffCircle = (x, y) => {
                // Four offensive zone faceoff circle centers
                const circles = [
                    { x: 69, y: 22 },   // Right zone, top
                    { x: 69, y: -22 },  // Right zone, bottom
                    { x: -69, y: 22 },  // Left zone, top
                    { x: -69, y: -22 }  // Left zone, bottom
                ];
                const radius = 15; // 15-foot radius

                // Check if point is inside any faceoff circle
                return circles.some(c => {
                    const dist = Math.sqrt(Math.pow(x - c.x, 2) + Math.pow(y - c.y, 2));
                    return dist <= radius;
                });
            };

            let goalIndex = 0;
            shotEvents.forEach(shot => {
                const details = shot?.details || {};
                let x = details.xCoord;
                let y = details.yCoord;

                // Skip if no coordinates
                if (x == null || y == null) return;

                const period = shot?.periodDescriptor?.number || 1;

                // Filter by selected period
                const filterPeriod = parseInt(selectedShotPeriod);
                if (selectedShotPeriod === '4') {
                    // OT = period 4 or higher
                    if (period < 4) return;
                } else if (period !== filterPeriod) {
                    return;
                }

                // NHL coordinates: x is -100 to 100 (length), y is -42.5 to 42.5 (width)
                // Convert to percentage position on our rink
                // x: -100 to 100 -> 0% to 100%
                // y: 42.5 to -42.5 -> 0% to 100% (inverted for proper orientation)
                const xPct = ((x + 100) / 200) * 100;
                const yPct = ((42.5 - y) / 85) * 100;

                const eventTeamId = details.eventOwnerTeamId;
                const isUtahShot = eventTeamId === utahTeamId;
                const isGoal = shot?.typeDescKey === 'goal';

                // Track shots in faceoff circles
                const inCircle = isInFaceoffCircle(x, y);
                if (isUtahShot) {
                    utahTotal++;
                    if (inCircle) utahInCircle++;
                } else {
                    oppTotal++;
                    if (inCircle) oppInCircle++;
                }

                const dot = document.createElement('div');
                dot.className = `shot-dot ${isUtahShot ? 'utah' : 'opp'} ${isGoal ? 'goal' : ''} ${inCircle ? 'in-circle' : ''}`;
                dot.dataset.period = period;
                dot.style.left = `${xPct}%`;
                dot.style.top = `${yPct}%`;
                dot.textContent = period; // Show period number inside dot

                // Apply team color (goals stay gold)
                if (!isGoal) {
                    dot.style.background = isUtahShot ? utahColor : oppColor;
                }

                // Add tooltip on hover
                const time = shot?.timeInPeriod || '';
                const shotType = details.shotType || '';
                let tooltipText = `${isGoal ? 'GOAL' : 'Shot'} - P${period} ${time}${shotType ? ' (' + shotType + ')' : ''}${inCircle ? ' [Circle]' : ''}`;

                // For goals, get scorer and assists from roster
                if (isGoal) {
                    // Build roster map from playByPlay data
                    const rosterById = new Map();
                    if (gameData?.playByPlay?.rosterSpots && Array.isArray(gameData.playByPlay.rosterSpots)) {
                        gameData.playByPlay.rosterSpots.forEach(r => {
                            if (r?.playerId) {
                                const name = `${r.firstName?.default || ''} ${r.lastName?.default || ''}`.trim();
                                if (name) rosterById.set(r.playerId, name);
                            }
                        });
                    }

                    // Get scorer and assists from player IDs
                    const scorerId = details.scoringPlayerId;
                    const assist1Id = details.assist1PlayerId;
                    const assist2Id = details.assist2PlayerId;

                    const scorerName = scorerId ? rosterById.get(scorerId) : '';
                    const assists = [];
                    if (assist1Id && rosterById.has(assist1Id)) assists.push(rosterById.get(assist1Id));
                    if (assist2Id && rosterById.has(assist2Id)) assists.push(rosterById.get(assist2Id));

                    if (scorerName) {
                        // Find the actual index in goalsData array
                        const actualGoalIndex = goalsData.findIndex(g =>
                            g.period === period &&
                            g.time === time &&
                            g.scorerName === scorerName
                        );

                        // Store goal info on the dot element for hover popup
                        dot.dataset.scorer = scorerName;
                        dot.dataset.assists = assists.join(', ');
                        dot.dataset.time = `${time}`;
                        dot.dataset.goalIndex = actualGoalIndex >= 0 ? actualGoalIndex : goalIndex;
                        dot.title = ''; // Disable native tooltip
                        dot.style.cursor = 'pointer'; // Make goal dots clickable

                        // Add click listener to show goal video modal
                        dot.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showGoalVideoModal(parseInt(e.target.dataset.goalIndex));
                        });

                        // Add hover event listeners for custom popup
                        dot.addEventListener('mouseenter', (e) => showGoalPopup(e, scorerName, assists, period, time));
                        dot.addEventListener('mouseleave', hideGoalPopup);


                        goalIndex++;
                    }
                }

                rink.appendChild(dot);
            });

            // Update faceoff circle percentage display
            const utahCirclePct = utahTotal > 0 ? Math.round((utahInCircle / utahTotal) * 100) : 0;
            const oppCirclePct = oppTotal > 0 ? Math.round((oppInCircle / oppTotal) * 100) : 0;

            const utahSlotEl = document.getElementById('utahSlotPct');
            const oppSlotEl = document.getElementById('oppSlotPct');
            if (utahSlotEl) utahSlotEl.textContent = `${utahCirclePct}%`;
            if (oppSlotEl) oppSlotEl.textContent = `${oppCirclePct}%`;

            // Calculate goalie stats for selected period
            const calculateGoalieStats = () => {
                const stats = { utah: null, opp: null };
                const selectedPeriodNum = parseInt(selectedShotPeriod);
                const isPeriodOT = selectedShotPeriod === '4';

                // Filter shots for the selected period
                const periodShots = shotEvents.filter(s => {
                    const p = s?.periodDescriptor?.number || 1;
                    if (isPeriodOT) return p >= 4;
                    return p === selectedPeriodNum;
                });

                // Track shots for each team per period (shots ON GOAL by that team)
                const teamStats = {};
                periodShots.forEach(shot => {
                    const details = shot?.details || {};
                    const isGoal = shot?.typeDescKey === 'goal';
                    const eventTeamId = details.eventOwnerTeamId;
                    const period = shot?.periodDescriptor?.number || 1;
                    const key = `${eventTeamId}-P${isPeriodOT ? '4+' : period}`;

                    if (!teamStats[key]) {
                        teamStats[key] = { shotsFor: 0, goalsFor: 0 };
                    }

                    teamStats[key].shotsFor++;
                    if (isGoal) teamStats[key].goalsFor++;
                });

                // Get team data from boxscore
                const boxscoreData = gameData?.boxscore || gameData;
                const utahTeam = utahIsHome ? boxscoreData?.homeTeam : boxscoreData?.awayTeam;
                const oppTeam = utahIsHome ? boxscoreData?.awayTeam : boxscoreData?.homeTeam;

                // Get current goalie for Utah (tracks opponent shots against Utah goalie)
                const utahGoalies = utahTeam?.goalies || [];
                debugLog('Utah goalies array:', utahGoalies);
                if (utahGoalies.length > 0) {
                    const activeGoalie = utahGoalies[0]; // Use first/active goalie
                    debugLog('Utah goalie object:', activeGoalie);
                    const oppTeamForStats = utahIsHome ? awayTeamId : homeTeamId;
                    const key = `${oppTeamForStats}-P${isPeriodOT ? '4+' : selectedPeriodNum}`;
                    const periodStats = teamStats[key];

                    const playerId = activeGoalie.playerId || activeGoalie.id;
                    stats.utah = {
                        name: activeGoalie.name?.default || `${activeGoalie.firstName?.default || ''} ${activeGoalie.lastName?.default || ''}`.trim() || 'G',
                        playerId: playerId,
                        isUtah: true,
                        shotsAgainst: periodStats?.shotsFor || 0,
                        goalsAgainst: periodStats?.goalsFor || 0
                    };
                    debugLog('Utah goalie stats created:', stats.utah);
                }

                // Get current goalie for opponent (tracks Utah shots against opponent goalie)
                const oppGoalies = oppTeam?.goalies || [];
                debugLog('Opp goalies array:', oppGoalies);
                if (oppGoalies.length > 0) {
                    const activeGoalie = oppGoalies[0]; // Use first/active goalie
                    debugLog('Opp goalie object:', activeGoalie);
                    const utahTeamForStats = utahIsHome ? homeTeamId : awayTeamId;
                    const key = `${utahTeamForStats}-P${isPeriodOT ? '4+' : selectedPeriodNum}`;
                    const periodStats = teamStats[key];

                    const playerId = activeGoalie.playerId || activeGoalie.id;
                    stats.opp = {
                        name: activeGoalie.name?.default || `${activeGoalie.firstName?.default || ''} ${activeGoalie.lastName?.default || ''}`.trim() || 'G',
                        playerId: playerId,
                        isUtah: false,
                        shotsAgainst: periodStats?.shotsFor || 0,
                        goalsAgainst: periodStats?.goalsFor || 0
                    };
                    debugLog('Opp goalie stats created:', stats.opp);
                }

                return stats;
            };

            // Display goalie indicators on ice
            // Remove old goalie indicators
            rink.querySelectorAll('.goalie-indicator').forEach(el => el.remove());

            // Get goalie data from the already-rendered goalie elements on the page
            const utahGoalieNameEl = document.getElementById('utahGoalieName');
            const oppGoalieNameEl = document.getElementById('oppGoalieName');

            // Only show goalie indicators if we have goalie data
            if (!utahGoalieNameEl || !oppGoalieNameEl || utahGoalieNameEl.textContent === '-' || oppGoalieNameEl.textContent === '-') {
                return;
            }

            // Determine which side goalies are defending based on shot locations
            // Calculate average x-coordinate of opponent shots
            let oppShotSum = 0, oppShotCount = 0;
            let utahShotSum = 0, utahShotCount = 0;
            shotEvents.forEach(shot => {
                const details = shot?.details || {};
                const x = details.xCoord;
                if (x == null) return;

                const period = shot?.periodDescriptor?.number || 1;
                const selectedPeriodNum = parseInt(selectedShotPeriod);
                const isPeriodOT = selectedShotPeriod === '4';

                // Filter by selected period
                let include = false;
                if (isPeriodOT) {
                    include = period >= 4;
                } else {
                    include = period === selectedPeriodNum;
                }
                if (!include) return;

                const eventTeamId = details.eventOwnerTeamId;
                if (eventTeamId === utahTeamId) {
                    utahShotSum += x;
                    utahShotCount++;
                } else {
                    oppShotSum += x;
                    oppShotCount++;
                }
            });

            // Determine positioning: if opponent avg x > 0, they're attacking right goal
            const oppAvgX = oppShotCount > 0 ? oppShotSum / oppShotCount : 0;
            const utahAvgX = utahShotCount > 0 ? utahShotSum / utahShotCount : 0;
            debugLog(`Period ${selectedShotPeriod} - oppAvgX: ${oppAvgX.toFixed(2)}, utahAvgX: ${utahAvgX.toFixed(2)}, oppAttackingRight: ${oppAvgX >= 0}`);

            // Function to create goalie indicator
            const createGoalieIndicator = (stats, isUtah, onLeftSide) => {
                const el = document.createElement('div');
                el.className = `goalie-indicator ${isUtah ? 'utah' : 'opp'}`;
                el.style.left = onLeftSide ? '2%' : 'auto';
                el.style.right = onLeftSide ? 'auto' : '2%';
                el.style.top = '50%';
                el.style.transform = onLeftSide ? 'translate(-50%, -50%)' : 'translate(50%, -50%)';
                el.dataset.goalkeeper = isUtah ? 'utah' : 'opp';

                const img = document.createElement('img');
                const abbrev = isUtah ? UTAH_TEAM_ABBREV : (utahIsHome ? (game?.awayTeam?.abbrev || gameData?.awayTeam?.abbrev) : (game?.homeTeam?.abbrev || gameData?.homeTeam?.abbrev));
                const headshot = getPlayerHeadshot(stats.playerId, abbrev);
                img.src = headshot;
                img.onerror = function() { this.style.display = 'none'; };
                el.appendChild(img);

                const shotsAgainst = stats.shotsAgainst || 0;
                const goalsAgainst = stats.goalsAgainst || 0;
                const saves = shotsAgainst - goalsAgainst;
                const savePct = shotsAgainst > 0 ? ((saves / shotsAgainst) * 100).toFixed(1) : '0.0';

                el.addEventListener('mouseenter', (e) => {
                    const popup = document.createElement('div');
                    popup.className = 'goalie-stats-popup';
                    popup.id = 'goalieStatsPopup';
                    popup.innerHTML = `
                        <div class="goalie-stats-popup-name">${stats.name.split(' ').pop()}</div>
                        <div class="goalie-stats-popup-sv">${saves}/${shotsAgainst} | ${savePct}%</div>
                    `;
                    document.body.appendChild(popup);

                    const rect = el.getBoundingClientRect();
                    if (onLeftSide) {
                        popup.style.left = (rect.left - popup.offsetWidth / 2) + 'px';
                        popup.style.top = (rect.top - popup.offsetHeight - 8) + 'px';
                    } else {
                        popup.style.left = (rect.right + 8) + 'px';
                        popup.style.top = (rect.top - popup.offsetHeight / 2) + 'px';
                    }
                });

                el.addEventListener('mouseleave', () => {
                    const popup = document.getElementById('goalieStatsPopup');
                    if (popup) popup.remove();
                });

                return el;
            };

            // Opponent attacking right (avgX > 0) = Utah goalie on right, Opponent goalie on left
            // Opponent attacking left (avgX < 0) = Utah goalie on left, Opponent goalie on right
            const oppAttackingRight = oppAvgX >= 0;

            // Calculate period-specific goalie stats
            const calculatePeriodGoalieStats = () => {
                const selectedPeriodNum = parseInt(selectedShotPeriod);
                const isPeriodOT = selectedShotPeriod === '4';

                let utahStats = { sog: 0, goals: 0 };
                let oppStats = { sog: 0, goals: 0 };

                // Count shots and goals for the selected period
                shotEvents.forEach(shot => {
                    const details = shot?.details || {};
                    const period = shot?.periodDescriptor?.number || 1;

                    // Check if shot is in selected period
                    let include = false;
                    if (isPeriodOT) {
                        include = period >= 4;
                    } else {
                        include = period === selectedPeriodNum;
                    }
                    if (!include) return;

                    const eventTeamId = details.eventOwnerTeamId;
                    const isGoal = shot?.typeDescKey === 'goal';

                    // Shots AGAINST Utah goalie = shots taken BY opponent
                    // Shots AGAINST Opp goalie = shots taken BY Utah
                    if (eventTeamId === utahTeamId) {
                        // Utah took this shot - it's against opponent's goalie
                        oppStats.sog++;
                        if (isGoal) oppStats.goals++;
                    } else {
                        // Opponent took this shot - it's against Utah's goalie
                        utahStats.sog++;
                        if (isGoal) utahStats.goals++;
                    }
                });

                return { utah: utahStats, opp: oppStats };
            };

            const periodStats = calculatePeriodGoalieStats();

            // Function to create goalie with hover stats
            const createGoalieOnIce = (isUtah, onLeftSide) => {
                const container = document.createElement('div');
                container.className = `goalie-indicator ${isUtah ? 'utah' : 'opp'}`;
                container.style.position = 'absolute';
                container.style.zIndex = '100';
                container.style.cursor = 'pointer';
                if (onLeftSide) {
                    container.style.left = '1%';
                } else {
                    container.style.right = '1%';
                }
                container.style.top = '50%';
                container.style.transform = 'translateY(-50%)';
                container.style.width = '40px';
                container.style.height = '40px';

                const img = document.createElement('img');
                if (isUtah) {
                    img.src = `https://assets.nhle.com/mugs/nhl/20252026/${UTAH_TEAM_ABBREV}/${document.getElementById('utahGoalieImg')?.src?.split('/').pop() || '8477916.png'}`;
                } else {
                    const oppTeamAbbrev = utahIsHome ? (game?.awayTeam?.abbrev || gameData?.awayTeam?.abbrev) : (game?.homeTeam?.abbrev || gameData?.homeTeam?.abbrev);
                    img.src = `https://assets.nhle.com/mugs/nhl/20252026/${oppTeamAbbrev}/${document.getElementById('oppGoalieImg')?.src?.split('/').pop() || '0.png'}`;
                }
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.borderRadius = '50%';
                img.onerror = function() { this.src = ''; };
                container.appendChild(img);

                // Add hover listener for save percentage popup
                container.addEventListener('mouseenter', (e) => {
                    // Remove any existing popup first
                    const existingPopup = document.querySelector('.goalie-stats-popup');
                    if (existingPopup) existingPopup.remove();

                    const stats = isUtah ? periodStats.utah : periodStats.opp;
                    const goalieName = isUtah ? document.getElementById('utahGoalieName')?.textContent : document.getElementById('oppGoalieName')?.textContent;

                    const saves = stats.sog - stats.goals;
                    const savePct = stats.sog > 0 ? ((saves / stats.sog) * 100).toFixed(1) : '0.0';

                    const popup = document.createElement('div');
                    popup.className = 'goalie-stats-popup';
                    popup.setAttribute('data-popup-type', 'goalie-rink');
                    popup.innerHTML = `
                        <div class="goalie-stats-popup-name">${goalieName?.split(' ').pop() || 'Goalie'}</div>
                        <div class="goalie-stats-popup-sv">P${selectedShotPeriod}: ${saves}/${stats.sog} | ${savePct}%</div>
                    `;
                    document.body.appendChild(popup);

                    const rect = container.getBoundingClientRect();
                    popup.style.left = (rect.left - popup.offsetWidth / 2) + 'px';
                    popup.style.top = (rect.top - popup.offsetHeight - 8) + 'px';
                });

                container.addEventListener('mouseleave', () => {
                    // Remove popup after a small delay to ensure it's the right one
                    setTimeout(() => {
                        const popup = document.querySelector('[data-popup-type="goalie-rink"]');
                        if (popup) popup.remove();
                    }, 100);
                });

                return container;
            };

            // Add Utah goalie to ice
            const utahGoalieEl = createGoalieOnIce(true, !oppAttackingRight);
            rink.appendChild(utahGoalieEl);

            // Add opponent goalie to ice
            const oppGoalieEl = createGoalieOnIce(false, oppAttackingRight);
            rink.appendChild(oppGoalieEl);
        }

        // Fastest Shots - uses NHL Edge API for season shot speed data
        let edgeShotSpeedCache = { utah: null, opp: null, oppTeamId: null };

        async function fetchEdgeShotSpeed(teamId) {
            try {
                const response = await fetch(`/api/v1/edge/team-shot-speed-detail/${teamId}/20252026/2`);
                if (!response.ok) return null;
                return await response.json();
            } catch (e) {
                debugLog('Error fetching edge shot speed:', e);
                return null;
            }
        }

        async function updateFastestShots() {
            const container = document.getElementById('fastestShotsList');
            if (!container) return;

            // Get team IDs from game data
            const boxscore = gameData?.boxscore || gameData;
            const homeTeam = boxscore?.homeTeam;
            const awayTeam = boxscore?.awayTeam;

            if (!homeTeam || !awayTeam) {
                container.innerHTML = '<div class="no-shot-data">Loading shot speed data...</div>';
                return;
            }

            const utahIsHome = homeTeam?.abbrev === UTAH_TEAM_ABBREV;
            const utahTeamId = utahIsHome ? homeTeam.id : awayTeam.id;
            const oppTeamId = utahIsHome ? awayTeam.id : homeTeam.id;
            const oppAbbrev = utahIsHome ? awayTeam.abbrev : homeTeam.abbrev;

            // Fetch shot speed data (cache for performance)
            if (!edgeShotSpeedCache.utah) {
                edgeShotSpeedCache.utah = await fetchEdgeShotSpeed(utahTeamId);
            }
            if (!edgeShotSpeedCache.opp || edgeShotSpeedCache.oppTeamId !== oppTeamId) {
                edgeShotSpeedCache.opp = await fetchEdgeShotSpeed(oppTeamId);
                edgeShotSpeedCache.oppTeamId = oppTeamId;
            }

            const utahData = edgeShotSpeedCache.utah;
            const oppData = edgeShotSpeedCache.opp;

            debugLog('Edge shot speed - Utah:', utahData);
            debugLog('Edge shot speed - Opp:', oppData);

            // Combine and sort shots from both teams
            // API returns hardestShots array with shotSpeed.imperial
            const allShots = [];

            if (utahData?.hardestShots) {
                utahData.hardestShots.forEach(shot => {
                    allShots.push({
                        speed: shot.shotSpeed?.imperial || 0,
                        playerName: `${shot.firstName?.default || ''} ${shot.lastName?.default || ''}`.trim(),
                        sweater: shot.sweaterNumber || '',
                        isUtah: true,
                        teamAbbrev: UTAH_TEAM_ABBREV
                    });
                });
            }

            if (oppData?.hardestShots) {
                oppData.hardestShots.forEach(shot => {
                    allShots.push({
                        speed: shot.shotSpeed?.imperial || 0,
                        playerName: `${shot.firstName?.default || ''} ${shot.lastName?.default || ''}`.trim(),
                        sweater: shot.sweaterNumber || '',
                        isUtah: false,
                        teamAbbrev: oppAbbrev
                    });
                });
            }

            // Sort by speed and take top 5
            const topShots = allShots
                .filter(s => s.speed > 0)
                .sort((a, b) => b.speed - a.speed)
                .slice(0, 5);

            if (topShots.length === 0) {
                container.innerHTML = '<div class="no-shot-data">Shot speed data unavailable</div>';
                return;
            }

            container.innerHTML = topShots.map((shot, idx) => `
                <div class="fastest-shot-item ${shot.isUtah ? 'utah' : 'opp'}">
                    <span class="fastest-shot-rank">${idx + 1}.</span>
                    <span class="fastest-shot-speed">${shot.speed.toFixed(1)} <span class="unit">MPH</span></span>
                    <span class="fastest-shot-player">
                        #${shot.sweater} ${shot.playerName}
                        <span class="team">${shot.teamAbbrev}</span>
                    </span>
                </div>
            `).join('');
        }

        // Top Skater Speeds - uses NHL Edge API for season skating speed data
        let edgeSkatingSpeedCache = { utah: null, opp: null, oppTeamId: null };

        async function fetchEdgeSkatingSpeed(teamId) {
            try {
                const response = await fetch(`/api/v1/edge/team-skating-speed-detail/${teamId}/20252026/2`);
                if (!response.ok) return null;
                return await response.json();
            } catch (e) {
                debugLog('Error fetching edge skating speed:', e);
                return null;
            }
        }

        async function updateSkatingSpeed() {
            const container = document.getElementById('skatingSpeedList');
            if (!container) return;

            const boxscore = gameData?.boxscore || gameData;
            const homeTeam = boxscore?.homeTeam;
            const awayTeam = boxscore?.awayTeam;

            if (!homeTeam || !awayTeam) {
                container.innerHTML = '<div class="no-shot-data">Loading skating speed data...</div>';
                return;
            }

            const utahIsHome = homeTeam?.abbrev === UTAH_TEAM_ABBREV;
            const utahTeamId = utahIsHome ? homeTeam.id : awayTeam.id;
            const oppTeamId = utahIsHome ? awayTeam.id : homeTeam.id;
            const oppAbbrev = utahIsHome ? awayTeam.abbrev : homeTeam.abbrev;

            // Fetch skating speed data (cache for performance)
            if (!edgeSkatingSpeedCache.utah) {
                edgeSkatingSpeedCache.utah = await fetchEdgeSkatingSpeed(utahTeamId);
            }
            if (!edgeSkatingSpeedCache.opp || edgeSkatingSpeedCache.oppTeamId !== oppTeamId) {
                edgeSkatingSpeedCache.opp = await fetchEdgeSkatingSpeed(oppTeamId);
                edgeSkatingSpeedCache.oppTeamId = oppTeamId;
            }

            const utahData = edgeSkatingSpeedCache.utah;
            const oppData = edgeSkatingSpeedCache.opp;

            debugLog('Edge skating speed - Utah:', utahData);
            debugLog('Edge skating speed - Opp:', oppData);

            // Combine and sort by max speed
            // API returns topSkatingSpeeds array with player.firstName.default and skatingSpeed.imperial
            const allSkaters = [];

            if (utahData?.topSkatingSpeeds) {
                utahData.topSkatingSpeeds.forEach(entry => {
                    allSkaters.push({
                        speed: entry.skatingSpeed?.imperial || 0,
                        playerName: `${entry.player?.firstName?.default || ''} ${entry.player?.lastName?.default || ''}`.trim(),
                        sweater: entry.player?.sweaterNumber || '',
                        isUtah: true,
                        teamAbbrev: UTAH_TEAM_ABBREV
                    });
                });
            }

            if (oppData?.topSkatingSpeeds) {
                oppData.topSkatingSpeeds.forEach(entry => {
                    allSkaters.push({
                        speed: entry.skatingSpeed?.imperial || 0,
                        playerName: `${entry.player?.firstName?.default || ''} ${entry.player?.lastName?.default || ''}`.trim(),
                        sweater: entry.player?.sweaterNumber || '',
                        isUtah: false,
                        teamAbbrev: oppAbbrev
                    });
                });
            }

            const topSkaters = allSkaters
                .filter(s => s.speed > 0)
                .sort((a, b) => b.speed - a.speed)
                .slice(0, 5);

            if (topSkaters.length === 0) {
                container.innerHTML = '<div class="no-shot-data">Skating speed data unavailable</div>';
                return;
            }

            container.innerHTML = topSkaters.map((skater, idx) => `
                <div class="skating-speed-item ${skater.isUtah ? 'utah' : 'opp'}">
                    <span class="skating-speed-rank">${idx + 1}.</span>
                    <span class="skating-speed-value">${skater.speed.toFixed(2)} <span class="unit">MPH</span></span>
                    <span class="skating-speed-player">
                        #${skater.sweater} ${skater.playerName}
                        <span class="team">${skater.teamAbbrev}</span>
                    </span>
                </div>
            `).join('');
        }

        // Time on Ice - Top 5 from each team (game-specific)
        function updateTimeOnIce() {
            const container = document.getElementById('toiList');
            if (!container) return;

            const boxscore = gameData?.boxscore || gameData;
            const playerStats = gameData?.playerByGameStats || boxscore?.playerByGameStats;

            if (!playerStats) {
                container.innerHTML = '<div class="no-shot-data">TOI data will appear when game starts</div>';
                return;
            }

            const homeTeam = boxscore?.homeTeam;
            const awayTeam = boxscore?.awayTeam;
            const utahIsHome = homeTeam?.abbrev === UTAH_TEAM_ABBREV;

            // Helper to get headshot URL
            const getHeadshot = (playerId, teamAbbrev) => {
                return `https://assets.nhle.com/mugs/nhl/20252026/${teamAbbrev}/${playerId}.png`;
            };

            // Helper to parse TOI string to seconds for sorting
            const toiToSeconds = (toi) => {
                if (!toi) return 0;
                const parts = toi.split(':');
                return parseInt(parts[0]) * 60 + parseInt(parts[1] || 0);
            };

            // Get players from each team
            const getTopPlayers = (teamKey, teamAbbrev) => {
                const forwards = playerStats[teamKey]?.forwards || [];
                const defense = playerStats[teamKey]?.defense || [];
                const allPlayers = [...forwards, ...defense];

                return allPlayers
                    .map(p => ({
                        name: p.name?.default || 'Unknown',
                        toi: p.toi || '0:00',
                        toiSeconds: toiToSeconds(p.toi),
                        position: p.position || '',
                        sweater: p.sweaterNumber || '',
                        playerId: p.playerId,
                        headshot: getHeadshot(p.playerId, teamAbbrev),
                        teamAbbrev: teamAbbrev
                    }))
                    .sort((a, b) => b.toiSeconds - a.toiSeconds)
                    .slice(0, 5);
            };

            const utahPlayers = getTopPlayers(utahIsHome ? 'homeTeam' : 'awayTeam', UTAH_TEAM_ABBREV);
            const oppAbbrev = utahIsHome ? awayTeam?.abbrev : homeTeam?.abbrev;
            const oppPlayers = getTopPlayers(utahIsHome ? 'awayTeam' : 'homeTeam', oppAbbrev);

            if (utahPlayers.length === 0 && oppPlayers.length === 0) {
                container.innerHTML = '<div class="no-shot-data">TOI data will appear when game starts</div>';
                return;
            }

            const renderPlayer = (player) => `
                <div class="toi-item">
                    <img src="${player.headshot}" alt="${player.name}" onerror="this.style.display='none'">
                    <div class="player-info">
                        <div class="player-name">#${player.sweater} ${player.name}</div>
                        <div class="player-pos">${player.position}</div>
                    </div>
                    <div class="toi-value">${player.toi}</div>
                </div>
            `;

            container.innerHTML = `
                <div class="toi-team-section">
                    <div class="toi-team-header">UTAH</div>
                    ${utahPlayers.map(renderPlayer).join('')}
                </div>
                <div class="toi-team-section">
                    <div class="toi-team-header opp">${oppAbbrev}</div>
                    ${oppPlayers.map(renderPlayer).join('')}
                </div>
            `;
        }

        function updatePlayers() {
            debugLog('=== UPDATE PLAYERS ===');
            debugLog('Full gameData:', gameData);
            
            // Try game-story format first
            if (gameData?.players?.skaters) {
                debugLog('Found game-story skaters:', gameData.players.skaters.length);
                const utahPlayers = gameData.players.skaters.filter(p => p.team === UTAH_TEAM_ABBREV);
                debugLog('Utah players from game-story:', utahPlayers.length);
                
                if (utahPlayers.length > 0) {
                    renderPlayersFromGameStory(utahPlayers);
                    return;
                }
            }
            
            // Fallback to boxscore format
            debugLog('Checking for playerByGameStats...');
            const playerStats = gameData?.playerByGameStats || gameData?.boxscore?.playerByGameStats;
            debugLog('playerStats:', playerStats);
            
            if (playerStats) {
                renderPlayersFromBoxscore(playerStats);
                return;
            }
            
            debugLog('No player data found in any format');
            document.getElementById('playersList').innerHTML = '<div class="loading">Player stats will appear when game data is available</div>';
        }

        function renderPlayersFromGameStory(utahPlayers) {
            // Keep legacy rendering for game-story-only data (typically live).
            debugLog('Rendering from game-story format');
            utahPlayers.sort((a, b) => (b.stats?.points || 0) - (a.stats?.points || 0));

            const playersHTML = utahPlayers.slice(0, 15).map(player => `
                <div class="player-card">
                    <img class="player-headshot" src="${getPlayerHeadshot(player.playerId, UTAH_TEAM_ABBREV)}" 
                         alt="${player.name || 'Player'}" onerror="this.style.display='none'">
                    <div class="player-info">
                        <div class="player-name">#${player.jersey || '?'} ${player.name || 'Unknown'}</div>
                        <div class="player-position">${player.position || 'N/A'}</div>
                        <div class="player-stats-row">
                            <div class="stat-item">
                                <div class="stat-label">G</div>
                                <div class="stat-number">${player.stats?.goals || 0}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">A</div>
                                <div class="stat-number">${player.stats?.assists || 0}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">PTS</div>
                                <div class="stat-number">${player.stats?.points || 0}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">SOG</div>
                                <div class="stat-number">${player.stats?.shots || 0}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">TOI</div>
                                <div class="stat-number">${player.stats?.toi || '0:00'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('playersList').innerHTML = playersHTML;
        }

        function renderPlayersFromBoxscore(playerStats) {
            debugLog('Rendering from boxscore format');

            const game = gameData?.game || gameData;
            const teams = gameData?.teams || { home: gameData?.homeTeam, away: gameData?.awayTeam };
            const utahIsHome = teams?.home?.abbrev === UTAH_TEAM_ABBREV;

            const homeAbbrev = teams?.home?.abbrev || 'HOME';
            const awayAbbrev = teams?.away?.abbrev || 'AWAY';

            const homeName = teams?.home?.name?.default || teams?.home?.commonName?.default || teams?.home?.placeName?.default || homeAbbrev;
            const awayName = teams?.away?.name?.default || teams?.away?.commonName?.default || teams?.away?.placeName?.default || awayAbbrev;

            function formatSkaterName(player) {
                return player?.name?.default || `${player?.firstName?.default || ''} ${player?.lastName?.default || ''}`.trim() || 'Unknown';
            }

            function headshotUrl(playerId, teamAbbrev) {
                return getPlayerHeadshot(playerId, teamAbbrev);
            }

            function sortByPointsThenSogThenToi(players) {
                return [...players].sort((a, b) => {
                    const aPts = (a.goals || 0) + (a.assists || 0);
                    const bPts = (b.goals || 0) + (b.assists || 0);
                    if (bPts !== aPts) return bPts - aPts;
                    if ((b.sog || 0) !== (a.sog || 0)) return (b.sog || 0) - (a.sog || 0);
                    return String(b.toi || '').localeCompare(String(a.toi || ''));
                });
            }

            function renderTeamPanel(teamSide, teamAbbrev, teamName, isUtah) {
                const t = playerStats?.[teamSide];
                if (!t) return '';

                const skaters = sortByPointsThenSogThenToi([...(t.forwards || []), ...(t.defense || [])]);
                const goalies = [...(t.goalies || [])].sort((a, b) => (b.saves || 0) - (a.saves || 0));

                const skaterRows = skaters.map(p => {
                    const name = formatSkaterName(p);
                    const pts = (p.goals || 0) + (p.assists || 0);
                    return `
                        <tr>
                            <td class="num">${p.sweaterNumber ?? '-'}</td>
                            <td>
                                <div class="player-name-cell">
                                    <img class="player-headshot" src="${headshotUrl(p.playerId, teamAbbrev)}" alt="${name}" onerror="this.style.display='none'">
                                    <span class="player-name-text">${name}</span>
                                </div>
                            </td>
                            <td class="stat">${p.position || p.positionCode || '-'}</td>
                            <td class="stat">${p.goals || 0}</td>
                            <td class="stat">${p.assists || 0}</td>
                            <td class="stat">${pts}</td>
                            <td class="stat">${p.sog || 0}</td>
                            <td class="stat">${p.plusMinus ?? 0}</td>
                            <td class="toi">${p.toi || '0:00'}</td>
                        </tr>
                    `;
                }).join('');

                const goalieRows = goalies.map(g => {
                    const name = formatSkaterName(g);
                    const shots = g.shotsAgainst ?? 0;
                    const saves = g.saves ?? 0;
                    const ga = g.goalsAgainst ?? (shots - saves);
                    return `
                        <tr>
                            <td class="num">${g.sweaterNumber ?? '-'}</td>
                            <td>
                                <div class="player-name-cell">
                                    <img class="player-headshot" src="${headshotUrl(g.playerId, teamAbbrev)}" alt="${name}" onerror="this.style.display='none'">
                                    <span class="player-name-text">${name}</span>
                                </div>
                            </td>
                            <td class="stat">${g.starter ? 'ST' : 'G'}</td>
                            <td class="stat">${shots}</td>
                            <td class="stat">${saves}</td>
                            <td class="stat">${ga}</td>
                            <td class="toi" colspan="3">${g.toi || '0:00'}</td>
                        </tr>
                    `;
                }).join('');

                const gameLabel = game?.gameState === 'OFF' ? 'Final' : (game?.gameState || 'Game');

                return `
                    <div class="team-panel ${isUtah ? 'utah' : ''}">
                        <div class="team-panel-header">
                            <div class="team-panel-title">
                                <img class="team-panel-logo" src="${getTeamLogoUrl(teamAbbrev)}" alt="${teamAbbrev}">
                                <div>
                                    <div class="team-panel-name">${teamName}</div>
                                    <div class="team-panel-subtitle">${teamAbbrev}  ${gameLabel}</div>
                                </div>
                            </div>
                        </div>

                        <div class="player-section-title">Skaters</div>
                        <table class="player-table">
                            <thead>
                                <tr>
                                    <th class="num">#</th>
                                    <th>Player</th>
                                    <th class="stat">Pos</th>
                                    <th class="stat">G</th>
                                    <th class="stat">A</th>
                                    <th class="stat">PTS</th>
                                    <th class="stat">SOG</th>
                                    <th class="stat">+/-</th>
                                    <th class="toi">TOI</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${skaterRows || `<tr><td colspan="9" style="color:#888; padding: 14px 8px;">No skater stats</td></tr>`}
                            </tbody>
                        </table>

                        <div class="player-section-title">Goalies</div>
                        <table class="player-table">
                            <thead>
                                <tr>
                                    <th class="num">#</th>
                                    <th>Goalie</th>
                                    <th class="stat">Role</th>
                                    <th class="stat">SA</th>
                                    <th class="stat">SV</th>
                                    <th class="stat">GA</th>
                                    <th class="toi" colspan="3">TOI</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${goalieRows || `<tr><td colspan="7" style="color:#888; padding: 14px 8px;">No goalie stats</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            const html = `
                <div class="player-stats-columns">
                    ${renderTeamPanel('awayTeam', awayAbbrev, awayName, awayAbbrev === UTAH_TEAM_ABBREV)}
                    ${renderTeamPanel('homeTeam', homeAbbrev, homeName, homeAbbrev === UTAH_TEAM_ABBREV)}
                </div>
            `;

            document.getElementById('playersList').innerHTML = html;
        }

        function updatePlayByPlay() {
            const playEl = document.getElementById('playFeed');

            const pbp = gameData?.playByPlay;
            if (!pbp?.plays || pbp.plays.length === 0) {
                playEl.innerHTML = '<div class="loading">Play-by-play will appear when game events occur</div>';
                return;
            }

            const rosterById = new Map();
            if (Array.isArray(pbp.rosterSpots)) {
                for (const r of pbp.rosterSpots) {
                    if (r?.playerId) rosterById.set(r.playerId, r);
                }
            }

            function fmtPlayer(id) {
                const r = rosterById.get(id);
                if (!r) return null;
                const name = `${r.firstName?.default || ''} ${r.lastName?.default || ''}`.trim();
                return {
                    name: name || 'Player',
                    headshot: r.headshot,
                    sweater: r.sweaterNumber,
                    position: r.positionCode
                };
            }

            function playTime(p) {
                const per = p?.periodDescriptor?.number ? `P${p.periodDescriptor.number}` : '';
                const t = p?.timeInPeriod || '';
                return [per, t].filter(Boolean).join('  ');
            }

            function titleCase(s) {
                return String(s || '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            }

            function renderPlay(p) {
                const type = p?.typeDescKey || 'event';
                const isGoal = type === 'goal';
                const isPenalty = type === 'penalty';

                const details = p?.details || {};
                const team = details?.eventOwnerTeamAbbrev || details?.teamAbbrev || '';

                let desc = '';
                let peopleHtml = '';

                if (isGoal) {
                    const scorer = fmtPlayer(details?.scoringPlayerId);
                    const a1 = fmtPlayer(details?.assist1PlayerId);
                    const a2 = fmtPlayer(details?.assist2PlayerId);

                    const strength = details?.strength ? String(details.strength).toUpperCase() : '';
                    const shotType = details?.shotType ? titleCase(details.shotType) : '';

                    desc = `${team} GOAL${strength ? '  ' + strength : ''}${shotType ? '  ' + shotType : ''}`;

                    const assistNames = [a1?.name, a2?.name].filter(Boolean);
                    const assistText = assistNames.length ? `Assists: ${assistNames.join(', ')}` : 'Unassisted';

                    peopleHtml = `
                        <div class="player-name-cell" style="margin-top:10px;">
                            ${scorer?.headshot ? `<img class="player-headshot" src="${scorer.headshot}" alt="" onerror="this.style.display='none'">` : ''}
                            <div>
                                <div style="font-weight:800;">${scorer?.name || 'Goal'}</div>
                                <div style="color:#aaa; font-size:12px; letter-spacing:1px; margin-top:2px;">${assistText}</div>
                            </div>
                        </div>
                    `;
                } else if (isPenalty) {
                    const guilty = fmtPlayer(details?.committedByPlayerId);
                    const drawn = fmtPlayer(details?.drawnByPlayerId);

                    const pen = details?.descKey ? titleCase(details.descKey) : 'Penalty';
                    const mins = details?.duration ? `${details.duration} min` : '';
                    desc = `${team}  ${pen}${mins ? '  ' + mins : ''}`;

                    const drawnText = drawn?.name ? `Drawn by ${drawn.name}` : '';

                    peopleHtml = `
                        <div class="player-name-cell" style="margin-top:10px;">
                            ${guilty?.headshot ? `<img class="player-headshot" src="${guilty.headshot}" alt="" onerror="this.style.display='none'">` : ''}
                            <div>
                                <div style="font-weight:800;">${guilty?.name || 'Penalty'}</div>
                                ${drawnText ? `<div style="color:#aaa; font-size:12px; letter-spacing:1px; margin-top:2px;">${drawnText}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    desc = `${team ? team + '  ' : ''}${titleCase(type)}`;
                }

                const highlight = isGoal ? 'goal' : '';

                return `
                    <div class="play-item ${highlight}">
                        <div class="play-time">${playTime(p) || ''}</div>
                        <div class="play-description">
                            ${isGoal ? ' <strong>GOAL!</strong> ' : ''}
                            ${desc}
                            ${peopleHtml}
                        </div>
                    </div>
                `;
            }

            const allPlays = pbp.plays.slice().sort((a, b) => (b.sortOrder || 0) - (a.sortOrder || 0));

            // Get team info
            const game = gameData?.game || gameData;
            const homeTeam = pbp?.homeTeam || game?.homeTeam || gameData?.homeTeam;
            const awayTeam = pbp?.awayTeam || game?.awayTeam || gameData?.awayTeam;
            const utahIsHome = homeTeam?.abbrev === UTAH_TEAM_ABBREV;
            const utahTeam = utahIsHome ? homeTeam : awayTeam;
            const oppTeam = utahIsHome ? awayTeam : homeTeam;
            const utahAbbrev = utahTeam?.abbrev || UTAH_TEAM_ABBREV;
            const oppAbbrev = oppTeam?.abbrev || 'OPP';
            const utahName = utahTeam?.commonName?.default || utahTeam?.placeName?.default || 'Utah';
            const oppName = oppTeam?.commonName?.default || oppTeam?.placeName?.default || 'Opponent';

            // Helper to get team abbrev from team ID
            const getTeamAbbrevFromId = (teamId) => {
                if (teamId === homeTeam?.id) return homeTeam?.abbrev;
                if (teamId === awayTeam?.id) return awayTeam?.abbrev;
                return '';
            };

            // Separate by team and type (use teamId for both goals and penalties)
            const utahGoals = allPlays.filter(p => {
                if (p?.typeDescKey !== 'goal') return false;
                const teamId = p?.details?.eventOwnerTeamId;
                const team = getTeamAbbrevFromId(teamId) || p?.details?.eventOwnerTeamAbbrev || '';
                return team === utahAbbrev;
            });
            const oppGoals = allPlays.filter(p => {
                if (p?.typeDescKey !== 'goal') return false;
                const teamId = p?.details?.eventOwnerTeamId;
                const team = getTeamAbbrevFromId(teamId) || p?.details?.eventOwnerTeamAbbrev || '';
                return team === oppAbbrev;
            });
            const utahPenalties = allPlays.filter(p => {
                if (p?.typeDescKey !== 'penalty') return false;
                const teamId = p?.details?.eventOwnerTeamId;
                const team = getTeamAbbrevFromId(teamId);
                return team === utahAbbrev;
            });
            const oppPenalties = allPlays.filter(p => {
                if (p?.typeDescKey !== 'penalty') return false;
                const teamId = p?.details?.eventOwnerTeamId;
                const team = getTeamAbbrevFromId(teamId);
                return team === oppAbbrev;
            });
            const otherPlays = allPlays.filter(p => p?.typeDescKey !== 'goal' && p?.typeDescKey !== 'penalty').slice(0, 30);

            // Render compact highlight item with headshot and team logo
            function renderHighlightItem(p, type, teamAbbrev) {
                const details = p?.details || {};
                const per = p?.periodDescriptor?.number ? `P${p.periodDescriptor.number}` : '';
                const time = p?.timeInPeriod || '';
                const teamLogo = getTeamLogoUrl(teamAbbrev);

                if (type === 'goal') {
                    const scorer = fmtPlayer(details?.scoringPlayerId);
                    const strength = details?.strength === 'pp' ? 'PP' : (details?.strength === 'sh' ? 'SH' : '');
                    return `
                        <div class="highlight-item goal">
                            <div class="highlight-player-row">
                                ${scorer?.headshot ? `<img class="highlight-headshot" src="${scorer.headshot}" alt="" onerror="this.style.display='none'">` : ''}
                                <img class="highlight-team-logo" src="${teamLogo}" alt="" onerror="this.style.display='none'">
                                <span class="highlight-player">${scorer?.name || 'Goal'}</span>
                            </div>
                            <div class="highlight-details">
                                <span class="highlight-time">${per} ${time}</span>
                                ${strength ? `<span class="highlight-type">${strength}</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    const guilty = fmtPlayer(details?.committedByPlayerId);
                    const pen = details?.descKey ? titleCase(details.descKey) : 'Penalty';
                    const mins = details?.duration || 2;
                    return `
                        <div class="highlight-item penalty">
                            <div class="highlight-player-row">
                                ${guilty?.headshot ? `<img class="highlight-headshot" src="${guilty.headshot}" alt="" onerror="this.style.display='none'">` : ''}
                                <img class="highlight-team-logo" src="${teamLogo}" alt="" onerror="this.style.display='none'">
                                <span class="highlight-player">${guilty?.name || 'Penalty'}</span>
                            </div>
                            <div class="highlight-details">
                                <span class="highlight-info">${pen} (${mins}min)</span>
                                <span class="highlight-time">${per} ${time}</span>
                            </div>
                        </div>
                    `;
                }
            }

            // Build the HTML with 4-column highlights box at top
            let html = '';

            const hasHighlights = utahGoals.length || oppGoals.length || utahPenalties.length || oppPenalties.length;

            if (hasHighlights) {
                const utahColor = TEAM_COLORS[UTAH_TEAM_ABBREV] || selectedTeam?.color || '#69B3E7';
                const oppColor = TEAM_COLORS[oppAbbrev] || '#888';
                html += `
                    <div class="pbp-highlights-box">
                        <div class="highlights-column utah-goals" style="--column-team-color: ${utahColor}">
                            <div class="highlights-column-header">${utahName} Goals</div>
                            <div class="highlights-column-content">
                                ${utahGoals.length ? utahGoals.map(p => renderHighlightItem(p, 'goal', utahAbbrev)).join('') : '<div class="no-highlights">-</div>'}
                            </div>
                        </div>
                        <div class="highlights-column utah-penalties" style="--column-team-color: ${utahColor}">
                            <div class="highlights-column-header">${utahName} Penalties</div>
                            <div class="highlights-column-content">
                                ${utahPenalties.length ? utahPenalties.map(p => renderHighlightItem(p, 'penalty', utahAbbrev)).join('') : '<div class="no-highlights">-</div>'}
                            </div>
                        </div>
                        <div class="highlights-column opp-goals" style="--column-team-color: ${oppColor}">
                            <div class="highlights-column-header">${oppName} Goals</div>
                            <div class="highlights-column-content">
                                ${oppGoals.length ? oppGoals.map(p => renderHighlightItem(p, 'goal', oppAbbrev)).join('') : '<div class="no-highlights">-</div>'}
                            </div>
                        </div>
                        <div class="highlights-column opp-penalties" style="--column-team-color: ${oppColor}">
                            <div class="highlights-column-header">${oppName} Penalties</div>
                            <div class="highlights-column-content">
                                ${oppPenalties.length ? oppPenalties.map(p => renderHighlightItem(p, 'penalty', oppAbbrev)).join('') : '<div class="no-highlights">-</div>'}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Other plays
            if (otherPlays.length > 0) {
                html += `
                    <div class="pbp-other-plays">
                        <div class="pbp-section-title">All Plays</div>
                        ${otherPlays.map(renderPlay).join('')}
                    </div>
                `;
            }

            playEl.innerHTML = html || '<div class="loading">No plays yet</div>';
        }

        function updateRecentPlays() {
            const recentPlaysEl = document.getElementById('recentPlays');
            if (!recentPlaysEl) return;

            const pbp = gameData?.playByPlay;
            if (!pbp?.plays || pbp.plays.length === 0) {
                recentPlaysEl.innerHTML = '<div class="recent-play-item"><span class="recent-play-desc">Waiting for game...</span></div>';
                return;
            }

            const rosterById = new Map();
            if (Array.isArray(pbp.rosterSpots)) {
                for (const r of pbp.rosterSpots) {
                    if (r?.playerId) rosterById.set(r.playerId, r);
                }
            }

            function getPlayerName(id) {
                const r = rosterById.get(id);
                if (!r) return null;
                return `${r.firstName?.default || ''} ${r.lastName?.default || ''}`.trim() || 'Player';
            }

            function playTime(p) {
                const per = p?.periodDescriptor?.number ? `P${p.periodDescriptor.number}` : '';
                const t = p?.timeInPeriod || '';
                return [per, t].filter(Boolean).join(' ');
            }

            function titleCase(s) {
                return String(s || '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            }

            // Get 2 most recent plays
            const recentPlays = pbp.plays
                .slice()
                .sort((a, b) => (b.sortOrder || 0) - (a.sortOrder || 0))
                .slice(0, 2);

            const html = recentPlays.map(p => {
                const type = p?.typeDescKey || 'event';
                const isGoal = type === 'goal';
                const details = p?.details || {};
                const team = details?.eventOwnerTeamAbbrev || details?.teamAbbrev || '';

                let desc = '';
                if (isGoal) {
                    const scorerName = getPlayerName(details?.scoringPlayerId) || 'Goal';
                    desc = `${team} Goal - ${scorerName}`;
                } else if (type === 'penalty') {
                    const penaltyName = getPlayerName(details?.committedByPlayerId) || 'Penalty';
                    desc = `${team} Penalty - ${penaltyName}`;
                } else if (type === 'shot-on-goal') {
                    const shooterName = getPlayerName(details?.shootingPlayerId) || '';
                    desc = `${team} Shot${shooterName ? ' - ' + shooterName : ''}`;
                } else {
                    desc = `${team ? team + ' ' : ''}${titleCase(type)}`;
                }

                const highlightClass = isGoal ? ' goal' : '';

                return `
                    <div class="recent-play-item${highlightClass}">
                        <span class="recent-play-time">${playTime(p)}</span>
                        <span class="recent-play-desc">${isGoal ? ' ' : ''}${desc}</span>
                    </div>
                `;
            }).join('');

            recentPlaysEl.innerHTML = html || '<div class="recent-play-item"><span class="recent-play-desc">Waiting for game...</span></div>';
        }

        function updateSchedule() {
            if (!scheduleData?.games) return;
            
            const today = getTodayLocalMidnight();
            
            // Find previous, current, and next games
            const pastGames = scheduleData.games
                .filter(g => {
                    const gameDay = getGameDayDate(g);
                    return gameDay && gameDay < today && g.gameState === 'OFF';
                })
                .sort((a, b) => {
                    const aDay = getGameDayDate(a);
                    const bDay = getGameDayDate(b);
                    return (aDay?.getTime() || 0) - (bDay?.getTime() || 0);
                })
                .slice(-1);

            const todaysGames = scheduleData.games.filter(g => {
                const gameDay = getGameDayDate(g);
                return gameDay && gameDay.getTime() === today.getTime();
            });

            const futureGames = scheduleData.games
                .filter(g => {
                    const gameDay = getGameDayDate(g);
                    return gameDay && gameDay > today;
                })
                .sort((a, b) => {
                    const aDay = getGameDayDate(a);
                    const bDay = getGameDayDate(b);
                    return (aDay?.getTime() || 0) - (bDay?.getTime() || 0);
                })
                .slice(0, 5);
            
            let scheduleHTML = '';
            
            // Previous Game
            if (pastGames.length > 0) {
                scheduleHTML += `
                    <div class="schedule-section">
                        <div class="section-header">Previous Game</div>
                        ${renderGameCard(pastGames[0])}
                    </div>
                `;
            }
            
            // Current Game
            if (todaysGames.length > 0) {
                scheduleHTML += `
                    <div class="schedule-section">
                        <div class="section-header">Today's Game</div>
                        ${renderGameCard(todaysGames[0], true)}
                    </div>
                `;
            }
            
            // Next Games
            if (futureGames.length > 0) {
                scheduleHTML += `
                    <div class="schedule-section">
                        <div class="section-header">Upcoming Games</div>
                        ${futureGames.map(g => renderGameCard(g)).join('')}
                    </div>
                `;
            }
            
            document.getElementById('scheduleContent').innerHTML = scheduleHTML || '<div class="loading">No schedule data</div>';
        }

        function renderGameCard(game, isCurrent = false) {
            const gameDate = getGameStartDate(game) || new Date();
            const isUtahHome = game.homeTeam.abbrev === UTAH_TEAM_ABBREV;
            
            let statusBadge = '';
            if (game.gameState === 'LIVE') {
                statusBadge = '<span class="game-status-badge live"> LIVE</span>';
            } else if (game.gameState === 'FUT') {
                statusBadge = `<span class="game-status-badge">${gameDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;
            } else if (game.gameState === 'OFF') {
                statusBadge = '<span class="game-status-badge">Final</span>';
            }
            
            return `
                <div class="game-card ${isCurrent ? 'current' : ''}">
                    <div class="game-date">
                        ${gameDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                    </div>
                    <div class="game-teams">
                        <div class="game-team">
                            <img class="game-team-logo" src="${getTeamLogoUrl(game.awayTeam.abbrev)}" alt="${game.awayTeam.abbrev}">
                            <span class="game-team-name">${game.awayTeam.abbrev}</span>
                        </div>
                        <span style="color: #666; font-size: 20px;">@</span>
                        <div class="game-team">
                            <span class="game-team-name">${game.homeTeam.abbrev}</span>
                            <img class="game-team-logo" src="${getTeamLogoUrl(game.homeTeam.abbrev)}" alt="${game.homeTeam.abbrev}">
                        </div>
                    </div>
                    ${game.gameState === 'OFF' ? `
                        <div class="game-score">${game.awayTeam.score} - ${game.homeTeam.score}</div>
                    ` : ''}
                    ${statusBadge}
                </div>
            `;
        }

        function updateStandings() {
            if (!standingsData?.standings) return;

            if (!window.standingsView) window.standingsView = 'division';

            const all = [...standingsData.standings];

            // Build a fast lookup for wildcard qualifiers by conference.
            // Rule: top 3 per division qualify; next best 2 in conference are wildcards.
            const playoffStatusByAbbrev = {};
            for (const confName of [...new Set(all.map(t => t.conferenceName))]) {
                const confTeams = all.filter(t => t.conferenceName === confName);

                const divisionNames = [...new Set(confTeams.map(t => t.divisionName))];
                const top3ByDivision = [];
                for (const divName of divisionNames) {
                    const divTeams = confTeams
                        .filter(t => t.divisionName === divName)
                        .sort((a, b) => (a.divisionSequence || 999) - (b.divisionSequence || 999));
                    top3ByDivision.push(...divTeams.slice(0, 3));
                }

                const top3Set = new Set(top3ByDivision.map(t => t.teamAbbrev.default));
                const remaining = confTeams
                    .filter(t => !top3Set.has(t.teamAbbrev.default))
                    .sort((a, b) => (a.wildcardSequence || 999) - (b.wildcardSequence || 999));

                const wcTeams = remaining.slice(0, 2);
                const wcSet = new Set(wcTeams.map(t => t.teamAbbrev.default));

                for (const t of top3ByDivision) playoffStatusByAbbrev[t.teamAbbrev.default] = { type: 'division', conf: confName };
                for (const t of wcTeams) playoffStatusByAbbrev[t.teamAbbrev.default] = { type: 'wildcard', conf: confName };

                // Optional: mark in race as next few in wildcard list
                for (const t of remaining.slice(2, 6)) {
                    if (!playoffStatusByAbbrev[t.teamAbbrev.default]) {
                        playoffStatusByAbbrev[t.teamAbbrev.default] = { type: 'race', conf: confName };
                    }
                }
            }

            function standingsControlsHtml() {
                return `
                    <div class="standings-controls">
                        <button class="standings-toggle ${window.standingsView === 'division' ? 'active' : ''}" onclick="setStandingsView('division')">Division</button>
                        <button class="standings-toggle ${window.standingsView === 'conference' ? 'active' : ''}" onclick="setStandingsView('conference')">Conference</button>
                    </div>
                `;
            }

            function renderRows(teams, { rankKey, showLines = false } = {}) {
                return teams.map((team, idx) => {
                    const abbrev = team.teamAbbrev.default;
                    const status = playoffStatusByAbbrev[abbrev]?.type;
                    const isUtah = abbrev === UTAH_TEAM_ABBREV;

                    let playoffBadge = '';
                    let rowClass = '';
                    let lineClass = '';

                    if (status === 'division') {
                        playoffBadge = '<span class="playoff-badge clinched">PLAYOFF</span>';
                        rowClass = 'playoff-spot';
                    } else if (status === 'wildcard') {
                        playoffBadge = '<span class="playoff-badge wildcard">WILDCARD</span>';
                        rowClass = 'wildcard-spot';
                    } else if (status === 'race') {
                        playoffBadge = '<span class="playoff-badge in-race">IN RACE</span>';
                    }

                    if (isUtah) rowClass = `${rowClass} utah-row`.trim();

                    // Add visual cutoff lines.
                    if (showLines) {
                        // In wild card race tables, draw a cutoff line after WC2.
                        if (idx === 2) lineClass = 'wildcard-line';
                    } else {
                        // In division tables, draw a cutoff line after #3.
                        if (idx === 3) lineClass = 'playoff-line';
                    }

                    const rankVal = rankKey ? team[rankKey] : idx + 1;

                    return `
                        <tr class="${rowClass} ${lineClass}">
                            <td class="standings-rank">${rankVal}</td>
                            <td>
                                <div class="standings-team">
                                    <img class="standings-logo" src="${getTeamLogoUrl(abbrev)}" alt="${abbrev}">
                                    <span class="standings-team-name">${team.teamName.default}</span>
                                    ${playoffBadge}
                                </div>
                            </td>
                            <td class="team-stat-num">${team.gamesPlayed}</td>
                            <td class="team-stat-num">${team.wins}</td>
                            <td class="team-stat-num">${team.losses}</td>
                            <td class="team-stat-num">${team.otLosses}</td>
                            <td class="team-stat-num" style="color: var(--mammoth-accent); font-weight: 700;">${team.points}</td>
                            <td class="team-stat-num">${team.goalFor}</td>
                            <td class="team-stat-num">${team.goalAgainst}</td>
                        </tr>
                    `;
                }).join('');
            }

            function renderDivisionView() {
                // Conference headers with divisions underneath
                const conferences = {};
                for (const standing of all) {
                    const conf = standing.conferenceName;
                    if (!conferences[conf]) conferences[conf] = {};
                    const div = standing.divisionName;
                    if (!conferences[conf][div]) conferences[conf][div] = [];
                    conferences[conf][div].push(standing);
                }

                let html = standingsControlsHtml();

                for (const [confName, divisions] of Object.entries(conferences)) {
                    html += `<div class="standings-conference">`;
                    html += `<div class="conference-name">${confName} Conference</div>`;

                    for (const [divName, teams] of Object.entries(divisions)) {
                        const sorted = [...teams].sort((a, b) => (a.divisionSequence || 999) - (b.divisionSequence || 999));
                        html += `
                            <div class="division">
                                <div class="division-name">${divName} Division</div>
                                <table class="standings-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Team</th>
                                            <th style="text-align: center;">GP</th>
                                            <th style="text-align: center;">W</th>
                                            <th style="text-align: center;">L</th>
                                            <th style="text-align: center;">OT</th>
                                            <th style="text-align: center;">PTS</th>
                                            <th style="text-align: center;">GF</th>
                                            <th style="text-align: center;">GA</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${renderRows(sorted, { rankKey: 'divisionSequence' })}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    html += `</div>`;
                }

                return html;
            }

            function renderConferenceView() {
                let html = standingsControlsHtml();

                const conferences = [...new Set(all.map(t => t.conferenceName))];
                for (const confName of conferences) {
                    const confTeams = all.filter(t => t.conferenceName === confName);

                    const divisionNames = [...new Set(confTeams.map(t => t.divisionName))];
                    const top3ByDivision = {};

                    for (const divName of divisionNames) {
                        const divTeams = confTeams
                            .filter(t => t.divisionName === divName)
                            .sort((a, b) => (a.divisionSequence || 999) - (b.divisionSequence || 999));
                        top3ByDivision[divName] = divTeams.slice(0, 3);
                    }

                    const top3Set = new Set(Object.values(top3ByDivision).flat().map(t => t.teamAbbrev.default));
                    const wcRace = confTeams
                        .filter(t => !top3Set.has(t.teamAbbrev.default))
                        .sort((a, b) => (a.wildcardSequence || 999) - (b.wildcardSequence || 999));

                    html += `
                        <div class="standings-conference">
                            <div class="conference-name">${confName} Conference</div>
                    `;

                    // Division automatic qualifiers
                    html += `<div class="standings-section-header">Division Top 3</div>`;
                    for (const divName of divisionNames) {
                        const teams = top3ByDivision[divName] || [];
                        html += `
                            <div class="division">
                                <div class="division-name">${divName} Division</div>
                                <table class="standings-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Team</th>
                                            <th style="text-align: center;">GP</th>
                                            <th style="text-align: center;">W</th>
                                            <th style="text-align: center;">L</th>
                                            <th style="text-align: center;">OT</th>
                                            <th style="text-align: center;">PTS</th>
                                            <th style="text-align: center;">GF</th>
                                            <th style="text-align: center;">GA</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${renderRows(teams, { rankKey: 'divisionSequence', showLines: false })}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    // Wild card race
                    html += `
                        <div class="standings-section-header">Wild Card Race</div>
                        <table class="standings-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Team</th>
                                    <th style="text-align: center;">GP</th>
                                    <th style="text-align: center;">W</th>
                                    <th style="text-align: center;">L</th>
                                    <th style="text-align: center;">OT</th>
                                    <th style="text-align: center;">PTS</th>
                                    <th style="text-align: center;">GF</th>
                                    <th style="text-align: center;">GA</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderRows(wcRace, { rankKey: 'wildcardSequence', showLines: true })}
                            </tbody>
                        </table>
                    `;

                    html += `</div>`;
                }

                return html;
            }

            window.setStandingsView = function setStandingsView(view) {
                window.standingsView = view;
                updateStandings();
            };

            const standingsHTML = window.standingsView === 'conference' ? renderConferenceView() : renderDivisionView();
            document.getElementById('standingsContent').innerHTML = standingsHTML || '<div class="loading">No standings data</div>';
        }

        // Start (moved to initializeTeam callback to wait for team selection)
        // Note: fetchGameData() and polling now start after team initialization
        startRotatingPanelCycle(); // This can start immediately (doesn't need team data)

        // Update countdown every second (venue header + scoreboard pregame timer)
        setInterval(() => {
            if (scheduleData?.games) {
                updateVenueHeader();
            }
            // Update scoreboard countdown for pregame
            if (gameData) {
                const rawState = gameData.gameState || gameData.game?.gameState || '';
                if (rawState === 'FUT' || rawState === 'PRE') {
                    updateScoreboard();
                }
            }
        }, 1000);

        // ===== ROSTER FUNCTIONALITY =====
        let rosterData = null;
        let edgeStatsData = null;

        async function fetchRoster() {
            try {
                const response = await fetch(`/api/v1/roster/${UTAH_TEAM_ABBREV}/current`);
                rosterData = await response.json();
                debugLog('Roster data:', rosterData);
                updateRoster();
                // Fetch EDGE stats after roster loads
                fetchEdgeStats();
            } catch (error) {
                console.error('Error fetching roster:', error);
            }
        }

        async function fetchEdgeStats() {
            if (!rosterData) return;

            const allPlayers = [
                ...(rosterData.forwards || []),
                ...(rosterData.defensemen || [])
            ];

            // Fetch EDGE data for all skaters (not goalies)
            const edgePromises = allPlayers.map(async (player) => {
                try {
                    const response = await fetch(`/api/v1/edge/skater-detail/${player.id}/20252026/2`);
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            playerId: player.id,
                            name: `${player.firstName?.default || ''} ${player.lastName?.default || ''}`.trim(),
                            sweater: player.sweaterNumber,
                            topShotSpeed: data.topShotSpeed?.imperial || 0,
                            topShotSpeedPercentile: data.topShotSpeed?.percentile || 0,
                            maxSkateSpeed: data.skatingSpeed?.speedMax?.imperial || 0,
                            maxSkateSpeedPercentile: data.skatingSpeed?.speedMax?.percentile || 0
                        };
                    }
                } catch (e) {
                    // Ignore individual failures
                }
                return null;
            });

            const results = await Promise.all(edgePromises);
            const validResults = results.filter(r => r !== null);

            // Find top shot speed and top skate speed
            const topShotPlayer = validResults.reduce((best, current) =>
                (current.topShotSpeed > (best?.topShotSpeed || 0)) ? current : best, null);
            const topSkatePlayer = validResults.reduce((best, current) =>
                (current.maxSkateSpeed > (best?.maxSkateSpeed || 0)) ? current : best, null);

            edgeStatsData = {
                topShot: topShotPlayer,
                topSkate: topSkatePlayer,
                allPlayers: validResults
            };

            debugLog('EDGE stats:', edgeStatsData);
            updateRoster(); // Re-render with EDGE data
        }

        function updateRoster() {
            if (!rosterData) {
                document.getElementById('rosterContent').innerHTML = '<div class="loading"><div class="spinner"></div><div class="loading-text">Loading roster...</div></div>';
                return;
            }

            const forwards = rosterData.forwards || [];
            const defensemen = rosterData.defensemen || [];
            const goalies = rosterData.goalies || [];

            function renderSection(title, players) {
                if (players.length === 0) return '';

                const cards = players.map(p => {
                    const name = `${p.firstName?.default || ''} ${p.lastName?.default || ''}`.trim();
                    const num = p.sweaterNumber || '?';
                    const pos = p.positionCode || p.position || '';
                    const id = p.id || p.playerId;

                    return `
                        <div class="roster-card" onclick="showPlayerModal(${id})">
                            <img class="roster-headshot"
                                 src="${getPlayerHeadshot(id, UTAH_TEAM_ABBREV)}"
                                 alt="${name}"
                                 onerror="this.style.display='none'">
                            <div class="roster-number">#${num}</div>
                            <div class="roster-name">${name}</div>
                            <div class="roster-position">${pos}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="roster-section-title">${title}</div>
                    <div class="roster-grid">${cards}</div>
                `;
            }

            // Render EDGE stats section
            function renderEdgeStats() {
                if (!edgeStatsData) {
                    return `
                        <div class="edge-stats-section">
                            <div class="edge-stats-title"> NHL EDGE Season Leaders</div>
                            <div class="edge-stats-loading">Loading speed stats...</div>
                        </div>
                    `;
                }

                const { topShot, topSkate } = edgeStatsData;

                if (!topShot && !topSkate) {
                    return `
                        <div class="edge-stats-section">
                            <div class="edge-stats-title"> NHL EDGE Season Leaders</div>
                            <div class="edge-stats-loading">Speed data not available</div>
                        </div>
                    `;
                }

                const shotCard = topShot ? `
                    <div class="edge-stat-card" onclick="showPlayerModal(${topShot.playerId})">
                        <div class="edge-stat-label">Top Shot Speed</div>
                        <div class="edge-stat-value">${topShot.topShotSpeed.toFixed(1)}<span class="edge-stat-unit"> mph</span></div>
                        <div class="edge-stat-player">
                            <img class="edge-stat-headshot" src="${getPlayerHeadshot(topShot.playerId, UTAH_TEAM_ABBREV)}" alt="${topShot.name}" onerror="this.style.display='none'">
                            <div>
                                <div class="edge-stat-name">#${topShot.sweater} ${topShot.name}</div>
                                <div class="edge-stat-percentile">${Math.round(topShot.topShotSpeedPercentile * 100)}th percentile</div>
                            </div>
                        </div>
                    </div>
                ` : '';

                const skateCard = topSkate ? `
                    <div class="edge-stat-card" onclick="showPlayerModal(${topSkate.playerId})">
                        <div class="edge-stat-label">Top Skating Speed</div>
                        <div class="edge-stat-value">${topSkate.maxSkateSpeed.toFixed(1)}<span class="edge-stat-unit"> mph</span></div>
                        <div class="edge-stat-player">
                            <img class="edge-stat-headshot" src="${getPlayerHeadshot(topSkate.playerId, UTAH_TEAM_ABBREV)}" alt="${topSkate.name}" onerror="this.style.display='none'">
                            <div>
                                <div class="edge-stat-name">#${topSkate.sweater} ${topSkate.name}</div>
                                <div class="edge-stat-percentile">${Math.round(topSkate.maxSkateSpeedPercentile * 100)}th percentile</div>
                            </div>
                        </div>
                    </div>
                ` : '';

                return `
                    <div class="edge-stats-section">
                        <div class="edge-stats-title"> NHL EDGE Season Leaders</div>
                        <div class="edge-stats-grid">
                            ${shotCard}
                            ${skateCard}
                        </div>
                    </div>
                `;
            }

            const html = `
                ${renderEdgeStats()}
                ${renderSection('FORWARDS', forwards)}
                ${renderSection('DEFENSE', defensemen)}
                ${renderSection('GOALIES', goalies)}
            `;

            document.getElementById('rosterContent').innerHTML = html || '<div class="loading">No roster data available</div>';
        }

        async function showPlayerModal(playerId) {
            try {
                const response = await fetch(`/api/v1/player/${playerId}/landing`);
                const data = await response.json();
                debugLog('Player data:', data);

                const name = `${data.firstName?.default || ''} ${data.lastName?.default || ''}`.trim();
                const career = data.featuredStats?.regularSeason?.career || {};
                const season = data.featuredStats?.regularSeason?.subSeason || {};

                // Format height
                let heightStr = 'N/A';
                if (data.heightInInches) {
                    const ft = Math.floor(data.heightInInches / 12);
                    const inch = data.heightInInches % 12;
                    heightStr = `${ft}'${inch}"`;
                }

                // Draft info
                let draftStr = 'Undrafted';
                if (data.draftDetails?.year) {
                    draftStr = `${data.draftDetails.year} - Round ${data.draftDetails.round || '?'}, Pick ${data.draftDetails.pickInRound || '?'}`;
                    if (data.draftDetails.teamAbbrev) {
                        draftStr += ` (${data.draftDetails.teamAbbrev})`;
                    }
                }

                const modal = document.getElementById('playerModal');
                document.getElementById('modalContent').innerHTML = `
                    <div class="modal-player-header">
                        <img class="modal-player-photo"
                             src="${getPlayerHeadshot(playerId, UTAH_TEAM_ABBREV)}"
                             alt="${name}"
                             onerror="this.style.display='none'">
                        <div class="modal-player-info">
                            <h2>${name || 'Player'}</h2>
                            <div class="modal-player-details">
                                <strong>Position:</strong> ${data.position || 'N/A'} |
                                <strong>Shoots:</strong> ${data.shootsCatches || 'N/A'}<br>
                                <strong>Height:</strong> ${heightStr} |
                                <strong>Weight:</strong> ${data.weightInPounds ? data.weightInPounds + ' lbs' : 'N/A'}<br>
                                <strong>Born:</strong> ${data.birthDate || 'N/A'} in ${data.birthCity?.default || 'N/A'}, ${data.birthStateProvince?.default || ''} ${data.birthCountry || ''}<br>
                                <strong>Draft:</strong> ${draftStr}
                            </div>
                        </div>
                    </div>

                    <div class="section-header">CAREER STATS (Regular Season)</div>
                    <div class="modal-stat-grid">
                        <div class="modal-stat">
                            <div class="modal-stat-label">Games Played</div>
                            <div class="modal-stat-value">${career.gamesPlayed || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Goals</div>
                            <div class="modal-stat-value">${career.goals || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Assists</div>
                            <div class="modal-stat-value">${career.assists || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Points</div>
                            <div class="modal-stat-value">${career.points || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">+/-</div>
                            <div class="modal-stat-value">${career.plusMinus ?? 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">PIM</div>
                            <div class="modal-stat-value">${career.pim || 0}</div>
                        </div>
                    </div>

                    <div class="section-header">2025-26 SEASON</div>
                    <div class="modal-stat-grid">
                        <div class="modal-stat">
                            <div class="modal-stat-label">Games</div>
                            <div class="modal-stat-value">${season.gamesPlayed || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Goals</div>
                            <div class="modal-stat-value">${season.goals || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Assists</div>
                            <div class="modal-stat-value">${season.assists || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Points</div>
                            <div class="modal-stat-value">${season.points || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">+/-</div>
                            <div class="modal-stat-value">${season.plusMinus ?? 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">PIM</div>
                            <div class="modal-stat-value">${season.pim || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Shots</div>
                            <div class="modal-stat-value">${season.shots || 0}</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-label">Shooting %</div>
                            <div class="modal-stat-value">${season.shootingPctg ? (season.shootingPctg * 100).toFixed(1) + '%' : '0.0%'}</div>
                        </div>
                    </div>
                `;

                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading player:', error);
                alert('Could not load player information. Please try again.');
            }
        }

        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
        }

        // Close modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'playerModal') closePlayerModal();
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('playerModal').style.display === 'flex') {
                closePlayerModal();
            }
        });

        // ===== VIDEO MODAL FUNCTIONS =====

        function openVideoModal(url, title) {
            const modal = document.getElementById('videoModal');
            const wrap = document.getElementById('videoIframeWrap');
            const titleEl = document.getElementById('videoModalTitle');

            titleEl.textContent = title;
            wrap.innerHTML = `<iframe src="${url}" allowfullscreen allow="autoplay"></iframe>`;
            modal.style.display = 'flex';
        }

        function openVideoModalNoContent(title, message) {
            const modal = document.getElementById('videoModal');
            const wrap = document.getElementById('videoIframeWrap');
            const titleEl = document.getElementById('videoModalTitle');

            titleEl.textContent = title;
            wrap.innerHTML = `<div class="video-no-content">${message}</div>`;
            modal.style.display = 'flex';
        }

        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            const wrap = document.getElementById('videoIframeWrap');
            wrap.innerHTML = '';
            modal.style.display = 'none';
        }

        function showGoalVideoModal(goalIndex) {
            debugLog('showGoalVideoModal called with goalIndex:', goalIndex);
            debugLog('goalsData available:', !!goalsData, 'length:', goalsData?.length);

            if (!goalsData || goalsData.length === 0 || goalIndex >= goalsData.length) {
                debugLog('Modal not shown - goalsData missing or invalid');
                return;
            }

            const goal = goalsData[goalIndex];
            debugLog('Goal data:', goal);

            if (!goal.highlightClipUrl) {
                debugLog('No highlight URL available');
                return;
            }

            const modal = document.getElementById('goalVideoModal');
            const wrap = document.getElementById('goalVideoWrap');
            const titleEl = document.getElementById('goalVideoModalTitle');

            // Always show score as homeScore-awayScore (consistent format)
            const score = `${goal.homeScore}-${goal.awayScore}`;

            titleEl.textContent = `Goal ${goalIndex + 1} - P${goal.period} ${goal.time} (${score})`;

            // Extract video ID from the play data and use Brightcove player
            const videoId = goal.play?.details?.highlightClip;
            const embedUrl = `https://players.brightcove.net/6415718365001/D3UCGynRWU_default/index.html?videoId=${videoId}&autoplay=true`;
            debugLog('Embedding Brightcove video from URL:', embedUrl);

            wrap.innerHTML = `<iframe src="${embedUrl}" style="width:100%;height:100%;" frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>`;

            modal.style.display = 'flex';
        }

        function closeGoalVideoModal() {
            const modal = document.getElementById('goalVideoModal');
            const wrap = document.getElementById('goalVideoWrap');
            wrap.innerHTML = '';
            modal.style.display = 'none';
        }

        async function openHighlightsModal() {
            // Check if game data exists
            if (!gameData || !currentGameId) {
                const modal = document.getElementById('videoModal');
                const wrap = document.getElementById('videoIframeWrap');
                const titleEl = document.getElementById('videoModalTitle');

                titleEl.textContent = 'Highlights';
                wrap.innerHTML = '<div class="video-no-content">No game data available</div>';
                modal.style.display = 'flex';
                return;
            }

            // Check game state
            const gameState = gameData?.gameState || gameData?.game?.gameState || '';
            const isLiveOrUpcoming = gameState === 'LIVE' || gameState === 'CRIT' || gameState === 'FUT' || gameState === 'PRE';

            const modal = document.getElementById('videoModal');
            const wrap = document.getElementById('videoIframeWrap');
            const titleEl = document.getElementById('videoModalTitle');

            titleEl.textContent = 'Highlights';

            // Show message for live/upcoming games
            if (isLiveOrUpcoming) {
                wrap.innerHTML = `
                    <div class="video-no-content" style="padding: 40px 20px;">
                        <p style="margin-bottom: 20px; font-size: 16px;"> Game in progress or upcoming</p>
                        <p style="margin-bottom: 20px; color: #aaa; font-size: 14px;">Highlights will be available after the game ends</p>
                    </div>
                `;
                modal.style.display = 'flex';
                return;
            }

            modal.style.display = 'flex';

            try {
                // Fetch schedule to get highlights data for current game
                const gameDate = gameData?.gameDate || gameData?.startTimeUTC?.split('T')[0];
                if (!gameDate) throw new Error('Game date not available');

                debugLog('Fetching highlights from schedule for date:', gameDate);
                const scheduleRes = await fetch(`/api/v1/schedule/${gameDate}`);
                if (!scheduleRes.ok) throw new Error('Schedule not found');

                const scheduleData = await scheduleRes.json();
                let currentGame = null;

                // Find current game in schedule
                if (scheduleData.gameWeek && Array.isArray(scheduleData.gameWeek)) {
                    for (const dayGames of scheduleData.gameWeek) {
                        if (dayGames.games) {
                            currentGame = dayGames.games.find(g => g.id === currentGameId);
                            if (currentGame) break;
                        }
                    }
                }

                if (!currentGame) throw new Error('Game not found in schedule');

                const threeMinRecap = currentGame?.threeMinRecap;
                const condensedGame = currentGame?.condensedGame;

                debugLog('Current game highlights - threeMinRecap:', threeMinRecap, 'condensedGame:', condensedGame);

                if (threeMinRecap) {
                    // Extract video ID from path (e.g., "/video/..."  extract the ID number)
                    const videoIdMatch = threeMinRecap.match(/(\d+)$/);
                    if (videoIdMatch) {
                        const videoId = videoIdMatch[1];
                        const brightcoveUrl = `https://players.brightcove.net/6415718365001/D3UCGynRWU_default/index.html?videoId=${videoId}&autoplay=true`;
                        debugLog('Loading 3-min recap with Brightcove:', brightcoveUrl);
                        wrap.innerHTML = `
                            <iframe src="${brightcoveUrl}" allowfullscreen allow="autoplay" style="width:100%;height:100%;"></iframe>
                        `;
                    } else {
                        throw new Error('Could not extract video ID from recap path');
                    }
                } else if (condensedGame) {
                    // Extract video ID from condensed game path
                    const videoIdMatch = condensedGame.match(/(\d+)$/);
                    if (videoIdMatch) {
                        const videoId = videoIdMatch[1];
                        const brightcoveUrl = `https://players.brightcove.net/6415718365001/D3UCGynRWU_default/index.html?videoId=${videoId}&autoplay=true`;
                        debugLog('Loading condensed game with Brightcove:', brightcoveUrl);
                        wrap.innerHTML = `
                            <iframe src="${brightcoveUrl}" allowfullscreen allow="autoplay" style="width:100%;height:100%;"></iframe>
                        `;
                    } else {
                        throw new Error('Could not extract video ID from condensed game path');
                    }
                } else {
                    // No official video available yet
                    wrap.innerHTML = `
                        <div class="video-no-content" style="padding: 40px 20px;">
                            <p style="margin-bottom: 20px;">Official highlights not available yet.</p>
                            <p style="margin-bottom: 20px; color: #aaa; font-size: 14px;">Check back later for the 3-minute recap or full game condensed video</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading highlights:', error);
                wrap.innerHTML = `
                    <div class="video-no-content" style="padding: 40px 20px;">
                        <p style="margin-bottom: 20px;">Could not load highlights</p>
                        <p style="color: #aaa; font-size: 12px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Fetch and display highlights for a past game from official NHL API
        async function openPastGameHighlights(gameId) {
            const modal = document.getElementById('videoModal');
            const wrap = document.getElementById('videoIframeWrap');
            const titleEl = document.getElementById('videoModalTitle');

            titleEl.textContent = 'Highlights';
            modal.style.display = 'flex';

            if (!gameId) {
                wrap.innerHTML = `
                    <div class="video-no-content" style="padding: 40px 20px;">
                        <p>Unable to load highlights</p>
                    </div>
                `;
                return;
            }

            try {
                // Fetch game from landing endpoint to get the game date
                debugLog('Fetching past game date for game ID:', gameId);
                const landingRes = await fetch(`/api/v1/gamecenter/${gameId}/landing`);

                if (!landingRes.ok) {
                    throw new Error(`Game data not found: ${landingRes.status}`);
                }

                const gameData = await landingRes.json();
                const gameDate = gameData?.gameDate?.split('T')[0];

                if (!gameDate) throw new Error('Game date not available');

                // Now fetch from schedule to get highlights
                debugLog('Fetching highlights from schedule for date:', gameDate);
                const scheduleRes = await fetch(`/api/v1/schedule/${gameDate}`);

                if (!scheduleRes.ok) throw new Error('Schedule not found');

                const scheduleData = await scheduleRes.json();
                let pastGame = null;

                // Find the game in schedule
                if (scheduleData.gameWeek && Array.isArray(scheduleData.gameWeek)) {
                    for (const dayGames of scheduleData.gameWeek) {
                        if (dayGames.games) {
                            pastGame = dayGames.games.find(g => g.id === gameId);
                            if (pastGame) break;
                        }
                    }
                }

                if (!pastGame) throw new Error('Game not found in schedule');

                const threeMinRecap = pastGame?.threeMinRecap;
                const condensedGame = pastGame?.condensedGame;

                debugLog('Past game highlights - threeMinRecap:', threeMinRecap, 'condensedGame:', condensedGame);

                if (threeMinRecap) {
                    // Extract video ID from path and use Brightcove player
                    const videoIdMatch = threeMinRecap.match(/(\d+)$/);
                    if (videoIdMatch) {
                        const videoId = videoIdMatch[1];
                        const brightcoveUrl = `https://players.brightcove.net/6415718365001/D3UCGynRWU_default/index.html?videoId=${videoId}&autoplay=true`;
                        debugLog('Loading 3-min recap for past game with Brightcove:', brightcoveUrl);
                        wrap.innerHTML = `
                            <iframe src="${brightcoveUrl}" allowfullscreen allow="autoplay" style="width:100%;height:100%;"></iframe>
                        `;
                    } else {
                        throw new Error('Could not extract video ID from recap path');
                    }
                } else if (condensedGame) {
                    // Extract video ID from condensed game path and use Brightcove player
                    const videoIdMatch = condensedGame.match(/(\d+)$/);
                    if (videoIdMatch) {
                        const videoId = videoIdMatch[1];
                        const brightcoveUrl = `https://players.brightcove.net/6415718365001/D3UCGynRWU_default/index.html?videoId=${videoId}&autoplay=true`;
                        debugLog('Loading condensed game for past game with Brightcove:', brightcoveUrl);
                        wrap.innerHTML = `
                            <iframe src="${brightcoveUrl}" allowfullscreen allow="autoplay" style="width:100%;height:100%;"></iframe>
                        `;
                    } else {
                        throw new Error('Could not extract video ID from condensed game path');
                    }
                } else {
                    wrap.innerHTML = `
                        <div class="video-no-content" style="padding: 40px 20px;">
                            <p>Highlights not available for this game</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading past game highlights:', error);
                wrap.innerHTML = `
                    <div class="video-no-content" style="padding: 40px 20px;">
                        <p style="margin-bottom: 20px;">Could not load highlights</p>
                        <p style="color: #aaa; font-size: 12px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Close video modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'videoModal') closeVideoModal();
        });

        // Close video modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('videoModal').style.display === 'flex') {
                closeVideoModal();
            }
        });

        // ===== PLAYOFF BRACKET FUNCTIONALITY =====
        let playoffBracketData = null;
        let playoffsActive = false;

        // Get current season in YYYYYYYY format (e.g., 20252026)
        function getCurrentSeason() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth(); // 0-indexed
            // NHL season starts in October, so if we're before October, use previous year
            const startYear = month < 9 ? year - 1 : year;
            return `${startYear}${startYear + 1}`;
        }

        // Get playoff year (e.g., 2025 for 2024-2025 season)
        function getPlayoffYear() {
            const season = getCurrentSeason();
            return parseInt(season.substring(4));
        }

        async function fetchPlayoffBracket() {
            try {
                const year = getPlayoffYear();
                debugLog('Fetching playoff bracket for year:', year);

                const response = await fetch(`/api/v1/playoff-bracket/${year}`);
                if (!response.ok) {
                    debugLog('Playoff bracket not available (likely regular season)');
                    playoffsActive = false;
                    return null;
                }

                const data = await response.json();
                debugLog('Playoff bracket data:', data);

                // Check if playoffs are active by looking for ACTUAL series data (not empty arrays)
                const hasSeries = data?.series?.length > 0;
                const hasRounds = data?.rounds?.length > 0;
                const hasEastern = data?.bracketByConf?.Eastern?.length > 0 || data?.bracketByConf?.E?.length > 0;
                const hasWestern = data?.bracketByConf?.Western?.length > 0 || data?.bracketByConf?.W?.length > 0;

                if (hasSeries || hasRounds || hasEastern || hasWestern) {
                    playoffsActive = true;
                    playoffBracketData = data;
                    debugLog('Playoffs ARE active, using live bracket');
                    return data;
                }

                debugLog('Playoff data empty, using projected bracket');
                playoffsActive = false;
                return null;
            } catch (error) {
                debugLog('Error fetching playoff bracket:', error);
                playoffsActive = false;
                return null;
            }
        }

        async function updatePlayoffBracket() {
            document.getElementById('bracketContent').innerHTML = '<div class="loading"><div class="spinner"></div><div class="loading-text">Loading bracket...</div></div>';

            // Try to fetch actual playoff data
            await fetchPlayoffBracket();

            // For now, always use projected bracket during regular season
            // The NHL API returns empty structures even when playoffs aren't active
            if (playoffsActive && playoffBracketData && standingsData?.standings) {
                // Double-check: only use live bracket if we actually have series with teams
                const hasRealData = playoffBracketData.series?.some(s => s.topSeedTeam || s.team1) ||
                                    playoffBracketData.rounds?.some(r => r.series?.length > 0) ||
                                    Object.values(playoffBracketData.bracketByConf || {}).some(conf => conf?.some(s => s.topSeedTeam || s.team1));

                if (hasRealData) {
                    renderActualPlayoffBracket();
                    return;
                }
            }

            // Default to projected bracket
            renderProjectedBracket();
        }

        function renderActualPlayoffBracket() {
            const data = playoffBracketData;
            debugLog('Rendering actual playoff bracket:', data);

            // Helper to render a team in the actual playoff bracket
            function renderPlayoffTeam(team, wins, isWinner = false) {
                if (!team) {
                    return `
                        <div class="matchup-team tbd-team">
                            <div class="matchup-info"><div class="matchup-team-name">TBD</div></div>
                        </div>
                    `;
                }

                const abbrev = normalizeTeamAbbrev(team.abbrev || team.teamAbbrev || '');
                const isUtah = abbrev === UTAH_TEAM_ABBREV;
                const teamName = team.name?.default || team.teamName?.default || abbrev;
                const seed = team.seed || '';

                return `
                    <div class="matchup-team ${isUtah ? 'utah' : ''} ${isWinner ? 'series-winner' : ''}">
                        <span class="matchup-seed">${seed}</span>
                        <img class="matchup-logo" src="${getTeamLogoUrl(abbrev)}" alt="${abbrev}">
                        <div class="matchup-info">
                            <div class="matchup-team-name">${teamName}</div>
                        </div>
                        <div class="series-wins">${wins !== undefined ? wins : ''}</div>
                    </div>
                `;
            }

            // Helper to render a playoff series matchup
            function renderPlayoffMatchup(series) {
                if (!series) {
                    return `
                        <div class="matchup tbd">
                            <div class="matchup-team tbd-team">
                                <div class="matchup-info"><div class="matchup-team-name">TBD</div></div>
                            </div>
                            <div class="matchup-team tbd-team">
                                <div class="matchup-info"><div class="matchup-team-name">TBD</div></div>
                        </div>
                    `;
                }

                const topTeam = series.topSeedTeam || series.team1;
                const bottomTeam = series.bottomSeedTeam || series.team2;
                const topWins = series.topSeedWins ?? series.team1Wins ?? 0;
                const bottomWins = series.bottomSeedWins ?? series.team2Wins ?? 0;
                const isComplete = topWins === 4 || bottomWins === 4;
                const topIsWinner = isComplete && topWins === 4;
                const bottomIsWinner = isComplete && bottomWins === 4;

                return `
                    <div class="matchup ${isComplete ? 'series-complete' : 'series-active'}">
                        ${renderPlayoffTeam(topTeam, topWins, topIsWinner)}
                        ${renderPlayoffTeam(bottomTeam, bottomWins, bottomIsWinner)}
                    </div>
                `;
            }

            // Parse the bracket data structure
            // The NHL API returns data organized by conference and round
            let westR1 = [], westR2 = [], westCF = [];
            let eastR1 = [], eastR2 = [], eastCF = [];
            let stanleyCupFinal = null;

            // Try different data structures the API might return
            if (data.bracketByConf) {
                // Structure: { bracketByConf: { Eastern: [...], Western: [...] } }
                const eastern = data.bracketByConf.Eastern || data.bracketByConf.E || [];
                const western = data.bracketByConf.Western || data.bracketByConf.W || [];

                eastern.forEach(series => {
                    const round = series.playoffRound || series.round || 1;
                    if (round === 1) eastR1.push(series);
                    else if (round === 2) eastR2.push(series);
                    else if (round === 3) eastCF.push(series);
                });

                western.forEach(series => {
                    const round = series.playoffRound || series.round || 1;
                    if (round === 1) westR1.push(series);
                    else if (round === 2) westR2.push(series);
                    else if (round === 3) westCF.push(series);
                });

                if (data.bracketByConf.SCF || data.stanleyCupFinal) {
                    stanleyCupFinal = data.bracketByConf.SCF?.[0] || data.stanleyCupFinal;
                }
            } else if (data.rounds) {
                // Structure: { rounds: [ { round: 1, series: [...] }, ... ] }
                data.rounds.forEach(round => {
                    const roundNum = round.round || round.roundNumber;
                    round.series?.forEach(series => {
                        const conf = series.conference || series.conferenceName;
                        if (roundNum === 1) {
                            if (conf === 'Western' || conf === 'W') westR1.push(series);
                            else if (conf === 'Eastern' || conf === 'E') eastR1.push(series);
                        } else if (roundNum === 2) {
                            if (conf === 'Western' || conf === 'W') westR2.push(series);
                            else if (conf === 'Eastern' || conf === 'E') eastR2.push(series);
                        } else if (roundNum === 3) {
                            if (conf === 'Western' || conf === 'W') westCF.push(series);
                            else if (conf === 'Eastern' || conf === 'E') eastCF.push(series);
                        } else if (roundNum === 4) {
                            stanleyCupFinal = series;
                        }
                    });
                });
            } else if (data.series) {
                // Structure: { series: [...] } - flat array
                // NHL API doesn't include conference, so we determine it from team abbreviations
                const westernTeams = ['ANA', 'UTA', 'CGY', 'CHI', 'COL', 'DAL', 'EDM', 'LAK', 'MIN', 'NSH', 'SEA', 'SJS', 'STL', 'VAN', 'VGK', 'WPG'];
                const easternTeams = ['BOS', 'BUF', 'CAR', 'CBJ', 'DET', 'FLA', 'MTL', 'NJD', 'NYI', 'NYR', 'OTT', 'PHI', 'PIT', 'TBL', 'TOR', 'WSH'];

                function getConference(series) {
                    const topAbbrev = series.topSeedTeam?.abbrev;
                    const bottomAbbrev = series.bottomSeedTeam?.abbrev;
                    if (westernTeams.includes(topAbbrev) || westernTeams.includes(bottomAbbrev)) return 'West';
                    if (easternTeams.includes(topAbbrev) || easternTeams.includes(bottomAbbrev)) return 'East';
                    return '';
                }

                data.series.forEach((series, idx) => {
                    const round = series.playoffRound || series.round || 1;
                    const conf = getConference(series);

                    // Check for Stanley Cup Final (round 4 or mixed conferences)
                    if (round === 4 || series.seriesTitle?.includes('Stanley Cup') || series.seriesLetter === 'O') {
                        stanleyCupFinal = series;
                    } else if (conf === 'West') {
                        if (round === 1) westR1.push(series);
                        else if (round === 2) westR2.push(series);
                        else if (round === 3) westCF.push(series);
                    } else if (conf === 'East') {
                        if (round === 1) eastR1.push(series);
                        else if (round === 2) eastR2.push(series);
                        else if (round === 3) eastCF.push(series);
                    }
                });
            }

            // Pad arrays to expected lengths
            while (westR1.length < 4) westR1.push(null);
            while (westR2.length < 2) westR2.push(null);
            while (westCF.length < 1) westCF.push(null);
            while (eastR1.length < 4) eastR1.push(null);
            while (eastR2.length < 2) eastR2.push(null);
            while (eastCF.length < 1) eastCF.push(null);

            const html = `
                <div class="bracket-header"> Stanley Cup Playoffs</div>
                <div class="bracket-subtitle">Live Playoff Bracket</div>
                <div class="bracket-container">
                    <table class="bracket-table">
                        <tr>
                            <td class="conf-label west-label">WEST</td>
                            <td><div class="bracket-round">${westR1.map(s => renderPlayoffMatchup(s)).join('')}</div></td>
                            <td class="connector-cell"></td>
                            <td><div class="bracket-round">${westR2.map(s => renderPlayoffMatchup(s)).join('')}</div></td>
                            <td class="connector-cell"></td>
                            <td><div class="bracket-round">${renderPlayoffMatchup(westCF[0])}</div></td>
                            <td class="stanley-cup-cell">
                                <div class="stanley-cup-trophy"></div>
                                <div class="stanley-cup-label">STANLEY CUP</div>
                                ${stanleyCupFinal ? `
                                    <div class="matchup final-matchup ${stanleyCupFinal.topSeedWins === 4 || stanleyCupFinal.bottomSeedWins === 4 ? 'series-complete' : 'series-active'}">
                                        ${renderPlayoffTeam(stanleyCupFinal.topSeedTeam || stanleyCupFinal.team1, stanleyCupFinal.topSeedWins ?? stanleyCupFinal.team1Wins, (stanleyCupFinal.topSeedWins ?? 0) === 4)}
                                        <div class="vs-divider">VS</div>
                                        ${renderPlayoffTeam(stanleyCupFinal.bottomSeedTeam || stanleyCupFinal.team2, stanleyCupFinal.bottomSeedWins ?? stanleyCupFinal.team2Wins, (stanleyCupFinal.bottomSeedWins ?? 0) === 4)}
                                    </div>
                                ` : `
                                    <div class="matchup final-matchup tbd">
                                        <div class="matchup-team tbd-team"><div class="matchup-info"><div class="matchup-team-name">West</div></div></div>
                                        <div class="vs-divider">VS</div>
                                        <div class="matchup-team tbd-team"><div class="matchup-info"><div class="matchup-team-name">East</div></div></div>
                                    </div>
                                `}
                            </td>
                            <td><div class="bracket-round">${renderPlayoffMatchup(eastCF[0])}</div></td>
                            <td class="connector-cell"></td>
                            <td><div class="bracket-round">${eastR2.map(s => renderPlayoffMatchup(s)).join('')}</div></td>
                            <td class="connector-cell"></td>
                            <td><div class="bracket-round">${eastR1.map(s => renderPlayoffMatchup(s)).join('')}</div></td>
                            <td class="conf-label">EAST</td>
                        </tr>
                    </table>
                </div>
            `;

            document.getElementById('bracketContent').innerHTML = html;
        }

        function renderProjectedBracket() {
            if (!standingsData?.standings) {
                document.getElementById('bracketContent').innerHTML = '<div class="loading"><div class="spinner"></div><div class="loading-text">Loading standings...</div></div>';
                return;
            }

            const conf = { Eastern: [], Western: [] };
            for (const t of standingsData.standings) {
                if (conf[t.conferenceName]) {
                    conf[t.conferenceName].push(t);
                }
            }

            conf.Eastern.sort((a, b) => b.points - a.points);
            conf.Western.sort((a, b) => b.points - a.points);

            const east = conf.Eastern.slice(0, 8);
            const west = conf.Western.slice(0, 8);

            function renderTeam(team, seed) {
                if (!team) {
                    return `
                        <div class="matchup-team tbd-team">
                            <span class="matchup-seed">?</span>
                            <div class="matchup-info">
                                <div class="matchup-team-name">TBD</div>
                            </div>
                        </div>
                    `;
                }
                const abbrev = normalizeTeamAbbrev(team.teamAbbrev);
                const isUtah = abbrev === UTAH_TEAM_ABBREV;
                return `
                    <div class="matchup-team ${isUtah ? 'utah' : ''}">
                        <span class="matchup-seed">${seed || ''}</span>
                        <img class="matchup-logo" src="${getTeamLogoUrl(abbrev)}" alt="${abbrev}">
                        <div class="matchup-info">
                            <div class="matchup-team-name">${team.teamName?.default || abbrev}</div>
                            <div class="matchup-record">${team.wins}-${team.losses}-${team.otLosses}</div>
                        </div>
                    </div>
                `;
            }

            function renderMatchup(t1, t2, seed1, seed2) {
                return `
                    <div class="matchup">
                        ${renderTeam(t1, seed1)}
                        ${renderTeam(t2, seed2)}
                    </div>
                `;
            }

            function renderTbdMatchup() {
                return `
                    <div class="matchup tbd">
                        <div class="matchup-team tbd-team">
                            <div class="matchup-info"><div class="matchup-team-name">TBD</div></div>
                        </div>
                        <div class="matchup-team tbd-team">
                            <div class="matchup-info"><div class="matchup-team-name">TBD</div></div>
                        </div>
                    </div>
                `;
            }

            const html = `
                <div class="bracket-header"> Stanley Cup Playoffs</div>
                <div class="bracket-subtitle">If the playoffs started today</div>
                <div class="bracket-container">
                    <table class="bracket-table">
                        <tr>
                            <td class="conf-label west-label">WEST</td>
                            <td><div class="bracket-round">${renderMatchup(west[0], west[7], 1, 8)}${renderMatchup(west[3], west[4], 4, 5)}${renderMatchup(west[1], west[6], 2, 7)}${renderMatchup(west[2], west[5], 3, 6)}</div></td>
                            <td class="connector-cell"></td>
                            <td><div class="bracket-round">${renderTbdMatchup()}${renderTbdMatchup()}</div></td>
                            <td class="connector-cell"></td>
                            <td><div class="bracket-round">${renderTbdMatchup()}</div></td>
                            <td class="stanley-cup-cell">
                                <div class="stanley-cup-trophy"></div>
                                <div class="stanley-cup-label">STANLEY CUP</div>
                                <div class="matchup final-matchup tbd">
                                    <div class="matchup-team tbd-team"><div class="matchup-info"><div class="matchup-team-name">West</div></div></div>
                                    <div class="vs-divider">VS</div>
                                    <div class="matchup-team tbd-team"><div class="matchup-info"><div class="matchup-team-name">East</div></div></div>
                                </div>
                            </td>
                            <td><div class="bracket-round">${renderTbdMatchup()}</div></td>
                            <td class="connector-cell"></td>
                            <td><div class="bracket-round">${renderTbdMatchup()}${renderTbdMatchup()}</div></td>
                            <td class="connector-cell"></td>
                            <td><div class="bracket-round">${renderMatchup(east[0], east[7], 1, 8)}${renderMatchup(east[3], east[4], 4, 5)}${renderMatchup(east[1], east[6], 2, 7)}${renderMatchup(east[2], east[5], 3, 6)}</div></td>
                            <td class="conf-label">EAST</td>
                        </tr>
                    </table>
                </div>
            `;

            document.getElementById('bracketContent').innerHTML = html;
        }

        // ===== INITIALIZE NEW FEATURES =====
        // Note: fetchRoster() is now called after team initialization (in initializeTeam callback)

        // Update bracket when standings are loaded, and also fetch playoff data
        const originalUpdateStandings = updateStandings;
        updateStandings = function() {
            originalUpdateStandings();
            updatePlayoffBracket();
        };
    </script>
</body>
</html>